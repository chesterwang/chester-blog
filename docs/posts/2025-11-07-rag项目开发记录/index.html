<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½• | Chester&#39;s Blog</title>
<meta name="keywords" content="LLM, RAG">
<meta name="description" content="ä¸ªäººRAGé¡¹ç›®çš„å¼€å‘è®°å½•å’Œç¬”è®°">
<meta name="author" content="ä½œè€…:Chester">
<link rel="canonical" href="https://chesterwang.github.io/chester-blog/posts/2025-11-07-rag%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">
<link crossorigin="anonymous" href="/chester-blog/assets/css/stylesheet.3d787722632b03b0bffe0d67e8f4333c75f6538432f31f18a83dfd05a3aeae4b.css" integrity="sha256-PXh3ImMrA7C//g1n6PQzPHX2U4Qy8x8YqD39BaOurks=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/chester-blog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://image.lvbibir.cn/blog/avatar.webp">
<link rel="icon" type="image/png" sizes="16x16" href="https://image.lvbibir.cn/blog/avatar.webp">
<link rel="icon" type="image/png" sizes="32x32" href="https://image.lvbibir.cn/blog/avatar.webp">
<link rel="apple-touch-icon" href="https://image.lvbibir.cn/blog/avatar.webp">
<link rel="mask-icon" href="https://image.lvbibir.cn/blog/avatar.webp">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://chesterwang.github.io/chester-blog/posts/2025-11-07-rag%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>




 
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.css" integrity="sha384-WcoG4HRXMzYzfCgiyfrySxx90XSl2rxY5mnVY5TwtWE6KLrArNKn0T/mOgNL0Mmi" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/katex.min.js" integrity="sha384-J+9dG2KMoiR9hqcFao0IBLwxt6zpcyN68IgwzsCSkbreXUjmNVRhPFTssqdSGjwQ" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.25/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>
<meta property="og:title" content="ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•" />
<meta property="og:description" content="ä¸ªäººRAGé¡¹ç›®çš„å¼€å‘è®°å½•å’Œç¬”è®°" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://chesterwang.github.io/chester-blog/posts/2025-11-07-rag%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-11-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-11-11T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•"/>
<meta name="twitter:description" content="ä¸ªäººRAGé¡¹ç›®çš„å¼€å‘è®°å½•å’Œç¬”è®°"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“š æ–‡ç« ",
      "item": "https://chesterwang.github.io/chester-blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•",
      "item": "https://chesterwang.github.io/chester-blog/posts/2025-11-07-rag%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•",
  "name": "ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•",
  "description": "ä¸ªäººRAGé¡¹ç›®çš„å¼€å‘è®°å½•å’Œç¬”è®°",
  "keywords": [
    "LLM", "RAG"
  ],
  "articleBody": "é¡¹ç›®ç¯å¢ƒæ­å»º å¦‚ä½•å°†requirements.txtä¸­çš„ä¾èµ–è½¬ç§»åˆ° uvç¯å¢ƒä¸­ uv add -r requirements.txt å¦‚æœå¤ªæ…¢åˆ™åŠ  url uv add -r requirements.txt --index-url https://pypi.tuna.tsinghua.edu.cn/simple ollamaæ­å»º æŠ¥é”™ ollamaä¿®æ”¹æ¨¡å‹ä¸‹è½½ç›®å½•ä¹‹åæŠ¥é”™ error: pull model manifest: 503: no healthy upstream é‡å¯æœåŠ¡å³å¯ sudo systemctl stop ollama sudo systemctl start ollama ä¿®æ”¹æ¨¡å‹ç›®å½• sudo ln -s /home/chester/ollama/models /usr/share/ollama/.ollama/ sudo chown ollama /usr/share/ollama/.ollama/models sudo chgrp ollama /usr/share/ollama/.ollama/models åä¸¤æ¡æ˜¯ä¿è¯ç›®å½•çš„æƒé™é—®é¢˜ï¼Œä¸ç„¶ollmaè¿è¡Œä¼šæŠ¥é”™ èµ„æ–™æ¥æº Does anyone know how to change where your models are saved on linux? : r/ollama Ollama(model=â€œqwen3:0.6bâ€) è¿™æ®µä»£ç å‰ææ˜¯ ç³»ç»Ÿä¸­ åå°å¯åŠ¨äº†ollamaæœåŠ¡ï¼ˆlinuxå®‰è£…ä¹‹åä¼šè‡ªåŠ¨åŠ å…¥ç³»ç»ŸæœåŠ¡ï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨è¯¥æœåŠ¡ï¼‰ï¼Œä½†å¹¶ä¸éœ€è¦ å‘½ä»¤è¡Œæ‰§è¡Œ ollama run modelã€‚åº”è¯¥æ˜¯åå°ä¼šè‡ªåŠ¨åŠèµ·å¯¹åº”çš„æ¨¡å‹è¿›è¡Œè®¡ç®—å¹¶ä¼ å›pythonã€‚ æœ¬åœ°è¿è¡ŒollamaçœŸçš„å¤ªæ…¢äº†ã€‚ embeddingæ¨ç†æœåŠ¡æ–¹æ³• HuggingFaceBgeEmbeddings åœ¨pycharmä¸­è¿è¡Œçš„æ—¶å€™ï¼Œè¦ç»™jupyter server æ·»åŠ å‚æ•°ï¼Œé…ä¸Šhttp_proxyçš„ä»£ç†ã€‚åœ¨pycharmè½¯ä»¶å±‚é¢è®¾ç½®http_proxyæ˜¯æ²¡ç”¨çš„ã€‚ huggingfaceä¼šä¸‹è½½æ¨¡å‹å»ºç«‹æœ¬åœ°æœåŠ¡è¿›è¡Œè®¡ç®—ã€‚ HuggingFaceInferenceAPIEmbeddings æ˜¯é€šè¿‡apiè¿›è¡Œembeddingè®¡ç®—ï¼Œè€Œä¸æ˜¯æœ¬åœ°è¿›è¡Œè®¡ç®—ã€‚ é—®é¢˜ï¼šhttpcore ä¸€ç›´æŠ¥é”™æ²¡æœ‰å®‰è£… æœ€åå‘ç°æ˜¯httpcoreæ²¡æœ‰å®‰è£…å¥½ï¼Œå¯¹åº”çš„pythonåŒ…åªæœ‰å…ƒæ•°æ®æ²¡æœ‰çœŸå®ä»£ç ï¼Œå°†å¯¹åº”ç›®å½•åˆ é™¤åé‡åˆ·uvç¯å¢ƒå³å¯ã€‚ P01 RAG-Projects ä»¥ä¸‹ä¸ºå°çš„RAGå­é¡¹ç›®\nProject 01 chatbot é—®é¢˜ï¼šload_dotenvçš„æœºåˆ¶\nload_dotenv å®šä¹‰å¦‚ä¸‹ é»˜è®¤åŠ è½½ .envæ–‡ä»¶ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸å­˜åœ¨ï¼Œå°±ä¸æ–­æå‡ç›®å½•å±‚æ¬¡æ¥æŸ¥æ‰¾ã€‚ interpolate ç”¨äºæ˜¯å¦è§£æå­—ç¬¦ä¸²ä¸­çš„å˜é‡ï¼Œæ¯”å¦‚ PATH=${PATH}:/usr/share/bin ï¼Œå°±ä¼šæŠŠPATHå˜é‡è¿›è¡Œè§£ææ›¿æ¢ã€‚ å…¶ä¸­ dotenv.main.resolve_variables å¯¹äºinterpolate åŠŸèƒ½çš„å®ç°å¾ˆæœ‰æ„æ€ï¼Œä½¿ç”¨äº†æ­£åˆ™æ–¹æ³•æ¥åŒ¹é…å¹¶åˆ†åˆ«è¿›è¡Œæ›¿æ¢ã€‚ def load_dotenv( dotenv_path: Optional[StrPath] = None, stream: Optional[IO[str]] = None, verbose: bool = False, override: bool = False, interpolate: bool = True, encoding: Optional[str] = \"utf-8\", ) -\u003e bool: \"\"\"Parse a .env file and then load all the variables found as environment variables. Parameters: dotenv_path: Absolute or relative path to .env file. stream: Text stream (such as `io.StringIO`) with .env content, used if `dotenv_path` is `None`. verbose: Whether to output a warning the .env file is missing. override: Whether to override the system environment variables with the variables from the `.env` file. encoding: Encoding to be used to read the file. Returns: Bool: True if at least one environment variable is set else False If both `dotenv_path` and `stream` are `None`, `find_dotenv()` is used to find the .env file with it's default parameters. If you need to change the default parameters of `find_dotenv()`, you can explicitly call `find_dotenv()` and pass the result to this function as `dotenv_path`. If the environment variable `PYTHON_DOTENV_DISABLED` is set to a truthy value, .env loading is disabled. \"\"\" Project 02 APIs ChatMessagePromptTemplate å’Œ ChatPromptTemplate æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼Œä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š ChatMessagePromptTemplate ç”¨äºè¡¨ç¤ºå•ä¸ªèŠå¤©æ¶ˆæ¯çš„æ¨¡æ¿ å¯¹åº”å•æ¡æ¶ˆæ¯ï¼ŒåŒ…å«æ¶ˆæ¯çš„è§’è‰²ï¼ˆå¦‚ç³»ç»Ÿã€ç”¨æˆ·ã€åŠ©æ‰‹ï¼‰å’Œå†…å®¹æ¨¡æ¿ æ˜¯æ„æˆèŠå¤©æ¨¡æ¿çš„åŸºæœ¬å•å…ƒ ChatPromptTemplate ç”¨äºè¡¨ç¤ºæ•´ä¸ªèŠå¤©å¯¹è¯çš„æ¨¡æ¿ å¯ä»¥åŒ…å«å¤šä¸ª ChatMessagePromptTemplate å®ä¾‹ ç”¨äºæ„å»ºå®Œæ•´çš„å¯¹è¯å†å²æ¨¡æ¿ï¼Œæ”¯æŒå¤šè½®å¯¹è¯åœºæ™¯ ç®€è€Œè¨€ä¹‹ï¼ŒChatMessagePromptTemplate æ˜¯å•æ¡æ¶ˆæ¯æ¨¡æ¿ï¼Œè€Œ ChatPromptTemplate æ˜¯æ•´ä¸ªå¯¹è¯æ¨¡æ¿ï¼Œåè€…å¯ä»¥åŒ…å«å¤šä¸ªå‰è€…æ¥æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚ ChatPromptTemplate from_messages ä»è‹¥å¹²messageä¸­æ„é€ æ¨¡æ¿ from_template ä»å•ä¸ª message çš„ template æ¥æ„é€  HumanMessageï¼Œå¹¶ç»„è£…ä¸ºä¸€ä¸ªChatã€‚ FewShotChatMessagePromptTemplate langchain_core.promptsä¸­çš„å„ç§promptã€‚ ChatOpenAIçš„ä½¿ç”¨æ–¹æ³• langchain_openai.chat_models.base.ChatOpenAI â€” ğŸ¦œğŸ”— LangChain 0.2.17 StrOutputParser å¦‚ä½•è§£æchainä¹‹å‰éƒ¨åˆ†çš„å†…å®¹ langchain_core.outputs.chat_generation.ChatGeneration.set_text ä¸­æŒ‡æ˜äº†ä»messageä¸­çš„contentå±æ€§æ¥è·å–å†…å®¹ã€‚ Project 04 Retriever and Chain create_stuff_documents_chain RunnablePassthrough å³ identity functionï¼Œæ’ç­‰å‡½æ•°ï¼Œè¾“å…¥ä»€ä¹ˆå°±è¾“å‡ºä»€ä¹ˆã€‚ RunnablePassthrough.assign ï¼š Merge the Dict input with the output produced by the mapping argument. chainçš„è°ƒç”¨è¿‡ç¨‹ è¾“å…¥ï¼šè¾“å…¥æ•°æ®ä¸ºdictï¼Œæœ‰inputè¿™ä¸ªkeyã€‚ retrieval_docs ï¼šå…ˆå¯¹ æ•°æ®è¿›è¡Œæ£€ç´¢ï¼Œå³ä»xä¸­è·å– inputè¿™ä¸€é¡¹ï¼Œç„¶åé€å…¥æ£€ç´¢å™¨ã€‚æ£€ç´¢å™¨æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† __ror__æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº† VectorStoreRetrieverçš„ _get_relevant_documents æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº† self.vectorstore.similarity_searchæ–¹æ³•ã€‚æ£€ç´¢å®Œä¹‹åï¼Œå°†ç›¸ä¼¼æ–‡æ¡£ç»„è£…ä¸ºä¸€ä¸ªitemæ”¾å…¥åˆ° contextè¿™ä¸ªkeyä¸‹ã€‚ æ•°æ®å˜ä¸º {input:XXX, context:[docs]}ã€‚ format_docs ï¼šæ£€ç´¢å‡ºç›¸ä¼¼æ–‡æ¡£ä¹‹åï¼Œé€å…¥format_inputsè¿‡ç¨‹ï¼Œå³å°†æ•°æ®ä¸­çš„contexté¡¹æ ¼å¼ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç”¨ åŒæ¢è¡Œç¬¦è¿›è¡Œåˆ†éš”è¿æ¥ã€‚æ•°æ®å˜ä¸º {input:XXX, context:doc_str} promptï¼š é€å…¥promptï¼Œpromptçš„invokeæ–¹æ³•ä¸­æœ¬è´¨å°±æ˜¯å¯¹ templateå­—ç¬¦ä¸²å’Œ ä¸Šä¸€æ­¥è®¡ç®—å‡ºçš„æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ã€‚ llmï¼šæ¨¡å‹ç»™å‡ºå“åº” _output_parser æœ¬è´¨å°±æ˜¯å¯¹ è¾“å‡ºçš„responseæ¶ˆæ¯è¿›è¡Œæ ¼å¼åŒ–ï¼Œæœ¬è´¨å°±æ˜¯æå–æ¶ˆæ¯ä¸­çš„keyä¸º\"text\"å¯¹åº”çš„å±æ€§ã€‚ ç›¸å…³å…³é”®ä»£ç å¦‚ä¸‹\nresponse=retriever.invoke(input=\"\"\"image processing with an introduction to techniques for image pattern classification\"\"\") #langchain_classic/chains/retrieval.py:64 if not isinstance(retriever, BaseRetriever): retrieval_docs: Runnable[dict, RetrieverOutput] = retriever else: retrieval_docs = (lambda x: x[\"input\"]) | retriever return ( RunnablePassthrough.assign( context=retrieval_docs.with_config(run_name=\"retrieve_documents\"), ).assign(answer=combine_docs_chain) ).with_config(run_name=\"retrieval_chain\") def format_docs(inputs: dict) -\u003e str: return document_separator.join( format_document(doc, _document_prompt) for doc in inputs[document_variable_name] ) return ( RunnablePassthrough.assign(**{document_variable_name: format_docs}).with_config( run_name=\"format_inputs\", ) | prompt | llm | _output_parser ).with_config(run_name=\"stuff_documents_chain\") Project 05 Advanced RAG Q\u0026A Project create_retriever_tool æœ¬è´¨å°±æ˜¯ å°†æ£€ç´¢ã€æ ¼å¼åŒ–ã€æ‹¼æ¥å·¥ä½œç»„è£…ä¸ºä¸€ä¸ªæ•´ä½“åŠŸèƒ½ç„¶åï¼Œå®ä¾‹åŒ–ä¸ºä¸€ä¸ªtoolã€‚ Scratchpad å«ä¹‰ ç›´è¯‘ä¸ºè‰ç¨¿çº¸ åœ¨ LangChain æˆ–ç±»ä¼¼æ¡†æ¶ä¸­ï¼Œscratchpad é€šå¸¸æŒ‡ä»£ç†(Agent)çš„ä¸´æ—¶å·¥ä½œç©ºé—´ï¼Œç”¨äºï¼š å­˜å‚¨ä¸­é—´æ€è€ƒè¿‡ç¨‹ è®°å½•å½“å‰ä»»åŠ¡çŠ¶æ€ ä¿å­˜ä¸´æ—¶è®¡ç®—ç»“æœ è¿›è¡Œæ¨ç†å’Œå†³ç­–çš„ç¼“å†²åŒº è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„è®¡ç®—æœºç§‘å­¦æ¦‚å¿µï¼Œè¡¨ç¤ºä»»ä½•ç”¨äºä¸´æ—¶å­˜å‚¨å’Œå¤„ç†çš„å†…å­˜åŒºåŸŸã€‚ æœ€ç»ˆtoolsæ˜¯åœ¨ ollama._types.ChatRequest è¿›è¡Œè§£æï¼Œå…·ä½“è§ä¸‹é¢ä»£ç ã€‚ è¿™é‡Œçš„llmèµ°çš„æ˜¯chatç±»å‹çš„llmï¼Œæ‰€ä»¥åº•å±‚æ˜¯èµ° /api/chat æ¥å£ï¼Œè¯¥æ¥å£çš„å‚æ•°åˆ—è¡¨ä¸­å«æœ‰toolsã€‚ç›¸å½“äºè¯¥æ¥å£å·²ç»æŠŠtoolsçš„æè¿°å¦‚ä½•æ ¼å¼åŒ–éƒ½å·²ç»åœ¨å†…éƒ¨è§£å†³æ‰ï¼Œä¸éœ€è¦è°ƒç”¨æ–¹å°†toolsçš„æè¿°æ ¼å¼åŒ–åˆ° prompté‡Œé¢ã€‚ AgentExecutoré‡Œæœ€é‡è§†ä¾èµ– iteræ–¹æ³•æ¥ä¸æ–­è¿­ä»£ï¼Œåº•å±‚æ˜¯ä¾èµ–_iter_next_stepæ¥è¿›è¡Œ thoughtã€actionæ­¥éª¤çš„ã€‚ å³chat_modelçš„æ¥å£éƒ½æ˜¯æ”¯æŒåœ¨è¯·æ±‚ä¸­åŠ å…¥toolså‚æ•°çš„ã€‚ prompt hub https://smith.langchain.com/hub/hwchase17/openai-functions-agent å‡½æ•°è°ƒç”¨ - OpenAI API â€” Function calling - OpenAI API ç›¸å…³å…³é”®ä»£ç å¦‚ä¸‹\n#Runnableçš„æ–¹æ³• def bind(self, **kwargs: Any) -\u003e Runnable[Input, Output]: \"\"\"Bind arguments to a `Runnable`, returning a new `Runnable`. Useful when a `Runnable` in a chain requires an argument that is not in the output of the previous `Runnable` or included in the user input. \"\"\" #langchain_ollama.chat_models.ChatOllama._create_chat_stream # ollama/_client.py:351 # ollama._client.Client.chat return self._request( ChatResponse, 'POST', '/api/chat', json=ChatRequest( model=model, messages=list(_copy_messages(messages)), tools=list(_copy_tools(tools)), stream=stream, think=think, format=format, options=options, keep_alive=keep_alive, ).model_dump(exclude_none=True), stream=stream, ) #langchain_classic.agents.agent.AgentExecutor._iter_next_step def _iter_next_step( self, name_to_tool_map: dict[str, BaseTool], color_mapping: dict[str, str], inputs: dict[str, str], intermediate_steps: list[tuple[AgentAction, str]], run_manager: CallbackManagerForChainRun | None = None, ) -\u003e Iterator[AgentFinish | AgentAction | AgentStep]: \"\"\"Take a single step in the thought-action-observation loop. Override this to take control of how the agent makes and acts on choices. \"\"\" try: intermediate_steps = self._prepare_intermediate_steps(intermediate_steps) # Call the LLM to see what to do. output = self._action_agent.plan( intermediate_steps, callbacks=run_manager.get_child() if run_manager else None, **inputs, ) except OutputParserException as e: ...... # If the tool chosen is the finishing tool, then we end and return. if isinstance(output, AgentFinish): yield output return actions: list[AgentAction] actions = [output] if isinstance(output, AgentAction) else output for agent_action in actions: yield agent_action for agent_action in actions: yield self._perform_agent_action( name_to_tool_map, color_mapping, agent_action, run_manager, ) ... Project 06 Groq inference æœ¬åœ°æœåŠ¡å’Œè¿œç¨‹æœåŠ¡çš„ä»£ç†è®¾ç½®ï¼Œå¦‚ä¸‹é¢ä»£ç  HTTP_PROXY å’Œ HTTPS_PROXYç”¨äºè®¾ç½®é€šè¿‡httpæœåŠ¡çš„ä»£ç† NO_PROXY ç”¨äºæœ¬åœ°æœåŠ¡ç»•è¿‡ä¸Šé¢è®¾ç½®çš„ä»£ç†ï¼Œå¦‚æœ¬åœ°çš„OllamaæœåŠ¡ã€‚ vectorstore.as_retriever å¯ä»¥ç›´æ¥è½¬æ¢ä¸ºæ£€ç´¢å™¨ æ–¹æ³•å‚æ•°search_kwargs ä¸­ä¹Ÿå¯ä»¥è®¾ç½®è¿”å›çš„æ–‡æ¡£æ•°ç›®kã€MMRå¤šæ ·æ€§ç®—æ³•ã€å…ƒæ•°æ®è¿‡æ»¤å™¨å‡½æ•°ç­‰ã€‚ import os # è®¾ç½®httpçš„ä»£ç†å’Œä¸ä»£ç†çš„åœ°å€ os.environ['HTTP_PROXY'] = \"http://127.0.0.1:7890\" os.environ['HTTPS_PROXY'] = \"http://127.0.0.1:7890\" os.environ['NO_PROXY'] = \"http://127.0.0.1:11434\" #ollamaçš„æœ¬åœ°æœåŠ¡åœ°å€ Project 07 Gen AI HuggingFaceEndpoint æ¥å£é—®é¢˜ bug https://github.com/langchain-ai/langchain/issues/31434#issuecomment-2936308959 å› ä¸ºå®˜æ–¹æœåŠ¡ä¸å†æä¾› text-generationçš„æ¨¡å‹æœåŠ¡ã€‚ å¯ä»¥ä½¿ç”¨ ChatHuggingFaceæ¥ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚ Project 08 Powerful Doc Q\u0026A Chatbot OllamaEmbeddings åœ¨æœ¬åœ°çš„ç¬”è®°æœ¬ä¸Šå¯¹äº4ç¯‡è®ºæ–‡çš„è®¡ç®—éå¸¸æ…¢ã€‚ ä½¿ç”¨äº†HuggingFaceEmbeddingsåŠ ä¸€ä¸ªå°embæ¨¡å‹è®¡ç®—æ—¶é—´å˜å°‘äº†å¾ˆå¤šã€‚ Project 09 Advance Q\u0026A Chatbot langchain-ObjectBox ç‰ˆæœ¬å¤ªè€ï¼Œæ²¡æ³•å®‰è£…ã€‚è¯¥æ•°æ®åº“ ObjectBox ç»´æŠ¤ä¼¼ä¹ä¸æ˜¯å¾ˆå¤šã€‚ Project 11 ImageEnhancer model_scope å…¼å®¹æ¥å£ APIæ¨ç†ä»‹ç» Â· æ–‡æ¡£ä¸­å¿ƒ å…¼å®¹openaiæ¥å£ streamlit åº”ç”¨ debug é€‰æ‹©module streamlit å‚æ•°å¡«å†™ run app.py working directory å¡«å†™app.pyçš„ç›®å½• ä½¿ç”¨modelscopeæœåŠ¡æ¥ä»£æ›¿openaiçš„å›¾åƒç”Ÿæˆæ¥å£ã€‚ æ–‡ç”Ÿå›¾æ¨¡å‹ æ”¯æŒAPIè°ƒç”¨çš„æ¨¡å‹åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡AIGCæ¨¡å‹é¡µé¢è¿›è¡Œæœç´¢ã€‚ ä¸Šè¿°é¡µé¢ä¸­åˆ—å‡ºçš„å¾ˆå¤šæ¨¡å‹éƒ½å¾®è°ƒçš„å¾ˆå·®ï¼Œä½¿ç”¨åç”Ÿæˆç»“æœå¾ˆå¤šå¹¶ä¸èƒ½éµä»æŒ‡ä»¤ã€‚ è°ƒæ•´äº† gpu_memory_utilization ä»0.9 åˆ°0.95 æŠ¥é”™ ValueError: To serve at least one request with the models's max seq len (40960), (5.62 GiB KV cache is needed, which is larger than the available KV cache memory (4.81 GiB). å·®ä¸€ç‚¹å†…å­˜ï¼Œæ‰€ä»¥å¢åŠ äº†gpuçš„åˆ©ç”¨ç‡ã€‚ ä»è¿™ç‚¹çœ‹ï¼Œå¤§æ¨¡å‹ä¸€æ¬¡æ¨ç†éå¸¸æ¶ˆè€—æ˜¾å­˜ã€‚ ä¸€æ¡æ•°æ®çš„æœ€å¤§æ˜¾å­˜æ¶ˆè€— æ˜¾å­˜æ¶ˆè€—=2(key+value) * seq_len(40960) * model_layer * hidden_size * head_dim * 2(byte FP16) P02 demo_simple_rag_py è¯¥é¡¹ç›®å±•ç¤ºRAGåŸç†çš„æç®€ä»£ç ã€‚\nå‚è€ƒèµ„æ–™ å…³è”åšæ–‡ Code a simple RAG from scratch é¡¹ç›®ä»£ç  demo.py Â· ngxson/demo_simple_rag_py at main å¾ˆå¥½çš„å±•ç¤ºRAGåŸç†æ€§çš„å°demoï¼Œä¸éœ€è¦å®‰è£…å‘é‡æ•°æ®åº“ã€‚ æ¨¡å‹ID bartowski/Llama-3.2-1B-Instruct-GGUF è¿™ä¸ªæ¨¡å‹ä¸­çš„instructçš„æ„æ€ instructæ„æ€å°±æ˜¯æŒ‡æ¨¡å‹æ˜¯ç»è¿‡ åœ¨base modelä¸Šç»è¿‡æŒ‡ä»¤å¾®è°ƒï¼ˆæˆ–è€…å«ç›‘ç£å¾®è°ƒï¼‰è¿‡ç¨‹ä¹‹åäº§ç”Ÿçš„æ¨¡å‹ï¼Œå¯ä»¥ç›´æ¥ç”¨äºèŠå¤©ã€åŠ©æ‰‹ç±»åº”ç”¨ Ollamaé—®é¢˜ æ¨¡å‹ä¸‹è½½é—®é¢˜ ollama æ‹‰å–hf.co ç½‘ç«™çš„æ¨¡å‹å¤±è´¥ Ollama pull è¿›åº¦å·²ç»100%ï¼Œ ä½†ä¸ºä»€ä¹ˆä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ Error: max retries exceeded: Get \"https://huggingface.co/v2/bartowski/Llama-3.2-1B-Instruct-GGUF/blobs/sha256:948af2743fc78a328dcb3b0f5a31b3d75f415840fdb699e8b1235978392ecf85?__sign=eyJhbGciOiJFZERTQSJ9.eyJyZWFkIjp0cnVlLCJwZXJtaXNzaW9ucyI6eyJyZXBvLmNvbnRlbnQucmVhZCI6dHJ1ZX0sImlhdCI6MTc2Mjc1MzA3Niwic3ViIjoiL2JhcnRvd3NraS9MbGFtYS0zLjItMUItSW5zdHJ1Y3QtR0dVRiIsImV4cCI6MTc2Mjc1MzY3NiwiaXNzIjoiaHR0cHM6Ly9odWdnaW5nZmFjZS5jbyJ9.wVhqKCuc0vtHoS8DUStd86RoS1dhE0e-IqqMIpLZ_mEbfz6ahWeaoQiuTpWuaJCels7Q7uIIwEky9DhHsynYCg\": dial tcp 54.89.135.129:443: connect: connection refused æ£€æŸ¥ç½‘ç»œæ˜¯å¯ä»¥è¿æ¥ hf.coç½‘ç«™çš„ã€‚ æ‰¾ä¸åˆ°åŸå› ã€‚ ollama ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ã€‚ quantizing-a-model - Ollama ollamaå¯¹ä»“åº“æ¨¡å‹çš„é€‰æ‹© ollama run model_repo_idï¼Œå¦‚æœrepoä¸­æœ‰å¤šç‰ˆæœ¬æ¨¡å‹ï¼Œé‚£ä¹ˆollamaä¼šé€‰æ‹©Q4ç‰ˆæœ¬çš„ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯æ˜¾å¼æŒ‡å®šå…·ä½“ç‰ˆæœ¬ ollama run hf.co/{username}/{repository}:{quantization} æ¯”å¦‚ ollama run hf.co/bartowski/Llama-3.2-3B-Instruct-GGUF:Llama-3.2-3B-Instruct-IQ3_M.gguf å‚è€ƒèµ„æ–™ Use Ollama with any GGUF Model on Hugging Face Hub æ¨¡å‹æ–‡ä»¶é—®é¢˜ GGUF æ–‡ä»¶åŒ…å«äº†tokenizerçš„æ•°æ®ã€‚ æ¨¡å‹çš„Ollamaæ„å»ºæ–¹æ³•ï¼šæ‰‹åŠ¨ä¸‹è½½ggufæ¨¡å‹æ–‡ä»¶ï¼Œç„¶åæœ¬åœ°è¿›è¡Œollamaæ‰‹åŠ¨æ„å»ºã€‚ æ‰‹åŠ¨ä¸‹è½½ https://huggingface.co/bartowski/Llama-3.2-1B-Instruct-GGUF/tree/main ä¸­çš„ Llama-3.2-1B-Instruct-Q4_K_M.ggufæ–‡ä»¶ã€‚ ç„¶åæ ¹æ®æ–‡æ¡£Importing a Model - Ollamaæ¥å¯¼å…¥åˆ°æœ¬åœ°ollamaçš„ç¼“å­˜ç›®å½•ã€‚ åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç©ºç›®å½• åˆ›å»º ModelFileæ–‡ä»¶ï¼Œå†…å®¹ä¸º FROM ./Llama-3.2-1B-Instruct-Q4_K_M.gguf æ‰§è¡Œå‘½ä»¤ollama create bartowski/Llama-3.2-1B-Instruct-GGUF æ¨¡å‹å°±å¯ä»¥è¢«æ„å»ºç¼“å¹¶å¤åˆ¶åˆ° ollamaçš„ç¼“å­˜ç›®å½•ä¸­ã€‚ å¹¶åŒæ ·æ„å»º bge-base-en-v1.5-q4_k_m.gguf æ¨¡å‹ ollama.embed(model=\"CompendiumLabs/bge-base-en-v1.5-gguf\") è¿™é‡Œçš„æ¨¡å‹åæŒ‰ç…§/æ¥åˆ†å‰²ï¼Œå³è¯´æ˜æ˜¯æœ¬åœ°æ–‡ä»¶çš„æ¨¡å‹ã€‚ å¦‚æœæ˜¯æ­£å¸¸çš„:åˆ†å‰²çš„æ¨¡å‹åï¼Œåˆ™ollamaä¼šè‡ªåŠ¨ä»ç¼“å­˜ç›®å½•ä¸­çš„ libraryå­ç›®å½•ä¸­æŸ¥æ‰¾ã€‚ åœ¨ChatModelçš„streamæ¨¡å¼ä¸‹ï¼Œè¿”å›æ˜¯ä¸€ä¸ªè¯ä¸€ä¸ªè¯çš„è¿›è¡Œè¿”å›çš„ã€‚ åœ¨è¯¥demoç¤ºä¾‹ä¸­ï¼Œæ£€ç´¢åˆ°çš„æ–‡æ¡£æ˜¯å…¨è¢«å¡åˆ°ä¸€ä¸ªsystem messageä¸‹ï¼Œç„¶ååç»­çš„å¯¹è¯ä½†å°±æ˜¯æ ¹æ®æ­¤æ¥è¿›è¡Œäº¤äº’ã€‚ P03 RAG-Optimization-Practices é¡¹ç›®åŸç†å’Œç»“æœ ç›¸å…³èµ„æ–™ é¡¹ç›®æ¥æº kanhaoning/RAG-Optimization-Practices Quickstart â€” Sentence Transformers documentation å®˜æ–¹æ–‡æ¡£å¾ˆä¸é”™ã€‚ é˜¿é‡Œäº‘æœåŠ¡å™¨ uv ä¸‹è½½ç»å¸¸è¶…æ—¶çš„è§£å†³æ–¹æ¡ˆï¼Œéå¸¸å¥½ç”¨ã€‚ export UV_HTTP_TIMEOUT=240 export UV_CONCURRENT_DOWNLOADS=2 å¦‚ä½•åŠ å¿«å®‰è£…uvç¯å¢ƒã€ç¼“å­˜ åœ¨ä¸€å°ä¾¿å®œçš„æœºå™¨ä¸Šä½¿ç”¨uvæ¥æ„å»ºä¸€ä¸ªdummyé¡¹ç›®ï¼Œuvçš„ç¼“å­˜å°±ä¼šç•™ä¸‹ã€‚ rsync uvç¼“å­˜ç›®å½•åˆ° ç›®æ ‡æœåŠ¡å™¨çš„uvç¼“å­˜ç›®å½•ä¸‹ã€‚åŒä¸€ä¸ªvpcä¸‹ä¸¤ä¸ªæœåŠ¡å™¨çš„rsyncé€Ÿåº¦éå¸¸å¿«ï¼Œ300M/sã€‚å¹¶ä¸”rsyncä¼šä¿æŒæ–‡ä»¶çš„è½¯é“¾æ¥ã€‚ è¿™æ ·æ•´ä½“èŠ±é’±å°‘ï¼Œå¹¶ä¸”æ„å»ºé€Ÿåº¦å¿«ã€‚ Qwen-rerankerå’Œbertä¸€æ ·æ˜¯åŒå‘æ³¨æ„åŠ›è®¡ç®—æ–¹å¼ã€‚ å¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥ é˜¿é‡Œäº‘ossfsçš„ä»£ç å­˜æ¡£ã€‚ å®‰è£…ossfs wget https://github.com/aliyun/ossfs/releases/download/v1.91.8/ossfs_1.91.8_ubuntu24.04_amd64.deb sudo apt install ./ossfs_1.91.8_ubuntu24.04_amd64.deb ç¯å¢ƒé…ç½® A10 GPUï¼ˆæ˜¾å­˜24Gï¼‰ Reranker distillationæ•´ä½“æ­¥éª¤ è¯´æ˜ æ¨¡å‹æœ¬è´¨å°±æ˜¯cross-encoderï¼Œå³å°†QAè¿›è¡Œæ‹¼æ¥ï¼Œè¾“å…¥LLMè¿›è€Œå¾—åˆ°ç›¸ä¼¼åº¦ã€‚ generate_logits ç”Ÿæˆ59ä¸‡æ¡æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰ï¼Œè¿è¡Œæ—¶é•¿ï¼ˆ250minï¼‰ã€‚ å³é’ˆå¯¹ query å’Œdoc ç”Ÿæˆä¸€ä¸ªlogprobåˆ†æ•°ï¼Œå³ (query, passage, score)ã€‚ logprobåˆ†æ•°åˆ©ç”¨äº† promptæ¨¡æ¿ + LLMçš„chatæ¥å£ è¿›è¡Œæ‰“åˆ†ã€‚ promptæ¨¡æ¿å¦‚ä¸‹ã€‚ Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be \"yes\" or \"no\". : {instruction}\\n: {query}\\n: {doc} å…¶ä¸­ instructå˜é‡ä¸º Given a web search query, retrieve relevant passages that answer the query prompt é™åˆ¶äº†è¾“å‡ºtokençš„èŒƒå›´ä¸º ä¸¤ä¸ªtoken ï¼ˆyes or noï¼‰ ã€‚ æ¨ç†ä½¿ç”¨ vLLMçš„sdkï¼ŒåŠ è½½æœ¬åœ°æ¨¡å‹æ–‡ä»¶ã€‚ ä¸‰å…ƒç»„è’¸é¦æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰ ç”Ÿæˆä¸‰å…ƒç»„è’¸é¦æ•°æ® (query, positive passage, negative passage, logits_diff) æ­£æ ·æœ¬ä¸ºlogits æœ€é«˜top_ké‡ŒæŠ½æ ·ã€‚ è´Ÿæ ·æœ¬æŒ‰ç…§logitsæ’åº æ¯ä¸ªæ­£æ ·æœ¬ä½ç½®åé¢çš„æ ·æœ¬ã€‚ å³ä¸¤ä¸¤ç»„åˆï¼Œç»„åˆæ•°é‡ä¸º n*(n-1)/2 å¹¶éä½¿ç”¨è¯¥é¡¹ç›®æ•°æ®é›†çœŸæ­£çš„åŸå§‹ ground-truth labelã€‚ è®­ç»ƒ åˆ©ç”¨ embeddingå°æ¨¡å‹ + ä¸‰å…ƒç»„è’¸é¦æ•°æ® è¿›è¡Œè®­ç»ƒï¼Œå°†é¢†åŸŸçŸ¥è¯†è’¸é¦è¿›å°æ¨¡å‹ã€‚ è¯„ä¼° å¯¹å¾®è°ƒå‰çš„æ¨¡å‹å’Œå¾®è°ƒåçš„æ¨¡å‹åˆ©ç”¨æµ‹è¯•é›†æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚ Embedding-distillatioinæ•´ä½“æ­¥éª¤ è¯´æ˜ æ¨¡å‹å…¶å®å°±æ˜¯bi-encoderï¼Œå³æ¨¡å‹è¾“å‡ºembeddingï¼Œç„¶åè®¡ç®—QAç›¸ä¼¼åº¦ã€‚ ç”¨KLæ•£åº¦å°†Qwen3-Embedding-8Bå‘é‡å¤§æ¨¡å‹çŸ¥è¯†è’¸é¦ç»™å°æ¨¡å‹BGE-m3 - çŸ¥ä¹ generate_logits é’ˆå¯¹åŸå§‹æ•°æ®ä¸­æ¯ä¸€è¡Œä¸­çš„ ä¸€ä¸ªqueryã€å¤šä¸ªpositiveæ–‡æ¡£ã€å¤šä¸ªnegativeæ–‡æ¡£ åˆ†åˆ«è¾“å…¥ Qwen3-embeddingæ¨¡å‹ï¼Œå¾—åˆ°å‘é‡ã€‚ é’ˆå¯¹æ•°æ®å½¢å¼ ï¼ˆqueryï¼ŒpositiveDocï¼Œ[negativeDoc,negativeDoc2ï¼Œ...]ï¼‰ï¼Œåˆ†åˆ«è®¡ç®—queryå’Œæ¯ä¸ªdocçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œç„¶åå°† æ‰€æœ‰çš„ç›¸ä¼¼åº¦ è§†ä¸ºä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒã€‚ train.sh å¯¹äºå­¦ç”Ÿæ¨¡å‹åŒæ ·äº§ç”Ÿä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œå’Œè€å¸ˆæ¨¡å‹çš„åˆ†å¸ƒè®¡ç®—KLæŸå¤±ï¼Œè¿›è€Œè®­ç»ƒå­¦ç”Ÿæ¨¡å‹ã€‚ è¯„ä¼° åˆ©ç”¨é¢„ç•™çš„æµ‹è¯•é›†è¿›è¡Œè¯„ä¼°ã€‚ uv ç¼“å­˜ç®¡ç†é—®é¢˜ å› ä¸º é¡¹ç›®ç›®å½•å’Œ uvç¼“å­˜ç›®å½•ä¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæ‰€ä»¥uvç¼“å­˜æ— æ³•é«˜æ•ˆè¿è½¬ï¼Œåªèƒ½åªç”¨ç¡¬å¤åˆ¶æ¥æ„å»ºvenvç¯å¢ƒã€‚æ‰€ä»¥éœ€è¦è¿ç§»uvç¼“å­˜åˆ°åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚ æ¸…ç†ç¼“å­˜é¡¹ç›®ï¼Œuvç®¡ç†ã€‚ du -sh ~/.cache/uv .venv å¯ä»¥ç”¨æ¥ç»Ÿè®¡ venvæ˜¯å¦çœŸæ­£å¤šå ç”¨äº†å­˜å‚¨ã€‚ uv ç¼“å­˜è¿ç§»çš„æ—¶å€™ ä¸èƒ½ä½¿ç”¨ mv å’Œ cpå‘½ä»¤ï¼Œå¿…é¡»ä½¿ç”¨ rsync -av å‘½ä»¤ï¼Œä¸ç„¶æ— æ³•ä¿æŒ è½¯ç¡¬é“¾æ¥çš„å…³ç³»ã€‚ uv ç¼“å­˜ é€šè¿‡ .bashrc ç¯å¢ƒå˜é‡æ¥æŒ‡å®š export UV_CACHE_DIR=/mnt/fast-ssd/uv-cache ä¸Šè¿°å®Œæˆä¹‹åï¼Œé¡¹ç›®çš„uvæ„å»ºé€Ÿåº¦å¤§å¹…æå‡è‡³\u003c1ç§’ã€‚ CrossEncoder Cross-Encoders â€” Sentence Transformers documentation Cross-Encoder achieve higher performance than Bi-Encoders, however, they do not scale well for large datasets. Here, it can make sense to combine Cross- and Bi-Encoders, for example in Information Retrieval / Semantic Search scenarios: First, you use an efficient Bi-Encoder to retrieve e.g. the top-100 most similar sentences for a query. Then, you use a Cross-Encoder to re-rank these 100 hits by computing the score for every (query, hit) combination. promptæ ¼å¼\n# promptæ ¼å¼ message = [ {\"role\": \"system\", \"content\": \"Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be \\\"yes\\\" or \\\"no\\\".\"}, {\"role\": \"user\", \"content\": f\": {instruction}\\n: {query}\\n: {doc}\"} ] #LLMé‡‡æ ·å‚æ•°ï¼Œåªå…è®¸ yes å’Œ no é€‰é¡¹çš„logproè¾“å‡ºã€‚ # å®šä¹‰å›ºå®šçš„ token å’Œé‡‡æ ·å‚æ•° true_token = tokenizer(\"yes\", add_special_tokens=False).input_ids[0] false_token = tokenizer(\"no\", add_special_tokens=False).input_ids[0] sampling_params = SamplingParams( temperature=0, max_tokens=1, logprobs=20, allowed_token_ids=[true_token, false_token], ) rerankerè’¸é¦è¯„ä¼°ç»“æœ\n# reranker è’¸é¦è®­ç»ƒä¹‹åçš„è¯„ä¼°ç»“æœ (rag-optimization-practices) root@dsw-1457330-845c588466-dwlc9:/mnt/workspace/large_model_demo/RAG/RAG-Level-02/P03-RAG-Optimization-Practices/Reranker-Distillation# bash evaluate.sh æ­£åœ¨ä» data/test.jsonl åŠ è½½æ•°æ®é›†... åŠ è½½å®Œæˆï¼å…± 2992 æ¡æ ·æœ¬ã€‚ --- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-reranker-v2-m3 --- --- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: ./output/checkpoint-1217 --- ================================================== âœ… æœ€ç»ˆè¯„ä¼°ç»“æœæ±‡æ€» ================================================== ã€è’¸é¦å‰ã€‘æ¨¡å‹æ€§èƒ½: - MAP: 0.472061 - MRR@10: 0.478234 - NDCG@10: 0.547284 ã€è’¸é¦åã€‘æ¨¡å‹æ€§èƒ½: - MAP: 0.564523 - MRR@10: 0.573106 - NDCG@10: 0.638634 ================================================== ğŸš€ æ€§èƒ½å˜åŒ–åˆ†æ (è’¸é¦å vs. è’¸é¦å‰) ================================================== æŒ‡æ ‡ [MAP]: - ç»å¯¹æå‡: +0.092462 - ç›¸å¯¹æå‡: +19.59% â†‘ æŒ‡æ ‡ [MRR@10]: - ç»å¯¹æå‡: +0.094872 - ç›¸å¯¹æå‡: +19.84% â†‘ æŒ‡æ ‡ [NDCG@10]: - ç»å¯¹æå‡: +0.091349 - ç›¸å¯¹æå‡: +16.69% â†‘ è¯„ä¼°å®Œæˆï¼âœ¨ embeddingè’¸é¦è¯„ä¼°ç»“æœ\n(rag-optimization-practices) root@dsw-1457330-845c588466-dwlc9:/mnt/workspace/large_model_demo/RAG/RAG-Level-02/P03-RAG-Optimization-Practices/Embedding-Distillation# bash evaluation.sh ============================================================ æ¨¡å‹æ€§èƒ½å¯¹æ¯”è¯„ä¼° ============================================================ ------------------------------ é¢†åŸŸå†…æ•°æ®é›†è¯„ä¼° ------------------------------ æ­£åœ¨åŠ è½½æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-m3 æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_scidocs/test.jsonl æˆåŠŸåŠ è½½ 3978 æ¡æ ·æœ¬ å¼€å§‹è¯„ä¼°... Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 63/63 [00:06\u003c00:00, 9.34it/s] Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1854/1854 [03:29\u003c00:00, 8.85it/s] æ­£åœ¨åŠ è½½æ¨¡å‹: output/checkpoint-477 æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_scidocs/test.jsonl æˆåŠŸåŠ è½½ 3978 æ¡æ ·æœ¬ å¼€å§‹è¯„ä¼°... Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 63/63 [00:06\u003c00:00, 9.28it/s] Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1854/1854 [03:34\u003c00:00, 8.63it/s] ------------------------------ é¢†åŸŸå¤–æ•°æ®é›†è¯„ä¼° ------------------------------ æ­£åœ¨åŠ è½½æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-m3 æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_stackoverflowdupquestions/test.jsonl æˆåŠŸåŠ è½½ 2992 æ¡æ ·æœ¬ å¼€å§‹è¯„ä¼°... Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:04\u003c00:00, 10.51it/s] Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1398/1398 [01:56\u003c00:00, 12.03it/s] æ­£åœ¨åŠ è½½æ¨¡å‹: output/checkpoint-477 æ­£åœ¨åŠ è½½æ•°æ®é›†: data/dataset_stackoverflowdupquestions/test.jsonl æˆåŠŸåŠ è½½ 2992 æ¡æ ·æœ¬ å¼€å§‹è¯„ä¼°... Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 47/47 [00:04\u003c00:00, 10.15it/s] Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1398/1398 [01:57\u003c00:00, 11.88it/s] ============================================================ é¢†åŸŸå†…æ•°æ®é›† æ€§èƒ½å¯¹æ¯” ============================================================ æŒ‡æ ‡ è’¸é¦å‰ è’¸é¦å ç»å¯¹å˜åŒ– ç›¸å¯¹å˜åŒ–(%) ------------------------------------------------------------ map 0.7744 0.8516 +0.0773 +9.98 mrr@10 0.9321 0.9548 +0.0227 +2.43 ndcg@10 0.8296 0.8956 +0.0660 +7.96 ============================================================ é¢†åŸŸå¤–æ•°æ®é›† æ€§èƒ½å¯¹æ¯” ============================================================ æŒ‡æ ‡ è’¸é¦å‰ è’¸é¦å ç»å¯¹å˜åŒ– ç›¸å¯¹å˜åŒ–(%) ------------------------------------------------------------ map 0.5166 0.5034 -0.0132 -2.56 mrr@10 0.5238 0.5110 -0.0127 -2.43 ndcg@10 0.5902 0.5778 -0.0124 -2.10 è¯„ä¼°å®Œæˆ é—®é¢˜ï¼šå¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥ æ˜¯çš„ï¼vLLM ç¡®å®é’ˆå¯¹ã€Œbatch å†…å¤šæ¡è¯·æ±‚å…·æœ‰å…±åŒå‰ç¼€ï¼ˆshared prefixï¼‰ã€çš„åœºæ™¯æä¾›äº†ä¸“é—¨çš„ä¼˜åŒ–ç­–ç•¥ï¼Œè¿™é¡¹æŠ€æœ¯ç§°ä¸ºï¼š\nâœ… Prefix Cachingï¼ˆå‰ç¼€ç¼“å­˜ï¼‰ æˆ– Prompt Sharing è¿™æ˜¯ vLLM çš„æ ¸å¿ƒä¼˜åŒ–ä¹‹ä¸€ï¼Œèƒ½æ˜¾è‘—èŠ‚çœæ˜¾å­˜ã€æå‡ååã€é™ä½å»¶è¿Ÿï¼Œå°¤å…¶é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\nRAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼šå¤šä¸ªæ–‡æ¡£å…±äº«ç›¸åŒçš„ prompt æ¨¡æ¿ å¤šè½®å¯¹è¯ç³»ç»Ÿï¼šå†å²ä¸Šä¸‹æ–‡ç›¸åŒï¼Œä»…ç”¨æˆ·æœ€æ–°è¾“å…¥ä¸åŒ æ‰¹é‡æ¨ç†ï¼šå¦‚ â€œæ€»ç»“ä»¥ä¸‹æ–‡æœ¬ï¼šâ€ï¼Œå…¶ä¸­ ä¸åŒä½†æŒ‡ä»¤ç›¸åŒ ğŸ” å·¥ä½œåŸç†\n1. KV Cache å…±äº«\nLLM æ¨ç†ä¸­ï¼ŒPrefill é˜¶æ®µä¼šä¸º prompt ç”Ÿæˆ KV Cacheï¼ˆKey/Value ç¼“å­˜ï¼‰ å¦‚æœå¤šä¸ªè¯·æ±‚çš„ prompt å‰ç¼€å®Œå…¨ç›¸åŒï¼Œå®ƒä»¬çš„ KV Cache å‰ç¼€éƒ¨åˆ†ä¹Ÿå®Œå…¨ç›¸åŒ vLLM ä¼šï¼š åªè®¡ç®—ä¸€æ¬¡è¯¥å…¬å…±å‰ç¼€çš„ KV Cache å¤šä¸ªè¯·æ±‚å…±äº«è¿™ä»½ç¼“å­˜ åç»­å„è‡ªä¸åŒçš„éƒ¨åˆ†ç‹¬ç«‹è®¡ç®— ğŸ“Œ æœ¬è´¨ï¼šé¿å…é‡å¤è®¡ç®—å’Œå­˜å‚¨ç›¸åŒçš„ä¸Šä¸‹æ–‡\n2. ä¸ PagedAttention ååŒ\nvLLM ä½¿ç”¨ PagedAttention ç®¡ç† KV Cacheï¼ˆç±»ä¼¼æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼‰ å…¬å…±å‰ç¼€çš„ KV Cache è¢«å­˜å‚¨åœ¨å…±äº«ç‰©ç†é¡µä¸­ æ¯ä¸ªè¯·æ±‚çš„é€»è¾‘å—ï¼ˆlogical blocksï¼‰æŒ‡å‘è¿™äº›å…±äº«é¡µ + è‡ªæœ‰é¡µ Request 1: [Shared Prefix] + [Suffix A] Request 2: [Shared Prefix] + [Suffix B] Request 3: [Shared Prefix] + [Suffix C] â†’ KV Cache: Shared Pages: [K/V of \"Shared Prefix\"] Private Pages: [K/V of \"Suffix A\"], [Suffix B], [Suffix C] ğŸš€ æ€§èƒ½æ”¶ç›Š\næŒ‡æ ‡ ä¼˜åŒ–æ•ˆæœ æ˜¾å­˜å ç”¨ â†“ æ˜¾è‘—å‡å°‘ï¼ˆå…¬å…±éƒ¨åˆ†åªå­˜ä¸€ä»½ï¼‰ Prefill è®¡ç®—é‡ â†“ å‡å°‘ï¼ˆå…¬å…±å‰ç¼€åªè®¡ç®—ä¸€æ¬¡ï¼‰ ååï¼ˆthroughputï¼‰ â†‘ æå‡ 2â€“5 å€ï¼ˆå®æµ‹å¸¸è§ï¼‰ æ”¯æŒ batch size â†‘ å¯å®¹çº³æ›´å¤šè¯·æ±‚ ğŸ’¡ å®æµ‹æ¡ˆä¾‹ï¼ˆRAG åœºæ™¯ï¼‰ï¼š\n10 ä¸ªè¯·æ±‚ï¼Œå…±äº« 2K token çš„ prompt æ¨¡æ¿ æ˜¾å­˜èŠ‚çœ \u003e60%ï¼Œååæå‡ 3.2 å€ ğŸ›  å¦‚ä½•å¯ç”¨ï¼Ÿï¼ˆvLLM ä¸­é»˜è®¤å¼€å¯ï¼ï¼‰\næ— éœ€é¢å¤–é…ç½®ï¼švLLM é»˜è®¤è‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨ Prefix Caching æ¡ä»¶ï¼š å¤šä¸ªè¯·æ±‚çš„ prompt å‰ç¼€å¿…é¡»å­—èŠ‚çº§å®Œå…¨ç›¸åŒ ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹å’Œå‚æ•°ï¼ˆtemperature ç­‰ä¸å½±å“ï¼‰ ç¤ºä¾‹ï¼ˆPython clientï¼‰ï¼š\nfrom vllm import LLM, SamplingParams llm = LLM(model=\"Qwen/Qwen-7B-Chat\") **å…±äº«å‰ç¼€ï¼š\"ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼š\"** prompts = [ \"ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šå·´é»æ˜¯å“ªä¸ªå›½å®¶çš„é¦–éƒ½ï¼Ÿ\", \"ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šé‡å­åŠ›å­¦æ˜¯è°æå‡ºçš„ï¼Ÿ\", \"ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šPython å¦‚ä½•è¯»å–æ–‡ä»¶ï¼Ÿ\" ] outputs = llm.generate(prompts, SamplingParams(temperature=0.7)) **â†’ vLLM è‡ªåŠ¨å…±äº«å‰ç¼€çš„ KV Cacheï¼** âš ï¸ æ³¨æ„äº‹é¡¹\né—®é¢˜ è¯´æ˜ å‰ç¼€å¿…é¡»å®Œå…¨ä¸€è‡´ åŒ…æ‹¬ç©ºæ ¼ã€æ ‡ç‚¹ã€æ¢è¡Œç¬¦ã€‚\"ä½ å¥½\" â‰  \"ä½ å¥½ \" ä¸æ”¯æŒåŠ¨æ€æ’å…¥ å¦‚æœå‰ç¼€åœ¨è¿è¡Œæ—¶æ‹¼æ¥ï¼ˆå¦‚åŠ æ—¶é—´æˆ³ï¼‰ï¼Œåˆ™æ— æ³•å…±äº« ä¸ LoRA å…¼å®¹æ€§ è‹¥ä½¿ç”¨ä¸åŒ LoRA adapterï¼Œå³ä½¿ prompt ç›¸åŒä¹Ÿæ— æ³•å…±äº« ä»…é™ Prefill é˜¶æ®µ Decode é˜¶æ®µå› è¾“å‡ºä¸åŒï¼Œæ— æ³•å…±äº« ğŸ”§ é«˜çº§ç”¨æ³•ï¼šæ‰‹åŠ¨æ§åˆ¶ï¼ˆvLLM â‰¥ 0.4.0ï¼‰ å¯é€šè¿‡ enable_prefix_caching=True æ˜¾å¼å¯ç”¨ï¼ˆé»˜è®¤å·²å¼€ï¼‰ï¼š\nllm = LLM( model=\"meta-llama/Llama-3-8b\", enable_prefix_caching=True # é»˜è®¤ True ) ä¹Ÿå¯é€šè¿‡ç¯å¢ƒå˜é‡ï¼š\nVLLM_ENABLE_PREFIX_CACHING=1 ğŸ†š ä¸å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¯”\nç³»ç»Ÿ æ˜¯å¦æ”¯æŒå‰ç¼€å…±äº« vLLM âœ… æ˜¯ï¼ˆåŸºäº PagedAttentionï¼‰ HuggingFace TGI âŒ å¦ï¼ˆæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ KV Cacheï¼‰ TensorRT-LLM âœ… æ˜¯ï¼ˆéœ€æ‰‹åŠ¨æ„å»º shared contextï¼‰ SGLang âœ… æ˜¯ï¼ˆRadixAttention æœºåˆ¶ï¼‰ ğŸ’¡ vLLM çš„å®ç°æ˜¯è‡ªåŠ¨ã€é€æ˜ã€é«˜æ•ˆçš„ä»£è¡¨ã€‚\nâœ… æ€»ç»“\nvLLM æ”¯æŒ Prefix Cachingï¼Œè‡ªåŠ¨ä¼˜åŒ–å…±äº«å‰ç¼€çš„ batch è¯·æ±‚ æ— éœ€ä»£ç ä¿®æ”¹ï¼Œåªè¦ prompt å‰ç¼€ç›¸åŒå³å¯ç”Ÿæ•ˆ æ˜¾è‘—èŠ‚çœæ˜¾å­˜ + æå‡ååï¼Œç‰¹åˆ«é€‚åˆ RAGã€æ‰¹é‡æŒ‡ä»¤ç­‰åœºæ™¯ ç¡®ä¿ä½ çš„ prompt æ¨¡æ¿ä¸¥æ ¼ä¸€è‡´ï¼ˆé¿å…å°¾éƒ¨ç©ºæ ¼/æ¢è¡Œå·®å¼‚ï¼‰ å¦‚æœä½ æ­£åœ¨åš RAG æˆ–æ‰¹é‡æ¨ç†ï¼ŒPrefix Caching æ˜¯ vLLM ç»™ä½ çš„ä¸€ä»½å…è´¹æ€§èƒ½å¤§ç¤¼åŒ…ï¼ğŸ‰\né—®é¢˜ï¼šä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ cacheè¿˜æ²¡äº§ç”Ÿå§ï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ä¸”æ·±åˆ»çš„é—®é¢˜ï¼ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ï¼šå¦‚æœæ•´ä¸ª batch æ˜¯â€œåŒæ—¶â€è¿›è¡Œ prefillï¼ˆå³å¹¶è¡Œå¤„ç†æ‰€æœ‰ promptï¼‰ï¼Œé‚£ä¼¼ä¹è¿˜æ²¡ç”Ÿæˆ KV Cacheï¼Œæ€ä¹ˆå…±äº«ï¼Ÿ ä½†å®é™…æƒ…å†µæ˜¯ï¼švLLM çš„ Prefix Caching å¹¶ä¸æ˜¯åœ¨â€œbatch å†…éƒ¨å¹¶è¡Œæ—¶â€åŠ¨æ€å‘ç°å…±äº«çš„ï¼Œè€Œæ˜¯åœ¨è°ƒåº¦é˜¶æ®µé€šè¿‡â€œå‰ç¼€æ ‘ï¼ˆRadix Tree / Trieï¼‰â€é¢„å…ˆç»„ç»‡è¯·æ±‚ï¼Œä½¿å¾—ç›¸åŒå‰ç¼€çš„è¯·æ±‚åœ¨é€»è¾‘ä¸Šè¢«è¯†åˆ«å¹¶å¤ç”¨å·²ç¼“å­˜çš„ KV å—ã€‚ ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥æ¾„æ¸…è¿™ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„é—®é¢˜ï¼š\nâœ… æ ¸å¿ƒç­”æ¡ˆ\nPrefix Caching çš„â€œcacheâ€å¹¶ä¸æ˜¯æ¥è‡ªå½“å‰ batch å†…éƒ¨çš„å…¶ä»–è¯·æ±‚ï¼Œè€Œæ˜¯æ¥è‡ªï¼š\nä¹‹å‰å·²å®Œæˆçš„è¯·æ±‚ï¼ˆè·¨ batch å…±äº«ï¼‰ï¼Œæˆ– åœ¨å½“å‰ batch å†…éƒ¨ï¼ŒvLLM è°ƒåº¦å™¨ä¼šå…ˆå¤„ç†å…¬å…±å‰ç¼€ä¸€æ¬¡ï¼Œå†å¹¿æ’­ç»™å…¶ä»–è¯·æ±‚ï¼ˆé€»è¾‘ä¸Šä¸²è¡ŒåŒ–å‰ç¼€è®¡ç®—ï¼‰ ä½†åœ¨ çº¯é¦–æ¬¡ batchï¼ˆæ²¡æœ‰ä»»ä½•å†å² cacheï¼‰ä¸”æ‰€æœ‰è¯·æ±‚é¦–æ¬¡å‡ºç° çš„æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ª batch å†…çš„è¯·æ±‚ç¡®å®æ— æ³•å½¼æ­¤å…±äº« KV Cache â€”â€” é™¤é vLLM æ˜¾å¼åœ°å°†å…¬å…±å‰ç¼€æå–å‡ºæ¥å•ç‹¬è®¡ç®—ä¸€æ¬¡ã€‚ è€Œ vLLM æ­£æ˜¯è¿™ä¹ˆåšçš„ï¼ ğŸ” æ·±å…¥æœºåˆ¶ï¼švLLM å¦‚ä½•åœ¨å•ä¸ª batch å†…å®ç°å‰ç¼€å…±äº«ï¼Ÿ\nå…³é”®æŠ€æœ¯ï¼šRadix Treeï¼ˆåŸºæ•°æ ‘ï¼‰ + Block-wise KV Cache Management vLLM åœ¨è°ƒåº¦ä¸€ä¸ª batch å‰ï¼Œä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š\næ­¥éª¤ 1ï¼šæ„å»º Radix Tree\nå°† batch ä¸­æ‰€æœ‰ prompt æ’å…¥ä¸€æ£µ å‰ç¼€æ ‘ï¼ˆTrieï¼‰ è‡ªåŠ¨è¯†åˆ«æœ€é•¿å…¬å…±å‰ç¼€ï¼ˆLCPï¼‰ Prompts: \"ä½ æ˜¯AIã€‚Q: å·´é»?\" \"ä½ æ˜¯AIã€‚Q: é‡å­?\" \"ä½ æ˜¯AIã€‚Q: Python?\" â†’ Radix Tree: root â””â”€â”€ \"ä½ æ˜¯AIã€‚Q: \" â”œâ”€â”€ \"å·´é»?\" â”œâ”€â”€ \"é‡å­?\" â””â”€â”€ \"Python?\" æ­¥éª¤ 2ï¼šåˆ†å±‚ Prefillï¼ˆHierarchical Prefillï¼‰\nå…ˆå¯¹å…¬å…±å‰ç¼€ \"ä½ æ˜¯AIã€‚Q: \" æ‰§è¡Œä¸€æ¬¡ prefill ç”Ÿæˆå…¶å¯¹åº”çš„ KV Cache blocks å†å¯¹æ¯ä¸ªåç¼€ï¼ˆâ€œå·´é»?â€ ç­‰ï¼‰åˆ†åˆ«æ‰§è¡Œ prefill æ¯ä¸ªåç¼€çš„ attention è®¡ç®—ä¼š æ‹¼æ¥å…¬å…±å‰ç¼€çš„ KV blocks + è‡ªèº«åç¼€çš„ KV blocks ğŸ¯ è¿™ç›¸å½“äº æŠŠä¸€ä¸ªé•¿ prompt æ‹†æˆ â€œshared part + unique partâ€ï¼Œå¹¶åœ¨è®¡ç®—æ—¶ç»„åˆã€‚\næ­¥éª¤ 3ï¼šPagedAttention æ”¯æŒéè¿ç»­ KV å—\næ¯ä¸ªè¯·æ±‚çš„å®Œæ•´ KV Cache = [shared_block_ids] + [unique_block_ids] Attention è®¡ç®—æ—¶ï¼ŒPagedAttention è‡ªåŠ¨ä»å¤šä¸ªç‰©ç†é¡µè¯»å–ï¼Œå¯¹æ¨¡å‹é€æ˜ ğŸ“Œ é‡è¦æ¾„æ¸…\nè¯¯è§£ äº‹å® â€œbatch å†…æ‰€æœ‰ prompt åŒæ—¶å¹¶è¡Œè®¡ç®—â€ âŒ å®é™…æ˜¯ï¼šå…¬å…±å‰ç¼€å…ˆç®—ä¸€æ¬¡ï¼Œåç¼€å†å¹¶è¡Œï¼ˆé€»è¾‘ä¸Šåˆ†é˜¶æ®µï¼‰ â€œcache å¿…é¡»æ¥è‡ªå†å²è¯·æ±‚â€ âŒ å³ä½¿å…¨æ˜¯æ–°è¯·æ±‚ï¼ŒvLLM ä¹Ÿèƒ½åœ¨ batch å†…éƒ¨æ„é€ å…±äº« â€œPrefill æ˜¯å®Œå…¨ç‹¬ç«‹çš„â€ âŒ vLLM çš„è°ƒåº¦å™¨ä¼šä¸»åŠ¨é‡ç»„è®¡ç®—å›¾ä»¥å¯ç”¨å…±äº« ğŸ§ª å®éªŒéªŒè¯ï¼ˆæ€æƒ³å®éªŒï¼‰ å‡è®¾ batch æœ‰ 3 ä¸ªå…¨æ–°è¯·æ±‚ï¼Œæ— ä»»ä½•å†å² cacheï¼š\nprompts = [ \"Hello world A\", \"Hello world B\", \"Hello world C\" ] vLLM çš„æ‰§è¡Œæµç¨‹ï¼š\nè°ƒåº¦å™¨å‘ç°å…¬å…±å‰ç¼€ \"Hello world \" åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿâ€œå…±äº«è¯·æ±‚â€ï¼Œprefill \"Hello world \" â†’ å¾—åˆ° KV blocks S å¯¹æ¯ä¸ªåç¼€ \"A\", \"B\", \"C\"ï¼š æ„é€ è¾“å…¥ï¼š\"Hello world X\" ä½† KV Cache = S + prefill(â€œXâ€) çš„ç»“æœ æœ€ç»ˆæ¯ä¸ªè¯·æ±‚çš„è¾“å‡ºæ­£ç¡®ï¼Œä¸” S åªè®¡ç®—äº†ä¸€æ¬¡ ğŸ’¡ è¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ è®¡ç®—å›¾èåˆä¼˜åŒ–ï¼Œç”± vLLM çš„ scheduler è‡ªåŠ¨å®Œæˆã€‚\nğŸ“š å®˜æ–¹ä¾æ®\nvLLM è®ºæ–‡ï¼ˆvLLM: Easy, Fast, and Cheap LLM Servingï¼‰æåˆ°ï¼š â€œPagedAttention enables sharing of memory blocks across requests with common prefixes.â€\næºç ä¸­ RadixAttentionï¼ˆåç»­æ¼”è¿›ï¼‰å’Œ PrefixCacher ç»„ä»¶æ˜ç¡®æ”¯æŒ intra-batch prefix sharing ğŸ”— å‚è€ƒï¼švLLM Prefix Caching Design Doc\nâœ… æ€»ç»“\né—®é¢˜ å›ç­” åŒä¸€ä¸ª batch å†…çš„è¯·æ±‚èƒ½å…±äº«å‰ç¼€å—ï¼Ÿ âœ… èƒ½ï¼å³ä½¿å…¨æ˜¯æ–°è¯·æ±‚ cache æ˜¯å“ªé‡Œæ¥çš„ï¼Ÿ æ¥è‡ª å½“å‰ batch å†…éƒ¨å¯¹å…¬å…±å‰ç¼€çš„é¦–æ¬¡è®¡ç®—ï¼ˆè°ƒåº¦å™¨ä¸»åŠ¨æå–ï¼‰ æ˜¯å¦éœ€è¦å†å²è¯·æ±‚ï¼Ÿ âŒ ä¸éœ€è¦ï¼ˆè·¨ batch å…±äº«æ˜¯é¢å¤– bonusï¼‰ æ˜¯å¦ç ´åå¹¶è¡Œæ€§ï¼Ÿ âš ï¸ å…¬å…±å‰ç¼€è®¡ç®—æ˜¯ä¸²è¡Œçš„ï¼Œä½†åç¼€ä»å¯å¹¶è¡Œï¼Œæ•´ä½“ååä»å¤§å¹…æå‡ ğŸ’¡ æ‰€ä»¥ä½ çš„è§‚å¯Ÿå¾ˆæ•é”ï¼Œä½† vLLM é€šè¿‡ æ™ºèƒ½è°ƒåº¦ + Radix Tree + PagedAttention è§£å†³äº†è¿™ä¸ªâ€œé¸¡ç”Ÿè›‹â€é—®é¢˜ã€‚ è¿™æ­£æ˜¯ vLLM ç›¸æ¯”ä¼ ç»Ÿæ¨ç†å¼•æ“ï¼ˆå¦‚ HF Transformersï¼‰çš„å…ˆè¿›ä¹‹å¤„ï¼\nP04 rag-best-practices é¡¹ç›®åŸç†å’Œç»“æœ å‚è€ƒé¡¹ç›® chaoql/rag-best-practices: å¤§æ¨¡å‹æ£€ç´¢å¢å¼ºç”ŸæˆæŠ€æœ¯æœ€ä½³å®è·µã€‚\nQdrantçš„ä»£ç ç»„ç»‡éå¸¸ç³Ÿç³•ã€‚ QdrantVectorStore é‡Œé¢è¿˜å¥—äº†ä¸€ä¸ªfastembedæ¨¡å‹ã€‚ å¯¹äºæ¨¡å‹ä¸‹è½½æ¨¡å—çš„é—®é¢˜å®šä¹‰äº†ç‹¬ç«‹çš„ç¼“å­˜ç›®å½•ï¼Œä½†æ˜¯åˆå’Œhfçš„ç›®å½•æ··åˆ°äº†ä¸€å—ã€‚å¹¶ä¸”å‡½æ•°æ¥å£å†™å¾—å¾ˆä¸é€šç”¨ã€‚ æ‰€ä»¥æ”¾å¼ƒè¿™å—åŠŸèƒ½çš„è·‘é€šã€‚ åŸç† æ‰€è°“æ··åˆæ£€ç´¢å°±æ˜¯å¿«æ…¢ç»“åˆï¼Œfastembed(sparse embed) å’Œdenseembed HyDE Hypothetical Document Embeddingsï¼ˆHyDEï¼‰ æ˜¯ä¸€ç§æå‡æ£€ç´¢è´¨é‡çš„é«˜çº§åµŒå…¥æŠ€æœ¯ï¼Œç”± Gao et al. åœ¨ 2022 å¹´æå‡ºï¼ˆè®ºæ–‡ï¼šPrecise Zero-Shot Dense Retrieval without Relevance Labelsï¼‰ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š ä¸ç›´æ¥ç”¨ç”¨æˆ·æŸ¥è¯¢ï¼ˆqueryï¼‰å»æ£€ç´¢ï¼Œè€Œæ˜¯å…ˆè®©å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ç”Ÿæˆä¸€ä¸ªâ€œå‡è®¾æ€§ç­”æ¡ˆâ€ï¼ˆhypothetical documentï¼‰ï¼Œå†ç”¨è¿™ä¸ªå‡è®¾ç­”æ¡ˆçš„åµŒå…¥å‘é‡å»æ£€ç´¢çœŸå®æ–‡æ¡£ã€‚ è¿™ä¸ªé¡¹ç›®ä¸­çš„hybrid æ¨¡å¼çš„æ„æ€æ˜¯ï¼Œqueryç”Ÿæˆä¸€ä¸ªç¨€ç–å‘é‡ã€ä¸€ä¸ªç¨ å¯†å‘é‡ï¼Œä¸¤ç§åŒæ—¶è¯·æ±‚æ•°æ®åº“ï¼Œè€Œç¨€ç–å‘é‡å¯èƒ½æ˜¯æŒ‰ç…§ä¼ ç»Ÿå€’æ’ç´¢å¼•æ¥è¿›è¡Œç´¢å¼•æ„å»ºçš„ï¼Œå³æœ€ç»ˆæ—¢æœ‰ å€’æ’ç´¢å¼•æœç´¢ åˆæœ‰å‘é‡æœç´¢ã€‚ å½“ç„¶Qrant æœ¬èº«ä¹Ÿå…è®¸è¯·æ±‚å¸¦ filterï¼Œå³å…³é”®è¯æ£€ç´¢ã€ç±»åˆ«æ£€ç´¢ç­‰ã€‚ embedding æ¨¡å‹å¾®è°ƒè¿‡ç¨‹ å¯¹äºè¾“å…¥æ•°æ®æ–‡ä»¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®ï¼Œé€šè¿‡chatglmæ¨¡å‹ï¼Œæ„é€ promptï¼ˆå…¶ä¸­åŒ…å«ä¸€æ¡æ–‡æ¡£ï¼‰ï¼Œè¦æ±‚æ¨¡å‹è¿”å›ä¸€äº›å’Œä¸Šä¸‹æ–‡ç›¸å…³çš„é—®é¢˜ï¼Œå³å½¢æˆäº†Answer-Question å¯¹ã€‚ ç„¶ååè½¬A-Qå¯¹ï¼ˆæ˜ å°„å…³ç³»ä¸ºn-to-1ï¼‰ï¼Œæ„é€ å‡ºå¾®è°ƒæ•°æ®ã€‚ æ€»ä½“æ¥è¯´ï¼Œå°±æ˜¯ä¾èµ–ä¸€ä¸ªè¶…å¤§çš„chatå¤§æ¨¡å‹å’Œä¸€ä¸ªæ–‡æ¡£æ•°æ®é›†ï¼Œæ„é€ å‡ºQ-Aç›¸ä¼¼å¯¹ï¼Œè¿›è€Œå°†chatå¤§æ¨¡å‹çš„å¯¹è¯¥æ–‡æ¡£çš„ç›¸å…³çŸ¥è¯†ï¼ˆå¯¹æ–‡æ¡£æ•°æ®é›†é¢†åŸŸçš„çŸ¥è¯†ç†è§£æ›´é€å½»ã€æ›´ç²¾ç»†ï¼‰ å¾®è°ƒåˆ°ä¸€ä¸ªembå°æ¨¡å‹å†…ã€‚ æ¨¡å‹å¾®è°ƒä½¿ç”¨çš„æ˜¯llama-index ä¸­ embedding æ¨¡å‹å¾®è°ƒçš„åŠŸèƒ½ç±» llama_index.finetuning.embeddings.sentence_transformer.SentenceTransformersFinetuneEngineã€‚ å…¶ä¸­æŸå¤±å‡½æ•°æ˜¯ MultipleNegativesRankingLoss MultipleNegativesRankingLoss å¯¹äºæœ¬æ–‡çš„æ•°æ®å½¢å¼ å³ Q-Aå¯¹ï¼Œå³å°†Aè§†ä½œä¸€ä¸ªæ­£æ ·æœ¬ï¼ŒåŒæ—¶é‡‡æ · in-batchå†…çš„å…¶ä»–æ ·æœ¬ä½œä¸ºå¤šä¸ªè´Ÿæ ·æœ¬ï¼Œæ¥è®¡ç®—å‡ºä¸€ä¸ª Softmax Cross-Entropy Lossï¼Œç„¶åå†Qç»´åº¦ä¸Šå–å‡å€¼å³ä¸ºbatchæŸå¤±ã€‚ Configuring the Response Mode æ¨¡å‹ä¸‹è½½ HuggingfaceEmbedding ç±» å¦‚ä½•è§£å†³å¤–ç½‘ä¸å¯è®¿é—®çš„é—®é¢˜ã€‚ ä½¿ç”¨ modelscopeä¸‹è½½æ¨¡å‹ï¼Œç„¶ååˆ¶å®š HuggingfaceEmbeddingçš„æ¨¡å‹åŠ è½½è·¯å¾„ä¸º modelscopeç¼“å­˜ä¸­æ¨¡å‹çš„ç»å¯¹è·¯å¾„ã€‚ï¼ˆä¸æ˜¯æ¨¡å‹ç¼“å­˜çš„çˆ¶ç›®å½•ï¼Œè€Œæ˜¯å…·ä½“åˆ°ä¸€ä¸ªæ¨¡å‹çš„ç›®å½•ï¼‰ modelscopeä¸Šçš„æ¨¡å‹ä¸å…¨ï¼Œæœ‰äº›çŸ¥ååº¦ä¸é«˜çš„æ¨¡å‹ hfä¸Šæ¸¸ï¼Œä½†modelscopeä¸Šç¼ºå°‘ã€‚ æœåŠ¡å™¨ é˜¿é‡Œäº‘æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ modelscope æ¥è¿›è¡Œä¸‹è½½ï¼Œç„¶åç„¶åæ¨¡å‹åŠ è½½éƒ½ä½¿ç”¨ç»å¯¹è·¯å¾„æ¥åŠ è½½ã€‚ æœ¬åœ°å¼€å‘ å¯ä»¥ä½¿ç”¨ huggingface æ¥è¿›è¡Œä¸‹è½½å’Œç®¡ç†ã€‚ FlagEmbeddingReranker â€œFlagâ€ in FlagEmbeddingReranker = BAAIï¼ˆæ™ºæºç ”ç©¶é™¢ï¼‰çš„å¼€æºæ¨¡å‹å“ç‰Œæ ‡è¯†ï¼Œæ„ä¸ºâ€œæ——èˆ°çº§åµŒå…¥/é‡æ’æ¨¡å‹â€ï¼Œæ— ç‰¹æ®ŠæŠ€æœ¯å«ä¹‰ï¼Œä¸»è¦æ˜¯é¡¹ç›®å‘½åçš„ä¸€éƒ¨åˆ†ã€‚ modelscopeçš„æ¨¡å‹ç›®å½•æ¶æ„å’Œhuggingfaceçš„æ¨¡å‹ç›®å½•ç»“æ„ å·®å¼‚å¾ˆå¤§ï¼Œä¸èƒ½ç›´æ¥å¤ç”¨ã€‚æ‰€ä»¥å¦‚æœè¦åŠ è½½æœ¬åœ°æ¨¡å‹ï¼ŒåŠ¡å¿…ä½¿ç”¨æ¨¡å‹ç»å¯¹è·¯å¾„ã€‚ å·¥ç¨‹ Qdrant é«˜çº§è¿‡æ»¤èƒ½åŠ›ï¼š æ”¯æŒç»“åˆå‘é‡ç›¸ä¼¼æ€§æœç´¢å’Œä»»æ„ Payload ç»“æ„åŒ–æ•°æ®è¿‡æ»¤ï¼ˆç§°ä¸º Hybrid Searchï¼‰ã€‚ node_parser llama_index.core.node_parser.text.sentence_window.SentenceWindowNodeParser æŒ‰ç…§å¥å­è¿›è¡Œåˆ‡å‰²ï¼Œå¤šä¸ªå¥å­ä½œä¸ºä¸€ä¸ªç´¢å¼•æ–‡æ¡£ã€‚ Node Parser Modules | LlamaIndex Python Documentation pickleæ–¹å¼ä¸å®‰å…¨æ˜¯å› ä¸º __reduce__æ–¹æ³•ä¸­å¯ä»¥å®šä¹‰ä¸€ä¸ª æŒ‡ä»¤å­—èŠ‚æµï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥è§¦å‘å¯¹åº”æŒ‡ä»¤çš„æ‰§è¡Œã€‚ é—®é¢˜ï¼špytorch_model.bin å’Œ model.safetensors åˆ†åˆ«æ˜¯ä»€ä¹ˆ pytorch_model.bin å’Œ model.safetensors æ˜¯ä¸¤ç§å¸¸è§çš„ç”¨äºå­˜å‚¨æ·±åº¦å­¦ä¹ æ¨¡å‹æƒé‡ï¼ˆå‚æ•°ï¼‰çš„æ–‡ä»¶æ ¼å¼ï¼Œå¹¿æ³›ç”¨äº Hugging Face Transformers ç­‰ç”Ÿæ€ä¸­ã€‚å®ƒä»¬çš„æ ¸å¿ƒç›®çš„ç›¸åŒï¼šä¿å­˜ç¥ç»ç½‘ç»œçš„å¯è®­ç»ƒå‚æ•°ï¼Œä½†åœ¨è®¾è®¡å“²å­¦ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå…¼å®¹æ€§æ–¹é¢æœ‰æ˜¾è‘—åŒºåˆ«ã€‚\n1. pytorch_model.bin\næ˜¯ä»€ä¹ˆï¼Ÿ\nè¿™æ˜¯ PyTorch åŸç”Ÿçš„æ¨¡å‹æƒé‡ä¿å­˜æ ¼å¼ã€‚ æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€šè¿‡ torch.save() ä¿å­˜çš„ Python pickle æ–‡ä»¶ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ªå­—å…¸ï¼Œé”®ä¸ºå‚æ•°åï¼ˆå¦‚ \"transformer.h.0.attn.c_attn.weight\"ï¼‰ï¼Œå€¼ä¸ºå¯¹åº”çš„ torch.Tensorã€‚ ç‰¹ç‚¹ï¼š\næ–¹é¢ è¯´æ˜ æ ¼å¼ åŸºäº Python çš„ pickle åºåˆ—åŒ– å…¼å®¹æ€§ åªèƒ½åœ¨ PyTorch ç¯å¢ƒä¸­åŠ è½½ï¼ˆéœ€åŒ¹é…ç‰ˆæœ¬ï¼‰ å®‰å…¨æ€§ â— ä¸å®‰å…¨ï¼špickle å¯æ‰§è¡Œä»»æ„ä»£ç ï¼ŒåŠ è½½ä¸å—ä¿¡ä»»çš„ .bin æ–‡ä»¶å¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰æ¼æ´ é€Ÿåº¦ åŠ è½½/ä¿å­˜è¾ƒå¿«ï¼Œä½†ä¾èµ– Python ååºåˆ—åŒ– è·¨è¯­è¨€ ä¸æ”¯æŒï¼ˆå¼ºä¾èµ– Python å’Œ PyTorchï¼‰ å…¸å‹ç”¨é€” Hugging Face æ¨¡å‹ä»“åº“ä¸­çš„é»˜è®¤æƒé‡æ ¼å¼ï¼ˆå°¤å…¶æ—§æ¨¡å‹ï¼‰ ç¤ºä¾‹åŠ è½½æ–¹å¼ï¼š\nimport torch state_dict = torch.load(\"pytorch_model.bin\", map_location=\"cpu\") model.load_state_dict(state_dict) âš ï¸ è­¦å‘Šï¼šæ°¸è¿œä¸è¦åŠ è½½æ¥è‡ªä¸å¯ä¿¡æ¥æºçš„ pytorch_model.binï¼\n2. model.safetensors\næ˜¯ä»€ä¹ˆï¼Ÿ\nç”± Hugging Face å’Œ CarperAI è”åˆå¼€å‘çš„ä¸€ç§å®‰å…¨ã€å¿«é€Ÿã€æ¡†æ¶æ— å…³çš„æ¨¡å‹æƒé‡å­˜å‚¨æ ¼å¼ã€‚ ä¸ä½¿ç”¨ pickleï¼Œè€Œæ˜¯å°†å¼ é‡æ•°æ®ä»¥åŸå§‹äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨ï¼Œå¹¶é™„å¸¦ JSON å…ƒæ•°æ®æè¿°å¼ é‡ç»“æ„ã€‚ ç‰¹ç‚¹ï¼š\næ–¹é¢ è¯´æ˜ æ ¼å¼ è‡ªå®šä¹‰äºŒè¿›åˆ¶æ ¼å¼ + JSON headerï¼ˆæ— ä»£ç æ‰§è¡Œï¼‰ å®‰å…¨æ€§ âœ… å®‰å…¨ï¼šä»…åŒ…å«æ•°å€¼æ•°æ®ï¼Œæ— æ³•æ‰§è¡Œä»»æ„ä»£ç  é€Ÿåº¦ åŠ è½½é€šå¸¸æ¯” .bin æ›´å¿«ï¼ˆå°¤å…¶å¤§æ¨¡å‹ï¼‰ï¼Œæ”¯æŒå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰ è·¨æ¡†æ¶ æ”¯æŒ PyTorchã€TensorFlowã€Flaxã€JAX ç­‰ï¼ˆåªè¦èƒ½è¯»å– NumPy-like å¼ é‡ï¼‰ æ–‡ä»¶å¤§å° ä¸ .bin å‡ ä¹ç›¸åŒï¼ˆæœªå‹ç¼©ï¼Œä½†å¯é€‰ gzipï¼‰ å…¸å‹ç”¨é€” Hugging Face æ–°æ¨¡å‹æ¨èæ ¼å¼ï¼Œå°¤å…¶åœ¨å…¬å¼€åˆ†äº«æˆ– Web æœåŠ¡ä¸­ æ–‡ä»¶ç»“æ„ç®€è¿°ï¼š\n[JSON metadata header (UTF-8, padded to 8-byte align)] { \"weight1\": {\"dtype\": \"F32\", \"shape\": [1024, 1024], \"data_offsets\": [0, 4194304]}, \"weight2\": {\"dtype\": \"F16\", \"shape\": [512], \"data_offsets\": [4194304, 4195328]} } [Raw binary tensor data (concatenated)] ç¤ºä¾‹åŠ è½½æ–¹å¼ï¼ˆPyTorchï¼‰ï¼š\nfrom safetensors.torch import load_file state_dict = load_file(\"model.safetensors\", device=\"cpu\") model.load_state_dict(state_dict) å¯¹æ¯”æ€»ç»“\nç‰¹æ€§ pytorch_model.bin model.safetensors åº•å±‚æœºåˆ¶ Python pickle è‡ªå®šä¹‰äºŒè¿›åˆ¶ + JSON å®‰å…¨æ€§ âŒ å±é™©ï¼ˆå¯æ‰§è¡Œä»£ç ï¼‰ âœ… å®‰å…¨ï¼ˆçº¯æ•°æ®ï¼‰ åŠ è½½é€Ÿåº¦ å¿« é€šå¸¸æ›´å¿«ï¼ˆæ”¯æŒ mmapï¼‰ è·¨å¹³å°/è¯­è¨€ å¦ï¼ˆPyTorch + Pythonï¼‰ æ˜¯ï¼ˆå¤šæ¡†æ¶æ”¯æŒï¼‰ Hugging Face æ¨è æ—§æ¨¡å‹é»˜è®¤ æ–°æ¨¡å‹é¦–é€‰ æ–‡ä»¶æ‰©å±•å .bin .safetensors å®é™…å»ºè®®\nâœ… ä¼˜å…ˆä½¿ç”¨ .safetensorsï¼šå°¤å…¶å½“ä½ ä»ç½‘ä¸Šä¸‹è½½æ¨¡å‹ã€éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæˆ–æä¾› API æœåŠ¡æ—¶ã€‚ ğŸ”’ é¿å…åŠ è½½æœªçŸ¥æ¥æºçš„ .bin æ–‡ä»¶ï¼šé™¤éä½ å®Œå…¨ä¿¡ä»»æä¾›è€…ã€‚ ğŸ”„ å¾ˆå¤šæ¨¡å‹ä»“åº“åŒæ—¶æä¾›ä¸¤ç§æ ¼å¼ï¼ˆå¦‚ Llama 3ã€Mistralï¼‰ï¼Œä½ å¯ä»¥è‡ªç”±é€‰æ‹©ã€‚ ğŸ› ï¸ å¯ç”¨å·¥å…·è½¬æ¢ï¼š # ä½¿ç”¨ Hugging Face transformers è‡ªåŠ¨è½¬æ¢ from transformers import AutoModel model = AutoModel.from_pretrained(\"your-model\", use_safetensors=True) # è‡ªåŠ¨ä¼˜å…ˆåŠ è½½ .safetensors å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªéœ€è¦åŠ è½½å¤–éƒ¨æ¨¡å‹çš„åº”ç”¨ï¼ˆå¦‚ Web UIã€æ¨ç†æœåŠ¡ï¼‰ï¼Œå¼ºçƒˆå»ºè®®åªæ”¯æŒ .safetensors æ ¼å¼ä»¥è§„é¿å®‰å…¨é£é™©ã€‚\né—®é¢˜ï¼šSparse text embeddings å’Œ dense text embeddings çš„åŒºåˆ« Sparse text embeddings å’Œ dense text embeddings æ˜¯ä¸¤ç§ä¸åŒçš„æ–‡æœ¬è¡¨ç¤ºæ–¹æ³•ï¼Œå®ƒä»¬åœ¨ç»“æ„ã€ç”Ÿæˆæ–¹å¼ã€åº”ç”¨åœºæ™¯å’Œæ€§èƒ½ç‰¹ç‚¹ä¸Šæœ‰æ˜¾è‘—åŒºåˆ«ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†å¯¹æ¯”ï¼š\nä¸€ã€æ ¸å¿ƒå®šä¹‰\nç±»å‹ å®šä¹‰ Dense Embeddingsï¼ˆç¨ å¯†åµŒå…¥ï¼‰ å°†æ–‡æœ¬æ˜ å°„ä¸ºä¸€ä¸ªä½ç»´ï¼ˆé€šå¸¸å‡ ç™¾åˆ°å‡ åƒç»´ï¼‰ã€è¿ç»­ã€ç¨ å¯†çš„å®æ•°å‘é‡ï¼Œå‡ ä¹æ‰€æœ‰ç»´åº¦éƒ½æœ‰éé›¶å€¼ã€‚ Sparse Embeddingsï¼ˆç¨€ç–åµŒå…¥ï¼‰ å°†æ–‡æœ¬è¡¨ç¤ºä¸ºä¸€ä¸ªé«˜ç»´ï¼ˆå¯èƒ½æ•°ä¸‡åˆ°ç™¾ä¸‡ç»´ï¼‰ã€ç¦»æ•£ã€ç¨€ç–çš„å‘é‡ï¼Œç»å¤§å¤šæ•°ç»´åº¦ä¸º 0ï¼Œåªæœ‰å°‘æ•°ç»´åº¦æœ‰éé›¶å€¼ï¼ˆé€šå¸¸æ˜¯æ­£æƒé‡ï¼‰ã€‚ äºŒã€å…¸å‹ä»£è¡¨\nç±»å‹ æ¨¡å‹/æ–¹æ³•ç¤ºä¾‹ Dense - BERT, RoBERTa - Sentence-BERT (SBERT) - BGE (BAAI General Embedding) - OpenAI Embeddings - Cohere Embeddings Sparse - BM25ï¼ˆä¼ ç»Ÿï¼Œéå­¦ä¹ å‹ï¼‰ - SPLADE - uniCOIL - DeepImpact - ColBERTï¼ˆéƒ¨åˆ†ç¨€ç–ï¼Œå¸¦åæœŸäº¤äº’ï¼‰ ğŸ’¡ æ³¨æ„ï¼šBM25 è™½ç„¶å¸¸è¢«å½’ä¸ºâ€œç¨€ç–æ£€ç´¢â€ï¼Œä½†å®ƒä¸æ˜¯â€œembedding æ¨¡å‹â€ï¼ˆæ— ç¥ç»ç½‘ç»œï¼‰ï¼Œè€Œ SPLADE ç­‰æ˜¯åŸºäºæ·±åº¦å­¦ä¹ çš„ç¨€ç– embedding æ¨¡å‹ã€‚\nä¸‰ã€ç»“æ„å¯¹æ¯”ï¼ˆä¸¾ä¾‹ï¼‰ å‡è®¾è¯æ±‡è¡¨å¤§å°ä¸º 30,000ï¼š\nSparse embeddingï¼ˆå¦‚ SPLADEï¼‰ï¼š [0, 0, 0, ..., 2.1, 0, 0, ..., 0.8, ..., 0] # é•¿åº¦=30,000ï¼Œä»…å‡ åä¸ªéé›¶å€¼ â†’ æ¯ä¸ªéé›¶ä½ç½®å¯¹åº”ä¸€ä¸ªè¯ï¼ˆå¦‚ â€œappleâ€ åœ¨ç´¢å¼• 12345ï¼‰ï¼Œå€¼è¡¨ç¤ºé‡è¦æ€§ã€‚ Dense embeddingï¼ˆå¦‚ BGEï¼‰ï¼š [0.23, -0.41, 0.88, ..., 0.05] # é•¿åº¦=1024ï¼Œå‡ ä¹æ¯ä¸ªå€¼éƒ½éé›¶ â†’ å‘é‡ç»´åº¦ä¸è¯æ±‡è¡¨æ— å…³ï¼Œè¯­ä¹‰ä¿¡æ¯åˆ†å¸ƒåœ¨æ•´ä¸ªå‘é‡ä¸­ã€‚ å››ã€å…³é”®åŒºåˆ«æ€»ç»“\nç»´åº¦ Sparse Embeddings Dense Embeddings ç»´åº¦ é«˜ç»´ï¼ˆâ‰ˆè¯æ±‡è¡¨å¤§å°ï¼Œå¦‚ 30kâ€“1Mï¼‰ ä½ç»´ï¼ˆé€šå¸¸ 384â€“4096ï¼‰ éé›¶å…ƒç´  æå°‘ï¼ˆ\u003c 100 ä¸ªï¼‰ å‡ ä¹å…¨éƒ¨éé›¶ å¯è§£é‡Šæ€§ âœ… é«˜ï¼ˆæ¯ä¸ªéé›¶ç»´å¯¹åº”ä¸€ä¸ªè¯ï¼‰ âŒ ä½ï¼ˆè¯­ä¹‰åˆ†å¸ƒåœ¨éšç©ºé—´ï¼‰ å­˜å‚¨æ•ˆç‡ âœ… é«˜ï¼ˆå¯ç”¨å€’æ’ç´¢å¼•å‹ç¼©å­˜å‚¨ï¼‰ âš ï¸ ä¸­ç­‰ï¼ˆéœ€å­˜å‚¨å®Œæ•´æµ®ç‚¹æ•°ç»„ï¼‰ æ£€ç´¢æ–¹å¼ å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰ + TF-IDF/BM25 é£æ ¼æ‰“åˆ† å‘é‡ç›¸ä¼¼åº¦ï¼ˆå¦‚ä½™å¼¦ã€å†…ç§¯ï¼‰+ ANNï¼ˆå¦‚ FAISS, HNSWï¼‰ è®­ç»ƒç›®æ ‡ ä¼˜åŒ–è¯çº§é‡è¦æ€§ï¼ˆå¦‚é€šè¿‡ KL æ•£åº¦å¯¹é½ BM25ï¼‰ ä¼˜åŒ–å¥å­/æ®µè½çº§è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆå¦‚å¯¹æ¯”å­¦ä¹ ï¼‰ å¤šè¯­è¨€æ”¯æŒ ä¾èµ–è¯æ±‡è¡¨ï¼Œè·¨è¯­è¨€è¾ƒéš¾ æ›´å®¹æ˜“é€šè¿‡å…±äº«è¯­ä¹‰ç©ºé—´å®ç° ç¡¬ä»¶åŠ é€Ÿ CPU å‹å¥½ï¼Œé€‚åˆå¤§è§„æ¨¡æ–‡æ¡£åº“ GPU/ANN åŠ é€Ÿæ•ˆæœæ›´å¥½ äº”ã€åº”ç”¨åœºæ™¯\nâœ… Sparse æ›´é€‚åˆï¼š\nå¤§è§„æ¨¡æ–‡æ¡£æ£€ç´¢ï¼ˆå¦‚æœç´¢å¼•æ“ï¼‰ï¼š==åˆ©ç”¨æˆç†Ÿçš„å€’æ’ç´¢å¼•æŠ€æœ¯==ï¼Œé«˜æ•ˆè¿‡æ»¤æµ·é‡æ–‡æ¡£ã€‚ å…³é”®è¯æ•æ„Ÿä»»åŠ¡ï¼šéœ€è¦ç²¾ç¡®åŒ¹é…æœ¯è¯­ï¼ˆå¦‚æ³•å¾‹ã€åŒ»ç–—æ£€ç´¢ï¼‰ã€‚ èµ„æºå—é™ç¯å¢ƒï¼šæ— éœ€ GPUï¼Œçº¯ CPU å³å¯é«˜æ•ˆè¿è¡Œã€‚ âœ… Dense æ›´é€‚åˆï¼š\nè¯­ä¹‰ç›¸ä¼¼åº¦ä»»åŠ¡ï¼šç†è§£åŒä¹‰ã€ paraphraseã€ä¸Šä¸‹æ–‡å«ä¹‰ï¼ˆå¦‚ â€œcarâ€ â‰ˆ â€œautomobileâ€ï¼‰ã€‚ å°æ ·æœ¬æˆ– zero-shot åœºæ™¯ï¼šæ³›åŒ–èƒ½åŠ›å¼ºã€‚ RAG ç³»ç»Ÿä¸­çš„ç²¾æ’ï¼šä¸ LLM ç»“åˆæ•ˆæœå¥½ã€‚ å…­ã€æ··åˆæ–¹æ³•ï¼ˆHybrid Retrievalï¼‰ ç°ä»£ç³»ç»Ÿå¸¸ç»“åˆä¸¤è€…ä¼˜åŠ¿ï¼š\nQuery â†’ [Sparse Retriever (BM25/SPLADE)] â†’ Top K candidates + [Dense Retriever (BGE)] â†’ Top K candidates â†’ åˆå¹¶å»é‡ â†’ Reranker (e.g., BGE-reranker) ColBERTï¼šè™½è¾“å‡ºç¨ å¯† token å‘é‡ï¼Œä½†é€šè¿‡ MaxSim å®ç°ç±»ä¼¼ç¨€ç–çš„ç»†ç²’åº¦åŒ¹é…ã€‚ BGE-M3ï¼ˆBAAI æœ€æ–°æ¨¡å‹ï¼‰ï¼šåŒæ—¶è¾“å‡º denseã€sparse å’Œ multi-vector è¡¨ç¤ºï¼Œæ”¯æŒç»Ÿä¸€æ£€ç´¢ã€‚ ä¸ƒã€å¯è§†åŒ–æ¯”å–»\nSparseï¼šåƒä¸€æœ¬ç´¢å¼•ç›®å½•â€”â€”åªåˆ—å‡ºå…³é”®è¯åŠå…¶é¡µç ï¼ˆä½ç½®+æƒé‡ï¼‰ã€‚ Denseï¼šåƒä¸€å¹…æŠ½è±¡ç”»â€”â€”æ•´ä½“è¡¨è¾¾è¯­ä¹‰ï¼Œæ— æ³•æ‹†è§£å•ä¸ªå…ƒç´ å«ä¹‰ã€‚ æ€»ç»“ä¸€å¥è¯ï¼š\nSparse embeddings = å…³é”®è¯åŠ æƒï¼ˆå¯è§£é‡Šã€é«˜æ•ˆï¼‰ï¼›Dense embeddings = è¯­ä¹‰å‹ç¼©ï¼ˆæ³›åŒ–å¼ºã€éœ€å‘é‡æ£€ç´¢ï¼‰ã€‚ æ ¹æ®ä½ çš„ä»»åŠ¡éœ€æ±‚ï¼ˆç²¾åº¦ vs æ•ˆç‡ã€å…³é”®è¯åŒ¹é… vs è¯­ä¹‰ç†è§£ï¼‰ï¼Œå¯ä»¥é€‰æ‹©åˆé€‚ç±»å‹ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ hybrid æ–¹æ¡ˆè·å¾—æœ€ä½³æ•ˆæœã€‚\né—®é¢˜ï¼šSparse Embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ° è¾“å‡ºç¨€ç–å‘é‡çš„ è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Sparse Embeddings æ¨¡å‹ï¼ˆå¦‚ SPLADEã€uniCOILã€DeepImpact ç­‰ï¼‰ä¹‹æ‰€ä»¥èƒ½è¾“å‡ºâ€œç¨€ç–ä½†æœ‰ä¿¡æ¯é‡â€çš„å‘é‡ï¼Œå…³é”®åœ¨äºå®ƒä»¬é€šè¿‡ç¥ç»ç½‘ç»œå­¦ä¹ æ¯ä¸ªè¯é¡¹ï¼ˆtermï¼‰çš„é‡è¦æ€§æƒé‡ï¼Œå¹¶å¼ºåˆ¶ç»å¤§å¤šæ•°æƒé‡ä¸ºé›¶æˆ–æ¥è¿‘é›¶ã€‚ä¸‹é¢ä»åŸç†ã€æŠ€æœ¯æ‰‹æ®µå’Œè®­ç»ƒç›®æ ‡ä¸‰ä¸ªæ–¹é¢è¯¦ç»†è§£é‡Šï¼š\nä¸€ã€æ ¸å¿ƒæ€æƒ³ï¼šå°†æ–‡æœ¬æ˜ å°„åˆ°â€œè¯æ±‡è¡¨ç»´åº¦â€çš„ç¨€ç–å‘é‡ ä¸ dense embedding è¾“å‡ºä¸€ä¸ªå›ºå®šä½ç»´å‘é‡ä¸åŒï¼Œsparse embedding æ¨¡å‹çš„è¾“å‡ºç»´åº¦ = è¯æ±‡è¡¨å¤§å°ï¼ˆVï¼‰ï¼ˆä¾‹å¦‚ V = 30,000ï¼‰ã€‚\nå¯¹äºè¾“å…¥æ–‡æœ¬ï¼Œæ¨¡å‹ä¼šä¸ºè¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªè¯ $w_i$ é¢„æµ‹ä¸€ä¸ª éè´Ÿé‡è¦æ€§åˆ†æ•° $s_i \\geq 0$ï¼Œæœ€ç»ˆè¾“å‡ºå‘é‡ä¸ºï¼š $$ \\mathbf{e} = [s_1, s_2, â€¦, s_V] $$ å…¶ä¸­ ç»å¤§å¤šæ•° $s_i = 0$ï¼Œåªæœ‰å°‘æ•°å…³é”®è¯çš„ $s_i \u003e 0$ï¼Œå½¢æˆç¨€ç–è¡¨ç¤ºã€‚\nâœ… è¿™ä¸ªå‘é‡å¯ä»¥ç›´æ¥ç”¨äº å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰æ£€ç´¢ï¼Œå°±åƒ BM25 ä¸€æ ·é«˜æ•ˆã€‚\näºŒã€å¦‚ä½•å®ç°â€œç¨€ç–æ€§â€ï¼Ÿå…³é”®æŠ€æœ¯æ‰‹æ®µ\n1. ä½¿ç”¨å¸¦ç¨€ç–è¯±å¯¼çš„æ¿€æ´»å‡½æ•° æœ€å¸¸ç”¨çš„æ˜¯ ReLU + å¯¹æ•°å˜æ¢ + FLOPS æ­£åˆ™åŒ–ï¼ˆä»¥ SPLADE ä¸ºä»£è¡¨ï¼‰ï¼š\nï¼ˆ1ï¼‰åŸºäº BERT çš„ token-level logits\nè¾“å…¥æ–‡æœ¬ â†’ BERT ç¼–ç å™¨ â†’ å¾—åˆ°æ¯ä¸ª token çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚ é€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚ï¼ˆæˆ– MLM headï¼‰é¢„æµ‹ æ•´ä¸ªè¯æ±‡è¡¨ä¸Šæ¯ä¸ªè¯çš„ logitsï¼ˆç±»ä¼¼æ©ç è¯­è¨€å»ºæ¨¡ï¼‰ã€‚ ï¼ˆ2ï¼‰åº”ç”¨ $\\text{ReLU}(\\log(1 + \\exp(x)))$ æˆ–ç›´æ¥ $\\text{F}(x) = \\max(0, x)$\nå°† logits ç»è¿‡ éè´Ÿæ¿€æ´»ï¼Œç¡®ä¿è¾“å‡º â‰¥ 0ã€‚ å®é™…ä¸­å¸¸ç”¨ï¼š\n$$s_i = \\text{ReLU}\\left( \\text{MLM logits}_i \\right)$$ æˆ–æ›´å¹³æ»‘çš„ï¼š $$ s_i = \\log\\left(1 + \\exp(\\text{MLM logits}_i)\\right) \\quad \\text{(softplus)} $$ ğŸ“Œ æ³¨æ„ï¼šå³ä½¿ logits æ˜¯ç¨ å¯†çš„ï¼Œåç»­ä¼šé€šè¿‡æ­£åˆ™åŒ–è®©å¤§å¤šæ•° $s_i \\to 0$ã€‚\n2. å¼•å…¥ç¨€ç–æ€§æ­£åˆ™åŒ–ï¼ˆSparsity Regularizationï¼‰ è¿™æ˜¯å®ç°â€œçœŸæ­£ç¨€ç–â€çš„å…³é”®ï¼æ¨¡å‹åœ¨è®­ç»ƒæ—¶ä¼šæƒ©ç½šéé›¶å…ƒç´ çš„æ•°é‡æˆ–å¤§å°ã€‚\nå¸¸è§æ­£åˆ™é¡¹ï¼ˆåŠ åœ¨ loss ä¸­ï¼‰ï¼š\nL1 æ­£åˆ™åŒ–ï¼š$\\lambda \\sum_i |s_i|$\nâ†’ é¼“åŠ±æƒé‡è¶‹è¿‘äº 0ã€‚ FLOPS æ­£åˆ™åŒ–ï¼ˆSPLADE æå‡ºï¼‰ï¼š\n$$ \\mathcal{L}_{\\text{flops}} = \\left( \\frac{1}{V} \\sum_i \\mathbb{E}[s_i] \\right)^2 $$ â†’ æƒ©ç½šå¹³å‡æ¿€æ´»å¼ºåº¦ï¼Œä¿ƒä½¿æ¨¡å‹åªæ¿€æ´»æå°‘æ•°è¯ã€‚ Group Lasso / Top-k çº¦æŸï¼šå¼ºåˆ¶åªä¿ç•™ top-k ä¸ªæœ€å¤§æƒé‡ã€‚ ğŸ’¡ è®­ç»ƒå®Œæˆåï¼Œæ¨ç†æ—¶å¯è®¾ç½®é˜ˆå€¼ï¼ˆå¦‚ $s_i \u003c 1e-4$ åˆ™ç½® 0ï¼‰ï¼Œè¿›ä¸€æ­¥æå‡ç¨€ç–åº¦ã€‚\n3. åˆ©ç”¨é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„ MLM Head\nSPLADE ç­‰æ¨¡å‹ç›´æ¥å¤ç”¨ BERT çš„ Masked Language Model (MLM) å¤´ã€‚ MLM å¤´æœ¬æ¥å°±èƒ½é¢„æµ‹â€œå“ªäº›è¯å¯èƒ½å‡ºç°åœ¨ä¸Šä¸‹æ–‡ä¸­â€ï¼Œå¤©ç„¶å…·æœ‰è¯çº§è¯­ä¹‰æ„ŸçŸ¥èƒ½åŠ›ã€‚ é€šè¿‡å¾®è°ƒ MLM å¤´ï¼Œä½¿å…¶è¾“å‡ºçš„ logits ä¸å†ç”¨äºé¢„æµ‹è¢«é®ç›–è¯ï¼Œè€Œæ˜¯ä½œä¸ºå…¨æ–‡çš„è¯é‡è¦æ€§åˆ†å¸ƒã€‚ âœ… è¿™æ ·æ—¢åˆ©ç”¨äº†é¢„è®­ç»ƒçŸ¥è¯†ï¼Œåˆå®ç°äº†ç«¯åˆ°ç«¯çš„ç¨€ç–è¡¨ç¤ºå­¦ä¹ ã€‚\nä¸‰ã€è®­ç»ƒç›®æ ‡ï¼šå¯¹é½ç›¸å…³æ€§ä¿¡å· ä¸ºäº†è®©ç¨€ç–å‘é‡â€œæœ‰ä¿¡æ¯é‡â€ï¼ˆå³èƒ½æœ‰æ•ˆæ’åºç›¸å…³æ–‡æ¡£ï¼‰ï¼Œæ¨¡å‹é€šå¸¸é‡‡ç”¨ä»¥ä¸‹ç›‘ç£ä¿¡å·ï¼š\næ–¹æ³• è®­ç»ƒç›®æ ‡ SPLADE æœ€å¤§åŒ–æŸ¥è¯¢-æ­£æ ·æœ¬æ–‡æ¡£çš„ç›¸ä¼¼åº¦ï¼ˆå†…ç§¯ï¼‰ï¼Œæœ€å°åŒ–æŸ¥è¯¢-è´Ÿæ ·æœ¬çš„ç›¸ä¼¼åº¦ + ç¨€ç–æ­£åˆ™ DeepImpact / uniCOIL å›å½’åˆ°ä¼ªæ ‡ç­¾ï¼ˆå¦‚ BM25 åˆ†æ•°ã€æ•™å¸ˆæ¨¡å‹æ‰“åˆ†ï¼‰ æ— ç›‘ç£ SPLADE ä½¿ç”¨å¯¹æ¯”å­¦ä¹ æˆ–è‡ªç›‘ç£ï¼ˆå¦‚æ–‡æ¡£-æ ‡é¢˜å¯¹ï¼‰ ç›¸ä¼¼åº¦è®¡ç®—æ–¹å¼ï¼š $$ \\text{score}(q, d) = \\sum_{i=1}^V \\text{ReLU}(q_i) \\cdot \\text{ReLU}(d_i) $$ â†’ æœ¬è´¨æ˜¯ åŠ æƒè¯é‡å ï¼ˆWeighted Term Matchingï¼‰ï¼Œä½†æƒé‡ç”±ç¥ç»ç½‘ç»œå­¦ä¹ å¾—åˆ°ï¼Œæ¯” TF-IDF/BM25 æ›´æ™ºèƒ½ã€‚ å››ã€ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼šSPLADE å¦‚ä½•å·¥ä½œï¼Ÿ\nè¾“å…¥æŸ¥è¯¢ \"How to bake a cake?\" ç»è¿‡ BERT + MLM head â†’ è¾“å‡º 30,000 ç»´ logits åº”ç”¨ $\\text{ReLU}(\\cdot)$ â†’ å¾—åˆ°éè´Ÿåˆ†æ•° åŠ å…¥ FLOPS æ­£åˆ™ â†’ æ¨¡å‹å­¦ä¼šåªç»™ \"bake\", \"cake\", \"recipe\" ç­‰è¯é«˜åˆ†ï¼Œå…¶ä½™ä¸º 0 æœ€ç»ˆè¾“å‡ºç¨€ç–å‘é‡ï¼šä»…å‡ åä¸ªéé›¶å€¼ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªå…³é”®è¯åŠå…¶è¯­ä¹‰é‡è¦æ€§ ğŸ” æ£€ç´¢æ—¶ï¼š æ–‡æ¡£ä¹Ÿç”¨åŒæ ·æ–¹å¼ç¼–ç æˆç¨€ç–å‘é‡ é€šè¿‡å€’æ’ç´¢å¼•å¿«é€Ÿè®¡ç®—å†…ç§¯å¾—åˆ†ï¼ˆåªè®¡ç®—éé›¶ç»´åº¦äº¤é›†ï¼‰ äº”ã€ä¸ºä»€ä¹ˆå«â€œå“äº®â€ï¼ˆinformativeï¼‰ï¼Ÿ\nè™½ç„¶ç¨€ç–ï¼Œä½†éé›¶ç»´åº¦æ˜¯æ¨¡å‹ç²¾å¿ƒæŒ‘é€‰çš„å…³é”®è¯ï¼Œä¸”æƒé‡åæ˜ å…¶åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„è¯­ä¹‰é‡è¦æ€§ã€‚ ç›¸æ¯” BM25 çš„é™æ€ TF-IDFï¼Œsparse embedding èƒ½ï¼š ç†è§£åŒä¹‰è¯ï¼ˆâ€œcarâ€ â†’ æ¿€æ´» â€œautomobileâ€ï¼‰ æŠ‘åˆ¶åœç”¨è¯ï¼ˆâ€œtheâ€, â€œhowâ€ æƒé‡â‰ˆ0ï¼‰ æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´ï¼ˆâ€œappleâ€ åœ¨ç§‘æŠ€ vs æ°´æœè¯­å¢ƒä¸‹æ¿€æ´»ä¸åŒè¯ï¼‰ æ€»ç»“\nå…³é”®ç‚¹ è¯´æ˜ è¾“å‡ºç»´åº¦ = è¯æ±‡è¡¨å¤§å°ï¼ˆé«˜ç»´ï¼‰ ç¨€ç–æ€§æ¥æº ReLU/Softplus æ¿€æ´» + L1/FLOPS æ­£åˆ™åŒ– ä¿¡æ¯é‡æ¥æº åŸºäºé¢„è®­ç»ƒ MLM å¤´ + ç›¸å…³æ€§ç›‘ç£å­¦ä¹  æ£€ç´¢å…¼å®¹æ€§ å®Œå…¨å…¼å®¹ä¼ ç»Ÿå€’æ’ç´¢å¼•ç³»ç»Ÿï¼ˆå¦‚ Lucene, Elasticsearchï¼‰ ä»£è¡¨æ¨¡å‹ SPLADEï¼ˆæœ€ç»å…¸ï¼‰ã€uniCOILã€DeepImpactã€BGE-M3ï¼ˆæ”¯æŒ sparse è¾“å‡ºï¼‰ âœ… æ‰€ä»¥ï¼Œâ€œç¨€ç–ä½†å“äº®â€ = åªä¿ç•™æœ€å…³é”®çš„å‡ ä¸ªè¯ï¼Œä½†æ¯ä¸ªè¯çš„æƒé‡éƒ½ç»è¿‡æ·±åº¦è¯­ä¹‰ç†è§£ä¼˜åŒ–ã€‚ å¦‚æœä½ æ­£åœ¨æ„å»ºæ£€ç´¢ç³»ç»Ÿï¼Œsparse embeddings èƒ½è®©ä½ åœ¨ä¸ç‰ºç‰²å¤ªå¤šè¯­ä¹‰èƒ½åŠ›çš„å‰æä¸‹ï¼Œäº«å—ä¼ ç»Ÿæœç´¢å¼•æ“çš„é«˜æ•ˆä¸å¯æ‰©å±•æ€§ã€‚\nå…¶ä»–é—®é¢˜ é—®é¢˜ï¼šlangchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„ åœ¨ langchain ä¸­ï¼Œç«–çº¿è¿ç®—ç¬¦ï¼ˆ|ï¼‰çš„å®ç°ä¸»è¦ä¾èµ–äºä»¥ä¸‹æ–¹æ³•ï¼š\næ ¸å¿ƒå®ç°æ–¹æ³•\n__or__ æ–¹æ³• è¿™æ˜¯ Python ä¸­å®ç°ç«–çº¿è¿ç®—ç¬¦çš„æ ¸å¿ƒé­”æœ¯æ–¹æ³• å½“ä½¿ç”¨ a | b è¯­æ³•æ—¶ï¼ŒPython ä¼šè°ƒç”¨ a.__or__(b) __ror__ æ–¹æ³• å³ä¾§å¯¹è±¡çš„åå‘æˆ–è¿ç®—æ–¹æ³• å½“å·¦ä¾§å¯¹è±¡æ²¡æœ‰å®ç° __or__ æ—¶è°ƒç”¨ åœ¨ Langchain ä¸­çš„åº”ç”¨ åœ¨ä½ çš„ä»£ç ä¸­ prompt|llm|output_parser è¿™ä¸ªé“¾æ¡ä¸­ï¼š\npromptï¼ˆChatPromptTemplate å¯¹è±¡ï¼‰å®ç°äº† __or__ æ–¹æ³• llmï¼ˆChatOpenAI å¯¹è±¡ï¼‰ä¹Ÿå®ç°äº† __or__ æ–¹æ³• output_parserï¼ˆStrOutputParser å¯¹è±¡ï¼‰åŒæ ·æ”¯æŒé“¾å¼æ“ä½œ å®ç°æœºåˆ¶\n**ä¼ªä»£ç ç¤ºä¾‹** class BaseComponent: def __or__(self, other): return Chain(self, other) è¿™ç§è®¾è®¡æ¨¡å¼å…è®¸ä¸åŒçš„ langchain ç»„ä»¶ï¼ˆå¦‚ promptã€llmã€output_parserï¼‰é€šè¿‡ç«–çº¿è¿ç®—ç¬¦ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„å¤„ç†é“¾ chainã€‚\né—®é¢˜ï¼šlangchainä¸­çš„StrOutputParser æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹ chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„ ä½œä¸ºä¸€åèµ„æ·±æŠ€æœ¯å¯¼å¸ˆï¼Œæˆ‘æ¥è¯¦ç»†è§£é‡Š LangChain ä¸­çš„ StrOutputParser ä¸æ˜¯å¦‚ä½•â€œè‡ªåŠ¨æ¸²æŸ“â€ç»“æœçš„ï¼Œè€Œæ˜¯å®ƒåœ¨ LangChain è¡¨è¾¾å¼è¯­è¨€ (LCEL) ç®¡é“ä¸­æ‰®æ¼”çš„å…³é”®è§’è‰²ã€‚\næ ¸å¿ƒè§‚ç‚¹ï¼šStrOutputParser å¹¶éæ¸²æŸ“å™¨ï¼Œè€Œæ˜¯è½¬æ¢å™¨ StrOutputParser çš„ä½œç”¨ä¸æ˜¯å¯¹ç»“æœè¿›è¡Œå¤æ‚çš„â€œæ¸²æŸ“â€ï¼ˆå¦‚æ ¼å¼åŒ–ä¸º Markdown æˆ– HTMLï¼‰ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€ä¸ªéå¸¸ç®€å•ä½†è‡³å…³é‡è¦çš„ç±»å‹è½¬æ¢ï¼š å®ƒç¡®ä¿ç®¡é“ï¼ˆChainï¼‰çš„æœ€ç»ˆè¾“å‡ºæ˜¯æ ‡å‡†çš„ Python å­—ç¬¦ä¸²ï¼ˆstrï¼‰ç±»å‹ã€‚ åœ¨ LangChain ç®¡é“ä¸­ï¼Œâ€œæ¸²æŸ“â€è¿™ä¸ªè¯é€šå¸¸æ„å‘³ç€å°†è¾“å‡ºä»ä¸€ä¸ªå¤æ‚å¯¹è±¡è½¬æ¢ä¸ºç”¨æˆ·æˆ–ä¸‹ä¸€ä¸ªç»„ä»¶å¯ä»¥ä½¿ç”¨çš„æ ¼å¼ã€‚\n1. ä¸ºä»€ä¹ˆéœ€è¦ StrOutputParserï¼Ÿ LLM æ¨¡å‹çš„åŸå§‹è¾“å‡ºé€šå¸¸æ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼š\nåŸå§‹è¾“å‡ºç±»å‹ è§£é‡Š BaseMessage å¯¹äº Chat æ¨¡å‹ (ChatOpenAI, ChatGroq ç­‰)ï¼Œå®ƒä»¬çš„ invoke() æˆ– stream() æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª BaseMessage å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ AIMessage æˆ– HumanMessage çš„å­ç±»ï¼‰ã€‚ Generation å¯¹äº Completion æ¨¡å‹ (OpenAI ç­‰)ï¼Œå®ƒä»¬çš„ invoke() è¿”å›çš„æ˜¯ä¸€ä¸ª Generation å¯¹è±¡çš„åˆ—è¡¨ï¼ˆåŒ…è£…åœ¨ LLMResult ä¸­ï¼‰ã€‚ StrOutputParser çš„å·¥ä½œå°±æ˜¯ä»è¿™äº›å¤æ‚çš„å¯¹è±¡ä¸­ï¼Œå®‰å…¨åœ°æå–å‡ºäººç±»å¯è¯»çš„å­—ç¬¦ä¸²å†…å®¹ã€‚ 2. StrOutputParser çš„å·¥ä½œæœºåˆ¶ StrOutputParser åœ¨ LCEL ç®¡é“ä¸­å®ç°äº† BaseOutputParser æ¥å£ï¼Œå®ƒçš„æ ¸å¿ƒé€»è¾‘éå¸¸ç®€å•ï¼š\nA. å¤„ç† Chat æ¨¡å‹è¾“å‡º (BaseMessage å¯¹è±¡) å½“å®ƒæ¥æ”¶åˆ° AIMessage æˆ–å…¶ä»– BaseMessage å¯¹è±¡æ—¶ï¼Œå®ƒä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„ .content å±æ€§ã€‚\nè¾“å…¥ç¤ºä¾‹ï¼š è¾“å‡ºç»“æœï¼š 'ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIã€‚' B. å¤„ç† Completion æ¨¡å‹è¾“å‡º (LLMResult / Generation å¯¹è±¡) å¦‚æœå®ƒæ¥æ”¶åˆ°çš„æ˜¯ Completion æ¨¡å‹è¿”å›çš„ç»“æ„ï¼Œå®ƒä¼šæå–ç¬¬ä¸€ä¸ª Generation å¯¹è±¡çš„æ–‡æœ¬å†…å®¹ã€‚\nC. å¤„ç†æµå¼è¾“å‡º (Streaming) åœ¨æµå¼ä¼ è¾“ä¸­ï¼ŒStrOutputParser ä¼šæŒç»­æ¥æ”¶åˆ°ç‰‡æ®µï¼ˆChunksï¼‰çš„ BaseMessage å¯¹è±¡æˆ–å­—ç¬¦ä¸²ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼š\næå–å†…å®¹ï¼š ä»æ¯ä¸ªä¼ å…¥çš„ Chunk ä¸­æå– .content å±æ€§ã€‚ æ‹¼æ¥å†…å®¹ï¼š å°†è¿™äº›å†…å®¹ç‰‡æ®µå®‰å…¨åœ°æ‹¼æ¥èµ·æ¥ï¼Œå½¢æˆæœ€ç»ˆçš„å®Œæ•´å­—ç¬¦ä¸²ã€‚è¿™ç¡®ä¿äº†å‰ç«¯æˆ–ç”¨æˆ·æ¥æ”¶åˆ°çš„æµæ˜¯è¿ç»­ä¸”æ­£ç¡®çš„æ–‡æœ¬ã€‚ 3. å¦‚ä½•â€œè‡ªåŠ¨æ¸²æŸ“â€çš„è¯¯è§£ ç”¨æˆ·ä¹‹æ‰€ä»¥è§‰å¾—å®ƒæ˜¯â€œè‡ªåŠ¨æ¸²æŸ“â€çš„ï¼Œæ˜¯å› ä¸ºå®ƒå°†ä¸€ä¸ªä¸é€æ˜çš„ LangChain å†…éƒ¨å¯¹è±¡ï¼ˆå¦‚ AIMessageï¼‰è½¬æ¢æˆäº†åº”ç”¨ç¨‹åºå‰ç«¯å¯ä»¥ç›´æ¥æ˜¾ç¤ºçš„ Python str ç±»å‹ã€‚ åœ¨ LCEL ç®¡é“ä¸­ï¼ŒStrOutputParser é€šå¸¸ä½äºç®¡é“çš„æœ«ç«¯ï¼Œå› ä¸ºå®ƒç¡®ä¿äº†ç®¡é“çš„è¾“å‡ºèƒ½å¤Ÿè¢«åç»­çš„ç³»ç»Ÿï¼ˆå¦‚ Flask API å“åº”ã€Streamlit ç•Œé¢æˆ–ç®€å•çš„ print() è¯­å¥ï¼‰è½»æ¾æ¶ˆè´¹ã€‚\næ€»ç»“ StrOutputParser æ˜¯ LangChain ç®¡é“ä¸­ä¸€ä¸ªç±»å‹è½¬æ¢ç»„ä»¶ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š\nä» LLM è¿”å›çš„å¤æ‚å¯¹è±¡ï¼ˆå¦‚ AIMessageï¼‰ä¸­æå–çº¯æ–‡æœ¬å†…å®¹ã€‚ ç¡®ä¿ Chain çš„è¾“å‡ºç±»å‹å§‹ç»ˆæ˜¯æ ‡å‡†çš„ strï¼Œä»¥ä¾¿äºåç»­å¤„ç†å’Œå±•ç¤ºã€‚ åœ¨æµå¼ä¼ è¾“ä¸­ï¼Œè´Ÿè´£å°†æ¥æ”¶åˆ°çš„å†…å®¹ç‰‡æ®µå®‰å…¨æ‹¼æ¥ã€‚ é—®é¢˜ï¼šé‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„ ä»£ç  streamlit.elements.write.WriteMixin.write ä¸­æœ‰è®²è§£è¿™éƒ¨åˆ†å†…å®¹ã€‚\nè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº† Streamlit çš„æ ¸å¿ƒæœºåˆ¶å’Œå‰ç«¯äº¤äº’åŸç†ã€‚ streamlit.write() æ–¹æ³•è‡ªèº«ä¸ä¼šæ‰§è¡Œ Markdown æ¸²æŸ“ï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œä¸‡èƒ½â€å‘½ä»¤ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„æ•°æ®ç±»å‹è¿›è¡Œåˆ†æ´¾ï¼ˆDispatchï¼‰ã€‚å½“å®ƒæ¥æ”¶åˆ°å­—ç¬¦ä¸²æ—¶ï¼Œå®ƒä¼šå°†æ¸²æŸ“å·¥ä½œå§”æ‰˜ç»™ä¸“é—¨çš„å‡½æ•°ã€‚ ä¸‹é¢æ˜¯ st.write() å¦‚ä½•å°† Markdown æ–‡æœ¬è‡ªåŠ¨è½¬æ¢ä¸º HTML æ ¼å¼åŒ–æ˜¾ç¤ºçš„è¯¦ç»†è¿‡ç¨‹ã€‚\n1. st.write() çš„åˆ†æ´¾æœºåˆ¶ (The Swiss Army Knife) st.write() è¢«ç§°ä¸º Streamlit çš„â€œç‘å£«å†›åˆ€â€ï¼Œå®ƒä¼šæ£€æŸ¥ä¼ å…¥çš„å‚æ•°ç±»å‹ï¼š\nä¼ å…¥å‚æ•°ç±»å‹ st.write() å®é™…è°ƒç”¨ str (å­—ç¬¦ä¸²) å§”æ‰˜ç»™ st.markdown() pd.DataFrame å§”æ‰˜ç»™ st.dataframe() dict æˆ– list å§”æ‰˜ç»™ st.json() Altair/Plotly Chart å§”æ‰˜ç»™ç›¸åº”çš„å›¾è¡¨å‡½æ•° Exception å§”æ‰˜ç»™ st.exception() å› æ­¤ï¼Œå½“ä½ ä¼ å…¥ä¸€ä¸ªåŒ…å« Markdown æ ¼å¼çš„å­—ç¬¦ä¸²æ—¶ï¼Œå®é™…æ‰§è¡Œæ¸²æŸ“çš„æ˜¯ st.markdown() å‡½æ•°ã€‚ 2. st.markdown() çš„æ ¸å¿ƒæ¸²æŸ“è¿‡ç¨‹ st.markdown() æ˜¯ä¸“é—¨è´Ÿè´£å°† Markdown æ–‡æœ¬è½¬æ¢ä¸º HTML çš„å‡½æ•°ã€‚è¿™ä¸ªè½¬æ¢è¿‡ç¨‹åœ¨ Streamlit å†…éƒ¨æ˜¯è¿™æ ·è¿ä½œçš„ï¼š\nA. åç«¯ï¼ˆPythonï¼‰å¤„ç†ï¼šä½¿ç”¨ Markdown è§£æåº“\nè§£æå™¨ä½¿ç”¨ï¼š Streamlit çš„ Python åç«¯ä¸ä¼šè‡ªå·±ç¼–å†™ Markdown è½¬æ¢é€»è¾‘ã€‚å®ƒä¼šä¾èµ–ä¸€ä¸ªæˆ–å¤šä¸ªæˆç†Ÿçš„ã€é«˜æ€§èƒ½çš„ Python Markdown è§£æåº“ï¼ˆä¾‹å¦‚ï¼Œæ—©æœŸç‰ˆæœ¬å¯èƒ½ä¾èµ– markdown-it-py æˆ–ç±»ä¼¼çš„åº“ï¼‰ã€‚ ç”Ÿæˆ HTML/æŠ½è±¡ç»“æ„ï¼š å½“ä½ è°ƒç”¨ st.markdown(body) æ—¶ï¼Œbody å­—ç¬¦ä¸²ä¼šè¢«è¿™ä¸ªå†…éƒ¨çš„ Markdown è§£æå™¨å¤„ç†ï¼Œå¹¶è½¬æ¢æˆå¯¹åº”çš„ HTML ç»“æ„ï¼ˆæˆ–ä¸€ä¸ªåŒ…å«æ¸²æŸ“æŒ‡ä»¤çš„ä¸­é—´æ•°æ®ç»“æ„ï¼‰ã€‚ ä¾‹å¦‚ï¼Œ**bold** è¢«è½¬æ¢ä¸º boldã€‚ åºåˆ—åŒ–ä¸ä¼ è¾“ï¼š Streamlit å°†è¿™ä¸ª HTML ç»“æ„æˆ–æ¸²æŸ“æŒ‡ä»¤åºåˆ—åŒ–ï¼ˆé€šå¸¸ä¸º JSON æ ¼å¼ï¼‰ã€‚ WebSocket ä¼ è¾“ï¼š åºåˆ—åŒ–åçš„æ•°æ®é€šè¿‡ WebSocket è¿æ¥ï¼Œä» Python åç«¯å‘é€åˆ° Streamlit çš„å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ã€‚ B. å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰æ¸²æŸ“ï¼šReact + CSS\nå‰ç«¯æ¥æ”¶ï¼š Streamlit çš„å‰ç«¯ï¼ˆä½¿ç”¨ React æ¡†æ¶æ„å»ºï¼‰æ¥æ”¶åˆ°é€šè¿‡ WebSocket å‘é€è¿‡æ¥çš„æŒ‡ä»¤/æ•°æ®ã€‚ DOM æ“ä½œï¼š React ç»„ä»¶æ ¹æ®æ”¶åˆ°çš„ HTML ç»“æ„æˆ–æŒ‡ä»¤ï¼Œå°†å…¶å®‰å…¨åœ°æ’å…¥åˆ° Web é¡µé¢çš„ DOM (Document Object Model) ä¸­ã€‚ æµè§ˆå™¨æ¸²æŸ“ï¼š æµè§ˆå™¨è¯†åˆ«è¿™äº› HTML æ ‡ç­¾ï¼ˆå¦‚ , , ï¼‰å¹¶åº”ç”¨é»˜è®¤æˆ– Streamlit è‡ªå®šä¹‰çš„ CSS æ ·å¼ã€‚ æ ·å¼åº”ç”¨ï¼š Streamlit å…·æœ‰å†…ç½®çš„æ ·å¼è¡¨ï¼Œç¡®ä¿æ‰€æœ‰çš„ Markdown å…ƒç´ ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰éƒ½éµå¾ªåº”ç”¨çš„ä¸»é¢˜å’Œå¤–è§‚ï¼Œçœ‹èµ·æ¥ç¾è§‚ä¸”ä¸€è‡´ã€‚ 3. ä¸ºä»€ä¹ˆæ˜¯è‡ªåŠ¨çš„ï¼Ÿ å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨ä¸”æ— æ„Ÿçš„ï¼Œå› ä¸ºï¼š\nå°è£…ï¼š st.write() å’Œ st.markdown() å°è£…äº†ä» Markdown å­—ç¬¦ä¸²åˆ° HTML æ¸²æŸ“çš„æ‰€æœ‰æ­¥éª¤ã€‚ å®æ—¶åŒæ­¥ï¼š Streamlit çš„æ¶æ„æœ¬èº«å°±æ˜¯ä¸ºäº†åœ¨ Python åç«¯ä»£ç ä¸æµè§ˆå™¨å‰ç«¯ä¹‹é—´æä¾›å®æ—¶åŒæ­¥ã€‚å½“ä½ è°ƒç”¨ä¸€ä¸ª Streamlit å‘½ä»¤æ—¶ï¼ŒPython æ¡†æ¶ä¼šç«‹å³å¤„ç†æ•°æ®å¹¶å‘Šè¯‰å‰ç«¯å¦‚ä½•æ›´æ–°ã€‚ é—®é¢˜ï¼šPydantic ä¸­ BaseModel çš„æ ¸å¿ƒä½œç”¨ï¼šæ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ åœ¨ Python çš„ pydantic åº“ä¸­ï¼ŒBaseModel æ˜¯æ„å»ºæ•°æ®æ¨¡å‹çš„åŸºçŸ³ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å®šä¹‰æ•°æ®çš„ç»“æ„ã€ç±»å‹ï¼Œå¹¶è‡ªåŠ¨è¿›è¡ŒéªŒè¯ã€‚ ç®€å•æ¥è¯´ï¼ŒBaseModel å°†æ¾æ•£çš„ Python å­—å…¸æ•°æ®æå‡ä¸ºå…·æœ‰æ˜ç¡®ç»“æ„ã€ç±»å‹å’Œå†…ç½®éªŒè¯çš„å¼ºå¤§æ•°æ®å¯¹è±¡ã€‚\nğŸš€ BaseModel çš„ä¸»è¦åŠŸèƒ½\n1. å®šä¹‰æ¸…æ™°çš„æ•°æ®ç»“æ„ (Schema Definition) BaseModel å…è®¸ä½ ä½¿ç”¨æ ‡å‡†çš„ Python ç±»å‹æ³¨è§£æ¥å®šä¹‰ä½ çš„æ•°æ®å¯¹è±¡åº”è¯¥é•¿ä»€ä¹ˆæ ·ï¼ŒåŒ…æ‹¬å“ªäº›å­—æ®µã€æ¯ä¸ªå­—æ®µçš„ç±»å‹ã€‚\nç¤ºä¾‹: Python from pydantic import BaseModel from datetime import datetime class User(BaseModel): id: int name: str = \"John Doe\" # å¸¦æœ‰é»˜è®¤å€¼ signup_ts: datetime | None = None # è”åˆç±»å‹ is_active: bool è¿™ä¸ªç±»æ¸…æ¥šåœ°å®šä¹‰äº†ä¸€ä¸ªç”¨æˆ·å¯¹è±¡å¿…é¡»åŒ…å« idï¼ˆæ•´æ•°ï¼‰ã€nameï¼ˆå­—ç¬¦ä¸²ï¼‰ã€signup_tsï¼ˆæ—¥æœŸæ—¶é—´æˆ– Noneï¼‰å’Œ is_activeï¼ˆå¸ƒå°”å€¼ï¼‰ã€‚ 2. è‡ªåŠ¨æ•°æ®æ ¡éªŒ (Data Validation) è¿™æ˜¯ BaseModel æœ€æ ¸å¿ƒçš„åŠŸèƒ½ã€‚å½“ä½ å°è¯•åˆ›å»ºä¸€ä¸ª BaseModel å®ä¾‹æ—¶ï¼ŒPydantic ä¼šè‡ªåŠ¨æ£€æŸ¥ä¼ å…¥çš„æ•°æ®æ˜¯å¦ç¬¦åˆä½ å®šä¹‰çš„ç±»å‹å’Œç»“æ„ã€‚\nå¦‚æœæ•°æ®ç±»å‹æ­£ç¡®ï¼š å®ƒä¼šå°†è¾“å…¥æ•°æ®ï¼ˆæ¯”å¦‚ JSON å­—ç¬¦ä¸²ã€å­—å…¸ï¼‰è½¬æ¢ä¸ºæ­£ç¡®çš„ Python ç±»å‹ï¼ˆä¾‹å¦‚å°† JSON å­—ç¬¦ä¸² â€œ1â€ è½¬æ¢ä¸ºæ•´æ•° 1ï¼‰ã€‚ å¦‚æœæ•°æ®æ ¡éªŒå¤±è´¥ï¼š å®ƒä¼šæŠ›å‡ºä¸€ä¸ªæ¸…æ™°çš„ ValidationErrorï¼Œå‘Šè¯‰ä½ å“ªä¸ªå­—æ®µå‡ºäº†é—®é¢˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆã€‚è¿™æå¤§åœ°å‡å°‘äº†è¿è¡Œæ—¶é”™è¯¯å’Œè°ƒè¯•æ—¶é—´ã€‚ 3. è‡ªåŠ¨æ•°æ®è½¬æ¢ (Data Coercion) BaseModel ä¸ä»…è¿›è¡Œæ ¡éªŒï¼Œè¿˜å°è¯•è¿›è¡Œåˆç†çš„ç±»å‹è½¬æ¢ï¼š\nå­—ç¬¦ä¸²åˆ°æ•°å­—ï¼š å­—ç¬¦ä¸² \"123\" ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºæ•´æ•° 123ã€‚ å­—ç¬¦ä¸²åˆ°æ—¥æœŸ/æ—¶é—´ï¼š éµå¾ª ISO æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸º datetime å¯¹è±¡ã€‚ 4. å¼ºå¤§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– BaseModel å®ä¾‹å†…ç½®äº†å°†æ•°æ®å¯¹è±¡è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼çš„æ–¹æ³•ï¼š\nåºåˆ—åŒ– (Serialization): user_instance.model_dump(): å°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸ºæ ‡å‡†çš„ Python å­—å…¸ (dict)ã€‚ user_instance.model_dump_json(): å°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿ç½‘ç»œä¼ è¾“ã€‚ ååºåˆ—åŒ– (Deserialization): User(**data_dict): ä»å­—å…¸åˆ›å»ºæ¨¡å‹å®ä¾‹ã€‚ User.model_validate(data_dict): ä»å­—å…¸æˆ– JSON æ•°æ®ä¸­éªŒè¯å¹¶åˆ›å»ºæ¨¡å‹å®ä¾‹ã€‚ 5. ä¸ FastAPI ç­‰æ¡†æ¶é›†æˆ åœ¨ FastAPI ä¸­ï¼ŒBaseModel æ˜¯å®šä¹‰è¯·æ±‚ä½“ (Request Body) å’Œ å“åº”ä½“ (Response Body) çš„æ ‡å‡†æ–¹å¼ã€‚\nå½“ç”¨ä½œè¯·æ±‚ä½“æ—¶ï¼ŒFastAPI è‡ªåŠ¨ä½¿ç”¨ BaseModel æ¥æ ¡éªŒå®¢æˆ·ç«¯å‘é€çš„ JSON æ•°æ®ã€‚ å½“ç”¨ä½œå“åº”ä½“æ—¶ï¼ŒFastAPI è‡ªåŠ¨ä½¿ç”¨ BaseModel æ¥åºåˆ—åŒ–ä½ çš„ Python å¯¹è±¡ä¸º JSON å“åº”ã€‚ æ€»ç»“: BaseModel çš„ä½œç”¨å°±æ˜¯å°† Python åº”ç”¨ç¨‹åºä¸­çš„æ•°æ®å¤„ç†ä»æ¾æ•£ã€æ˜“é”™çš„å­—å…¸æ“ä½œï¼Œå‡çº§ä¸ºç»“æ„åŒ–ã€ç±»å‹å®‰å…¨ä¸”è‡ªå¸¦éªŒè¯çš„å¼ºå¤§å¯¹è±¡æ¨¡å‹ã€‚ é—®é¢˜ï¼šllama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ï¼Œä¹Ÿå¯ä»¥ç”¨OllamaEmbeddingsæ¥åŠ è½½ä¹ˆï¼Ÿ è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šå’Œå…³é”®çš„é—®é¢˜ï¼Œå®ƒæ¶‰åŠåˆ°å¤§æ¨¡å‹çš„å¤šåŠŸèƒ½æ€§å’Œ Ollama å¹³å°çš„çµæ´»æ€§ã€‚ ç­”æ¡ˆæ˜¯ï¼šæ˜¯çš„ï¼Œæ‚¨å¯ä»¥å°† Llama 2 (æˆ– Llama 3 ç­‰èŠå¤©/ç”Ÿæˆæ¨¡å‹) ç”¨ä½œ OllamaEmbeddings çš„æ¨¡å‹ï¼Œä½†å®ƒå¹¶éæœ€ä½³å®è·µã€‚ ä»¥ä¸‹æ˜¯è¯¦ç»†çš„è§£é‡Šå’Œå»ºè®®ï¼š\n1. ä¸ºä»€ä¹ˆ Llama 2 å¯ä»¥ç”¨äºåµŒå…¥ï¼Ÿï¼ˆæŠ€æœ¯å¯è¡Œæ€§ï¼‰ Ollama å¹³å°æä¾›äº†ä¸€ä¸ªé€šç”¨çš„ /api/embeddings REST API ç«¯ç‚¹ã€‚ å½“æ‚¨åœ¨ OllamaEmbeddings ä¸­æŒ‡å®šä¸€ä¸ªéä¸“ç”¨çš„èŠå¤©æ¨¡å‹ï¼ˆå¦‚ llama2ï¼‰æ—¶ï¼ŒOllama å®ˆæŠ¤è¿›ç¨‹ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\næå–éšè—çŠ¶æ€ (Hidden State): Ollama ä¼šè¿è¡Œ Llama 2 æ¨¡å‹ï¼Œä½†ä¸æ‰§è¡Œæœ€ç»ˆçš„**è¯­è¨€æ¨¡å‹å¤´ï¼ˆLM Headï¼‰**å±‚ï¼ˆè¯¥å±‚è´Ÿè´£é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒï¼‰ã€‚ æ± åŒ– (Pooling): å®ƒä¼šä»æ¨¡å‹çš„å€’æ•°ç¬¬äºŒå±‚ï¼ˆæˆ–æ ¹æ®é…ç½®çš„ç‰¹å®šå±‚ï¼‰æå–è¯å…ƒéšè—çŠ¶æ€ï¼ˆToken Hidden Statesï¼‰ã€‚ç„¶åï¼Œå®ƒé€šå¸¸ä¼šåº”ç”¨ä¸€ä¸ªæ± åŒ–ç­–ç•¥ï¼ˆå¦‚å¹³å‡æ± åŒ–ï¼‰å°†è¿™äº›è¯å…ƒå‘é‡èšåˆä¸ºä¸€ä¸ªå•ä¸€çš„å¥å­å‘é‡ï¼Œä½œä¸ºæœ€ç»ˆçš„åµŒå…¥ï¼ˆEmbeddingï¼‰ã€‚ LangChain çš„ OllamaEmbeddings é€šè¿‡è°ƒç”¨è¿™ä¸ªé€šç”¨çš„ Ollama APIï¼Œå®ç°äº†å¯¹ Llama 2 çš„åµŒå…¥åŠŸèƒ½è°ƒç”¨ã€‚ 2. ä¸ºä»€ä¹ˆ Llama 2 ä¸æ¨èç”¨äºåµŒå…¥ï¼Ÿï¼ˆæ•ˆæœè€ƒé‡ï¼‰ å°½ç®¡æŠ€æœ¯ä¸Šå¯è¡Œï¼Œä½† Llama 2 æˆ–å…¶ä»–èŠå¤©æ¨¡å‹ï¼ˆå¦‚ Mistralï¼‰åœ¨æ²¡æœ‰ç»è¿‡ç‰¹å®šå¾®è°ƒçš„æƒ…å†µä¸‹ï¼Œä½œä¸ºåµŒå…¥æ¨¡å‹çš„æ•ˆæœé€šå¸¸è¿œä¸å¦‚ä¸“ç”¨åµŒå…¥æ¨¡å‹ã€‚\nåµŒå…¥æ¨¡å‹ç±»å‹ Llama 2 (ç”Ÿæˆæ¨¡å‹) ä¸“ç”¨åµŒå…¥æ¨¡å‹ (å¦‚ Nomic Embed, mxbai-embed-large) è®­ç»ƒç›®æ ‡ ç”Ÿæˆæ–‡æœ¬ï¼ˆé¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒï¼‰ã€‚ è¯­ä¹‰ç›¸ä¼¼æ€§ï¼ˆè®­ç»ƒç›®æ ‡æ˜¯è®©è¯­ä¹‰ç›¸è¿‘çš„å¥å­åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ï¼‰ã€‚ æ•ˆæœ/ç²¾åº¦ è¾ƒå·®ã€‚ å‘é‡ç©ºé—´æ²¡æœ‰é’ˆå¯¹ç›¸ä¼¼æ€§æœç´¢è¿›è¡Œä¼˜åŒ–ï¼Œæ£€ç´¢ç²¾åº¦ä½ã€‚ ä¼˜ç§€ã€‚ åœ¨ MTEB ç­‰åŸºå‡†æµ‹è¯•ä¸­è¡¨ç°ä¼˜å¼‚ï¼ŒRAG æ•ˆæœå¥½ã€‚ èµ„æºæ¶ˆè€— é«˜ã€‚ Llama 2 å°ºå¯¸è¾ƒå¤§ï¼ˆå¦‚ 7Bï¼‰ï¼Œæ¨ç†æ…¢ï¼Œå†…å­˜å ç”¨é«˜ã€‚ ä½ã€‚ ä¸“ç”¨æ¨¡å‹é€šå¸¸æ›´å°ï¼ˆå¦‚ 300Mï¼‰ï¼Œé€Ÿåº¦å¿«ï¼Œèµ„æºæ¶ˆè€—ä½ã€‚ ç®€è€Œè¨€ä¹‹ï¼š Llama 2 ç”Ÿæˆçš„å‘é‡å¯èƒ½æ— æ³•å‡†ç¡®æ•æ‰ä¸åŒå¥å­ä¹‹é—´çš„è¯­ä¹‰ç›¸ä¼¼æ€§ï¼Œè¿™ä¼šä¸¥é‡æŸå®³æ‚¨çš„ RAG æ£€ç´¢è´¨é‡ã€‚ 3. æ¶æ„å¸ˆå»ºè®® ä½œä¸ºä¸€åèµ„æ·±æ¶æ„å¸ˆï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼š\nå¯¹äº RAG æˆ–è¯­ä¹‰æœç´¢ï¼š å§‹ç»ˆä¼˜å…ˆä½¿ç”¨ä¸“ç”¨çš„åµŒå…¥æ¨¡å‹ã€‚ æ‚¨å·²ç»çœ‹åˆ°äº†ï¼ŒOllama æ”¯æŒè®¸å¤šé«˜æ€§èƒ½ã€å°å·§ä¸”ä¸“é—¨ä¸ºåµŒå…¥ä»»åŠ¡ä¼˜åŒ–çš„æ¨¡å‹ï¼ˆå¦‚ mxbai-embed-large æˆ– embeddinggemmaï¼‰ã€‚è¿™èƒ½æä¾›æ›´å¥½çš„ç²¾åº¦å’Œæ›´å¿«çš„é€Ÿåº¦ã€‚ å®éªŒå’Œè‡ªå®šä¹‰ï¼š å¦‚æœæ‚¨åªæ˜¯è¿›è¡Œå®éªŒï¼Œæˆ–è€…æ‚¨çš„ Llama 2 æ˜¯ç»è¿‡ä¸“é—¨çš„ å¯¹æ¯”å­¦ä¹ ï¼ˆContrastive Learningï¼‰å¾®è°ƒç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼ŒAnglE-LLaMA ç­‰ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ Llama 2 æ˜¯æœ‰æ„ä¹‰çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ç¡®ä¿ä½ çš„ Llama 2 æ¨¡å‹æ–‡ä»¶åœ¨ Ollama ä¸­å·²ç»åŒ…å«äº†å¿…è¦çš„åµŒå…¥é…ç½®ã€‚ ç»“è®ºï¼šä½¿ç”¨ OllamaEmbeddings(model=\"llama2\") æ˜¯å¯è¡Œçš„ï¼Œä½†ä¸ºäº†æ‚¨çš„åº”ç”¨æ€§èƒ½å’Œå‡†ç¡®æ€§ï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªä¸“ç”¨çš„ Ollama åµŒå…¥æ¨¡å‹ã€‚ ",
  "wordCount" : "19461",
  "inLanguage": "zh",
  "datePublished": "2025-11-07T00:00:00Z",
  "dateModified": "2025-11-11T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Chester"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://chesterwang.github.io/chester-blog/posts/2025-11-07-rag%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chester's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://image.lvbibir.cn/blog/avatar.webp"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chesterwang.github.io/chester-blog/" accesskey="h" title="Chester&#39;s Blog (Alt + H)">
                <img src="https://image.lvbibir.cn/blog/avatar.webp" alt="" aria-label="logo"
                    height="35">Chester&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li class="menu-item">
                <a href="https://chesterwang.github.io/chester-blog/archives" title="ğŸ“ˆ å½’æ¡£">
                    <span>ğŸ“ˆ å½’æ¡£</span>
                    
                </a>
            
            </li>
            <li class="menu-item">
                <a href="https://chesterwang.github.io/chester-blog/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                    
                </a>
            
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://chesterwang.github.io/chester-blog/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://chesterwang.github.io/chester-blog/posts/">ğŸ“š æ–‡ç« </a></div>
            <h1 class="post-title">
                ä¸ªäººRAGé¡¹ç›®å¼€å‘è®°å½•
            </h1>
            <div class="post-description">
                ä¸ªäººRAGé¡¹ç›®çš„å¼€å‘è®°å½•å’Œç¬”è®°
            </div>
            <div class="post-meta">åˆ›å»º: 2025-11-07 | æ›´æ–°: 2025-11-11 | å­—æ•°: 19461å­— | ä½œè€…:Chester


                |&nbsp;æ ‡ç­¾:&nbsp;
                <ul class="post-tags-meta">
                    <a href="https://chesterwang.github.io/chester-blog/tags/llm/">LLM</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                    &nbsp;|&nbsp;è®¿é—®:&nbsp;<span id="busuanzi_value_page_pv"></span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="é¡¹ç›®ç¯å¢ƒæ­å»º">é¡¹ç›®ç¯å¢ƒæ­å»º</a></li>
                <li>
                    <a href="#p01-rag-projects" aria-label="P01 RAG-Projects">P01 RAG-Projects</a><ul>
                        <ul>
                        
                <li>
                    <a href="#project-01-chatbot" aria-label="Project 01 chatbot">Project 01 chatbot</a></li>
                <li>
                    <a href="#project-02-apis" aria-label="Project 02 APIs">Project 02 APIs</a></li>
                <li>
                    <a href="#project-04-retriever-and-chain" aria-label="Project 04 Retriever and Chain">Project 04 Retriever and Chain</a></li>
                <li>
                    <a href="#project-05-advanced-rag-qa-project" aria-label="Project 05 Advanced RAG Q&amp;amp;A Project">Project 05 Advanced RAG Q&amp;A Project</a></li>
                <li>
                    <a href="#project-06-groq-inference" aria-label="Project 06 Groq inference">Project 06 Groq inference</a></li>
                <li>
                    <a href="#project-07-gen-ai" aria-label="Project 07 Gen AI">Project 07 Gen AI</a></li>
                <li>
                    <a href="#project-08-powerful-doc-qa-chatbot" aria-label="Project 08 Powerful Doc Q&amp;amp;A Chatbot">Project 08 Powerful Doc Q&amp;A Chatbot</a></li>
                <li>
                    <a href="#project-09-advance-qa-chatbot" aria-label="Project 09 Advance Q&amp;amp;A Chatbot">Project 09 Advance Q&amp;A Chatbot</a></li>
                <li>
                    <a href="#project-11-imageenhancer" aria-label="Project 11 ImageEnhancer">Project 11 ImageEnhancer</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#p02-demo_simple_rag_py" aria-label="P02 demo_simple_rag_py">P02 demo_simple_rag_py</a></li>
                <li>
                    <a href="#p03-rag-optimization-practices" aria-label="P03 RAG-Optimization-Practices">P03 RAG-Optimization-Practices</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e5%8e%9f%e7%90%86%e5%92%8c%e7%bb%93%e6%9e%9c" aria-label="é¡¹ç›®åŸç†å’Œç»“æœ">é¡¹ç›®åŸç†å’Œç»“æœ</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e5%af%b9%e4%ba%8e%e4%b8%80%e4%b8%aabatch%e5%86%85%e7%9a%84%e6%95%b0%e6%8d%ae%e6%9c%89%e5%be%88%e5%a4%9a%e6%9d%a1%e6%95%b0%e6%8d%ae%e6%9c%89%e5%85%b1%e5%90%8c%e7%9a%84%e5%89%8d%e7%bc%80%e9%82%a3%e4%b9%88vllm%e4%b8%ad%e6%9c%89%e9%92%88%e5%af%b9%e8%bf%99%e7%a7%8d%e6%83%85%e5%86%b5%e7%9a%84%e4%bc%98%e5%8c%96%e6%8e%a8%e7%90%86%e7%ad%96%e7%95%a5" aria-label="é—®é¢˜ï¼šå¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥">é—®é¢˜ï¼šå¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e4%bd%86%e6%98%af%e4%b8%80%e4%b8%aabatch%e5%86%85%e7%9a%84%e6%95%b0%e6%8d%ae%e6%98%af%e4%b8%80%e8%b5%b7%e8%bf%9b%e8%a1%8c%e5%b9%b6%e8%a1%8c%e6%8e%a8%e7%90%86%e7%9a%84%e5%91%80%e9%82%a3%e4%b9%88%e8%bf%99%e4%b8%aa%e6%97%b6%e5%80%99-cache%e8%bf%98%e6%b2%a1%e4%ba%a7%e7%94%9f%e5%90%a7" aria-label="é—®é¢˜ï¼šä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ cacheè¿˜æ²¡äº§ç”Ÿå§ï¼Ÿ">é—®é¢˜ï¼šä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ cacheè¿˜æ²¡äº§ç”Ÿå§ï¼Ÿ</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#p04-rag-best-practices" aria-label="P04 rag-best-practices">P04 rag-best-practices</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e5%8e%9f%e7%90%86%e5%92%8c%e7%bb%93%e6%9e%9c-1" aria-label="é¡¹ç›®åŸç†å’Œç»“æœ">é¡¹ç›®åŸç†å’Œç»“æœ</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98pytorch_modelbin-%e5%92%8c-modelsafetensors-%e5%88%86%e5%88%ab%e6%98%af%e4%bb%80%e4%b9%88" aria-label="é—®é¢˜ï¼špytorch_model.bin å’Œ model.safetensors åˆ†åˆ«æ˜¯ä»€ä¹ˆ">é—®é¢˜ï¼špytorch_model.bin å’Œ model.safetensors åˆ†åˆ«æ˜¯ä»€ä¹ˆ</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98sparse-text-embeddings-%e5%92%8c-dense-text-embeddings-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="é—®é¢˜ï¼šSparse text embeddings å’Œ dense text embeddings çš„åŒºåˆ«">é—®é¢˜ï¼šSparse text embeddings å’Œ dense text embeddings çš„åŒºåˆ«</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98sparse-embeddings%e7%9a%84%e6%a8%a1%e5%9e%8b%e5%a6%82%e4%bd%95%e5%81%9a%e5%88%b0-%e8%be%93%e5%87%ba%e7%a8%80%e7%96%8f%e5%90%91%e9%87%8f%e7%9a%84" aria-label="é—®é¢˜ï¼šSparse Embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ° è¾“å‡ºç¨€ç–å‘é‡çš„">é—®é¢˜ï¼šSparse Embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ° è¾“å‡ºç¨€ç–å‘é‡çš„</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98" aria-label="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e9%97%ae%e9%a2%98langchain%e4%b8%ad%e7%9a%84%e7%ab%96%e7%ba%bf%e8%bf%90%e7%ae%97%e7%ac%a6%e6%98%af%e7%94%b1%e5%93%aa%e4%ba%9b%e6%96%b9%e6%b3%95%e6%9d%a5%e5%ae%9e%e7%8e%b0%e7%9a%84" aria-label="é—®é¢˜ï¼šlangchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„">é—®é¢˜ï¼šlangchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98langchain%e4%b8%ad%e7%9a%84stroutputparser-%e6%98%af%e5%a6%82%e4%bd%95%e8%87%aa%e5%8a%a8%e5%af%b9-chatbot%e7%9a%84%e7%bb%93%e6%9e%9c%e8%bf%9b%e8%a1%8c%e6%b8%b2%e6%9f%93%e7%9a%84" aria-label="é—®é¢˜ï¼šlangchainä¸­çš„StrOutputParser æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹ chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„">é—®é¢˜ï¼šlangchainä¸­çš„StrOutputParser æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹ chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98%e9%82%a3%e4%b9%88streamlit%e7%9a%84write%e6%96%b9%e6%b3%95%e6%98%af%e5%a6%82%e4%bd%95%e5%b0%86markdown%e6%a0%bc%e5%bc%8f%e6%96%87%e6%9c%ac%e8%87%aa%e5%8a%a8%e6%b8%b2%e6%9f%93%e4%b8%ba%e6%9c%89%e6%a0%bc%e5%bc%8f%e7%9a%84html%e7%9a%84" aria-label="é—®é¢˜ï¼šé‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„">é—®é¢˜ï¼šé‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98pydantic-%e4%b8%ad-basemodel-%e7%9a%84%e6%a0%b8%e5%bf%83%e4%bd%9c%e7%94%a8%e6%95%b0%e6%8d%ae%e6%a8%a1%e5%9e%8b%e5%92%8c%e6%95%b0%e6%8d%ae%e6%a0%a1%e9%aa%8c" aria-label="é—®é¢˜ï¼šPydantic ä¸­ BaseModel çš„æ ¸å¿ƒä½œç”¨ï¼šæ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ">é—®é¢˜ï¼šPydantic ä¸­ <code>BaseModel</code> çš„æ ¸å¿ƒä½œç”¨ï¼šæ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ</a></li>
                <li>
                    <a href="#%e9%97%ae%e9%a2%98llama2%e5%b9%b6%e9%9d%9e%e6%98%af%e4%b8%93%e5%b1%9e%e7%9a%84embedding%e6%a8%a1%e5%9e%8b%e4%b9%9f%e5%8f%af%e4%bb%a5%e7%94%a8ollamaembeddings%e6%9d%a5%e5%8a%a0%e8%bd%bd%e4%b9%88" aria-label="é—®é¢˜ï¼šllama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ï¼Œä¹Ÿå¯ä»¥ç”¨OllamaEmbeddingsæ¥åŠ è½½ä¹ˆï¼Ÿ">é—®é¢˜ï¼šllama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ï¼Œä¹Ÿå¯ä»¥ç”¨OllamaEmbeddingsæ¥åŠ è½½ä¹ˆï¼Ÿ</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="é¡¹ç›®ç¯å¢ƒæ­å»º">é¡¹ç›®ç¯å¢ƒæ­å»º<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®ç¯å¢ƒæ­å»º">#</a></h2>
<ol>
<li>å¦‚ä½•å°†requirements.txtä¸­çš„ä¾èµ–è½¬ç§»åˆ° uvç¯å¢ƒä¸­
<ol>
<li><code>uv add -r requirements.txt</code>
<ol>
<li>å¦‚æœå¤ªæ…¢åˆ™åŠ  url  <code>uv add -r requirements.txt --index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></li>
</ol>
</li>
</ol>
</li>
<li><strong>ollamaæ­å»º</strong>
<ol>
<li>æŠ¥é”™
<ol>
<li>ollamaä¿®æ”¹æ¨¡å‹ä¸‹è½½ç›®å½•ä¹‹åæŠ¥é”™</li>
<li>error: pull model manifest: 503: no healthy upstream</li>
<li>é‡å¯æœåŠ¡å³å¯
<ol>
<li>sudo systemctl stop ollama</li>
<li>sudo systemctl start ollama</li>
</ol>
</li>
</ol>
</li>
<li>ä¿®æ”¹æ¨¡å‹ç›®å½•
<ol>
<li>sudo ln -s  /home/chester/ollama/models /usr/share/ollama/.ollama/</li>
<li>sudo chown ollama /usr/share/ollama/.ollama/models</li>
<li>sudo chgrp ollama /usr/share/ollama/.ollama/models</li>
<li>åä¸¤æ¡æ˜¯ä¿è¯ç›®å½•çš„æƒé™é—®é¢˜ï¼Œä¸ç„¶ollmaè¿è¡Œä¼šæŠ¥é”™</li>
<li>èµ„æ–™æ¥æº <a href="https://www.reddit.com/r/ollama/comments/1c4zg15/does_anyone_know_how_to_change_where_your_models/" target="_blank" rel="noopener" style="color:#42b983";>Does anyone know how to change where your models are saved on linux? : r/ollama</a></li>
</ol>
</li>
<li>Ollama(model=&ldquo;qwen3:0.6b&rdquo;)
<ol>
<li>è¿™æ®µä»£ç å‰ææ˜¯ ç³»ç»Ÿä¸­ åå°å¯åŠ¨äº†ollamaæœåŠ¡ï¼ˆlinuxå®‰è£…ä¹‹åä¼šè‡ªåŠ¨åŠ å…¥ç³»ç»ŸæœåŠ¡ï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨è¯¥æœåŠ¡ï¼‰ï¼Œä½†å¹¶ä¸éœ€è¦ å‘½ä»¤è¡Œæ‰§è¡Œ ollama run modelã€‚åº”è¯¥æ˜¯åå°ä¼šè‡ªåŠ¨åŠèµ·å¯¹åº”çš„æ¨¡å‹è¿›è¡Œè®¡ç®—å¹¶ä¼ å›pythonã€‚</li>
</ol>
</li>
<li>æœ¬åœ°è¿è¡ŒollamaçœŸçš„å¤ªæ…¢äº†ã€‚</li>
</ol>
</li>
<li><strong>embeddingæ¨ç†æœåŠ¡æ–¹æ³•</strong>
<ol>
<li>HuggingFaceBgeEmbeddings
<ol>
<li>åœ¨pycharmä¸­è¿è¡Œçš„æ—¶å€™ï¼Œè¦ç»™jupyter server æ·»åŠ å‚æ•°ï¼Œé…ä¸Šhttp_proxyçš„ä»£ç†ã€‚åœ¨pycharmè½¯ä»¶å±‚é¢è®¾ç½®http_proxyæ˜¯æ²¡ç”¨çš„ã€‚</li>
<li>huggingfaceä¼šä¸‹è½½æ¨¡å‹å»ºç«‹æœ¬åœ°æœåŠ¡è¿›è¡Œè®¡ç®—ã€‚</li>
</ol>
</li>
<li>HuggingFaceInferenceAPIEmbeddings
<ol>
<li>æ˜¯é€šè¿‡apiè¿›è¡Œembeddingè®¡ç®—ï¼Œè€Œä¸æ˜¯æœ¬åœ°è¿›è¡Œè®¡ç®—ã€‚</li>
<li>é—®é¢˜ï¼šhttpcore ä¸€ç›´æŠ¥é”™æ²¡æœ‰å®‰è£…
<ol>
<li>æœ€åå‘ç°æ˜¯httpcoreæ²¡æœ‰å®‰è£…å¥½ï¼Œå¯¹åº”çš„pythonåŒ…åªæœ‰å…ƒæ•°æ®æ²¡æœ‰çœŸå®ä»£ç ï¼Œå°†å¯¹åº”ç›®å½•åˆ é™¤åé‡åˆ·uvç¯å¢ƒå³å¯ã€‚</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="p01-rag-projects">P01 RAG-Projects<a hidden class="anchor" aria-hidden="true" href="#p01-rag-projects">#</a></h2>
<p>ä»¥ä¸‹ä¸ºå°çš„RAGå­é¡¹ç›®</p>
<h4 id="project-01-chatbot">Project 01 chatbot<a hidden class="anchor" aria-hidden="true" href="#project-01-chatbot">#</a></h4>
<p><strong>é—®é¢˜ï¼šload_dotenvçš„æœºåˆ¶</strong></p>
<ol>
<li>load_dotenv å®šä¹‰å¦‚ä¸‹
<ol>
<li>é»˜è®¤åŠ è½½ .envæ–‡ä»¶ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸å­˜åœ¨ï¼Œå°±ä¸æ–­æå‡ç›®å½•å±‚æ¬¡æ¥æŸ¥æ‰¾ã€‚</li>
<li>interpolate ç”¨äºæ˜¯å¦è§£æå­—ç¬¦ä¸²ä¸­çš„å˜é‡ï¼Œæ¯”å¦‚ <code>PATH=${PATH}:/usr/share/bin</code> ï¼Œå°±ä¼šæŠŠPATHå˜é‡è¿›è¡Œè§£ææ›¿æ¢ã€‚</li>
</ol>
</li>
<li>å…¶ä¸­ <code>dotenv.main.resolve_variables</code> å¯¹äºinterpolate åŠŸèƒ½çš„å®ç°å¾ˆæœ‰æ„æ€ï¼Œä½¿ç”¨äº†æ­£åˆ™æ–¹æ³•æ¥åŒ¹é…å¹¶åˆ†åˆ«è¿›è¡Œæ›¿æ¢ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#815ba4">def</span> <span style="color:#06b6ef">load_dotenv</span>(
</span></span><span style="display:flex;"><span>    dotenv_path: Optional[StrPath] <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">None</span>,
</span></span><span style="display:flex;"><span>    stream: Optional[IO[str]] <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">None</span>,
</span></span><span style="display:flex;"><span>    verbose: bool <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">False</span>,
</span></span><span style="display:flex;"><span>    override: bool <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">False</span>,
</span></span><span style="display:flex;"><span>    interpolate: bool <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">True</span>,
</span></span><span style="display:flex;"><span>    encoding: Optional[str] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;utf-8&#34;</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#5bc4bf">-&gt;</span> bool:
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;&#34;&#34;Parse a .env file and then load all the variables found as environment variables.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    Parameters:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        dotenv_path: Absolute or relative path to .env file.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        stream: Text stream (such as `io.StringIO`) with .env content, used if
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">            `dotenv_path` is `None`.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        verbose: Whether to output a warning the .env file is missing.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        override: Whether to override the system environment variables with the variables
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">            from the `.env` file.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        encoding: Encoding to be used to read the file.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        Bool: True if at least one environment variable is set else False
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    If both `dotenv_path` and `stream` are `None`, `find_dotenv()` is used to find the
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    .env file with it&#39;s default parameters. If you need to change the default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    of `find_dotenv()`, you can explicitly call `find_dotenv()` and pass the result
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    to this function as `dotenv_path`.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    If the environment variable `PYTHON_DOTENV_DISABLED` is set to a truthy value,
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    .env loading is disabled.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    &#34;&#34;&#34;</span>
</span></span></code></pre></div><h4 id="project-02-apis">Project 02 APIs<a hidden class="anchor" aria-hidden="true" href="#project-02-apis">#</a></h4>
<ol>
<li><code>ChatMessagePromptTemplate</code> å’Œ <code>ChatPromptTemplate</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼Œä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š
<ol>
<li><strong>ChatMessagePromptTemplate</strong>
<ul>
<li>ç”¨äºè¡¨ç¤ºå•ä¸ªèŠå¤©æ¶ˆæ¯çš„æ¨¡æ¿</li>
<li>å¯¹åº”å•æ¡æ¶ˆæ¯ï¼ŒåŒ…å«æ¶ˆæ¯çš„è§’è‰²ï¼ˆå¦‚ç³»ç»Ÿã€ç”¨æˆ·ã€åŠ©æ‰‹ï¼‰å’Œå†…å®¹æ¨¡æ¿</li>
<li>æ˜¯æ„æˆèŠå¤©æ¨¡æ¿çš„åŸºæœ¬å•å…ƒ</li>
</ul>
</li>
<li><strong>ChatPromptTemplate</strong>
<ul>
<li>ç”¨äºè¡¨ç¤ºæ•´ä¸ªèŠå¤©å¯¹è¯çš„æ¨¡æ¿</li>
<li>å¯ä»¥åŒ…å«å¤šä¸ª <code>ChatMessagePromptTemplate</code> å®ä¾‹</li>
<li>ç”¨äºæ„å»ºå®Œæ•´çš„å¯¹è¯å†å²æ¨¡æ¿ï¼Œæ”¯æŒå¤šè½®å¯¹è¯åœºæ™¯</li>
</ul>
</li>
</ol>
<ul>
<li>ç®€è€Œè¨€ä¹‹ï¼Œ<code>ChatMessagePromptTemplate</code> æ˜¯å•æ¡æ¶ˆæ¯æ¨¡æ¿ï¼Œè€Œ <code>ChatPromptTemplate</code> æ˜¯æ•´ä¸ªå¯¹è¯æ¨¡æ¿ï¼Œåè€…å¯ä»¥åŒ…å«å¤šä¸ªå‰è€…æ¥æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚</li>
</ul>
</li>
<li><code>ChatPromptTemplate</code>
<ol>
<li>from_messages ä»è‹¥å¹²messageä¸­æ„é€ æ¨¡æ¿</li>
<li>from_template ä»å•ä¸ª message çš„ template æ¥æ„é€  HumanMessageï¼Œå¹¶ç»„è£…ä¸ºä¸€ä¸ªChatã€‚</li>
</ol>
</li>
<li><code>FewShotChatMessagePromptTemplate</code></li>
<li>langchain_core.promptsä¸­çš„å„ç§promptã€‚</li>
<li>ChatOpenAIçš„ä½¿ç”¨æ–¹æ³•
<ol>
<li><a href="https://api.python.langchain.com/en/latest/chat_models/langchain_openai.chat_models.base.ChatOpenAI.html#langchain_openai.chat_models.base.ChatOpenAI" target="_blank" rel="noopener" style="color:#42b983";>langchain_openai.chat_models.base.ChatOpenAI â€” ğŸ¦œğŸ”— LangChain 0.2.17</a></li>
</ol>
</li>
<li>StrOutputParser å¦‚ä½•è§£æchainä¹‹å‰éƒ¨åˆ†çš„å†…å®¹
<ol>
<li>langchain_core.outputs.chat_generation.ChatGeneration.set_text ä¸­æŒ‡æ˜äº†ä»messageä¸­çš„contentå±æ€§æ¥è·å–å†…å®¹ã€‚</li>
</ol>
</li>
</ol>
<h4 id="project-04-retriever-and-chain">Project 04 Retriever and Chain<a hidden class="anchor" aria-hidden="true" href="#project-04-retriever-and-chain">#</a></h4>
<ol>
<li>create_stuff_documents_chain
<ol>
<li>RunnablePassthrough å³ identity functionï¼Œæ’ç­‰å‡½æ•°ï¼Œè¾“å…¥ä»€ä¹ˆå°±è¾“å‡ºä»€ä¹ˆã€‚</li>
<li>RunnablePassthrough.assign  ï¼š Merge the Dict input with the output produced by the mapping argument.</li>
</ol>
</li>
<li><strong>chainçš„è°ƒç”¨è¿‡ç¨‹</strong>
<ol>
<li>è¾“å…¥ï¼šè¾“å…¥æ•°æ®ä¸ºdictï¼Œæœ‰inputè¿™ä¸ªkeyã€‚</li>
<li><code>retrieval_docs</code> ï¼šå…ˆå¯¹ æ•°æ®è¿›è¡Œæ£€ç´¢ï¼Œå³ä»xä¸­è·å– inputè¿™ä¸€é¡¹ï¼Œç„¶åé€å…¥æ£€ç´¢å™¨ã€‚æ£€ç´¢å™¨æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† <code>__ror__</code>æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº† <code>VectorStoreRetriever</code>çš„ <code>_get_relevant_documents</code> æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è°ƒç”¨äº† <code>self.vectorstore.similarity_search</code>æ–¹æ³•ã€‚æ£€ç´¢å®Œä¹‹åï¼Œå°†ç›¸ä¼¼æ–‡æ¡£ç»„è£…ä¸ºä¸€ä¸ªitemæ”¾å…¥åˆ° contextè¿™ä¸ªkeyä¸‹ã€‚ æ•°æ®å˜ä¸º <code>{input:XXX, context:[docs]}</code>ã€‚</li>
<li><code>format_docs</code> ï¼šæ£€ç´¢å‡ºç›¸ä¼¼æ–‡æ¡£ä¹‹åï¼Œé€å…¥format_inputsè¿‡ç¨‹ï¼Œå³å°†æ•°æ®ä¸­çš„contexté¡¹æ ¼å¼ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç”¨ åŒæ¢è¡Œç¬¦è¿›è¡Œåˆ†éš”è¿æ¥ã€‚æ•°æ®å˜ä¸º <code>{input:XXX, context:doc_str}</code></li>
<li><code>prompt</code>ï¼š é€å…¥promptï¼Œpromptçš„invokeæ–¹æ³•ä¸­æœ¬è´¨å°±æ˜¯å¯¹ templateå­—ç¬¦ä¸²å’Œ ä¸Šä¸€æ­¥è®¡ç®—å‡ºçš„æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ã€‚</li>
<li><code>llm</code>ï¼šæ¨¡å‹ç»™å‡ºå“åº”</li>
<li><code>_output_parser</code> æœ¬è´¨å°±æ˜¯å¯¹ è¾“å‡ºçš„responseæ¶ˆæ¯è¿›è¡Œæ ¼å¼åŒ–ï¼Œæœ¬è´¨å°±æ˜¯æå–æ¶ˆæ¯ä¸­çš„keyä¸º&quot;text&quot;å¯¹åº”çš„å±æ€§ã€‚</li>
</ol>
</li>
</ol>
<p><strong>ç›¸å…³å…³é”®ä»£ç å¦‚ä¸‹</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>response<span style="color:#5bc4bf">=</span>retriever<span style="color:#5bc4bf">.</span>invoke(input<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;&#34;&#34;image processing with an introduction to techniques for image pattern classification&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#776e71">#langchain_classic/chains/retrieval.py:64</span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">if</span> <span style="color:#5bc4bf">not</span> isinstance(retriever, BaseRetriever):  
</span></span><span style="display:flex;"><span>    retrieval_docs: Runnable[dict, RetrieverOutput] <span style="color:#5bc4bf">=</span> retriever  
</span></span><span style="display:flex;"><span><span style="color:#815ba4">else</span>:  
</span></span><span style="display:flex;"><span>    retrieval_docs <span style="color:#5bc4bf">=</span> (<span style="color:#815ba4">lambda</span> x: x[<span style="color:#48b685">&#34;input&#34;</span>]) <span style="color:#5bc4bf">|</span> retriever
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#815ba4">return</span> (  
</span></span><span style="display:flex;"><span>    RunnablePassthrough<span style="color:#5bc4bf">.</span>assign(  
</span></span><span style="display:flex;"><span>        context<span style="color:#5bc4bf">=</span>retrieval_docs<span style="color:#5bc4bf">.</span>with_config(run_name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;retrieve_documents&#34;</span>),  
</span></span><span style="display:flex;"><span>    )<span style="color:#5bc4bf">.</span>assign(answer<span style="color:#5bc4bf">=</span>combine_docs_chain)  
</span></span><span style="display:flex;"><span>)<span style="color:#5bc4bf">.</span>with_config(run_name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;retrieval_chain&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">def</span> <span style="color:#06b6ef">format_docs</span>(inputs: dict) <span style="color:#5bc4bf">-&gt;</span> str:  
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">return</span> document_separator<span style="color:#5bc4bf">.</span>join(  
</span></span><span style="display:flex;"><span>        format_document(doc, _document_prompt)  
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">for</span> doc <span style="color:#5bc4bf">in</span> inputs[document_variable_name]  
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#815ba4">return</span> (  
</span></span><span style="display:flex;"><span>    RunnablePassthrough<span style="color:#5bc4bf">.</span>assign(<span style="color:#5bc4bf">**</span>{document_variable_name: format_docs})<span style="color:#5bc4bf">.</span>with_config(  
</span></span><span style="display:flex;"><span>        run_name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;format_inputs&#34;</span>,  
</span></span><span style="display:flex;"><span>    )  
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">|</span> prompt  
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">|</span> llm  
</span></span><span style="display:flex;"><span>    <span style="color:#5bc4bf">|</span> _output_parser  
</span></span><span style="display:flex;"><span>)<span style="color:#5bc4bf">.</span>with_config(run_name<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;stuff_documents_chain&#34;</span>)
</span></span></code></pre></div><h4 id="project-05-advanced-rag-qa-project">Project 05 Advanced RAG Q&amp;A Project<a hidden class="anchor" aria-hidden="true" href="#project-05-advanced-rag-qa-project">#</a></h4>
<ol>
<li>create_retriever_tool
<ol>
<li>æœ¬è´¨å°±æ˜¯ å°†æ£€ç´¢ã€æ ¼å¼åŒ–ã€æ‹¼æ¥å·¥ä½œç»„è£…ä¸ºä¸€ä¸ªæ•´ä½“åŠŸèƒ½ç„¶åï¼Œå®ä¾‹åŒ–ä¸ºä¸€ä¸ªtoolã€‚</li>
</ol>
</li>
<li><strong>Scratchpad å«ä¹‰</strong>
<ul>
<li>ç›´è¯‘ä¸ºè‰ç¨¿çº¸</li>
<li>åœ¨ LangChain æˆ–ç±»ä¼¼æ¡†æ¶ä¸­ï¼Œ<code>scratchpad</code> é€šå¸¸æŒ‡ä»£ç†(Agent)çš„ä¸´æ—¶å·¥ä½œç©ºé—´ï¼Œç”¨äºï¼š
<ul>
<li>å­˜å‚¨ä¸­é—´æ€è€ƒè¿‡ç¨‹</li>
<li>è®°å½•å½“å‰ä»»åŠ¡çŠ¶æ€</li>
<li>ä¿å­˜ä¸´æ—¶è®¡ç®—ç»“æœ</li>
<li>è¿›è¡Œæ¨ç†å’Œå†³ç­–çš„ç¼“å†²åŒº</li>
</ul>
</li>
<li>è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„è®¡ç®—æœºç§‘å­¦æ¦‚å¿µï¼Œè¡¨ç¤ºä»»ä½•ç”¨äºä¸´æ—¶å­˜å‚¨å’Œå¤„ç†çš„å†…å­˜åŒºåŸŸã€‚</li>
</ul>
</li>
<li>æœ€ç»ˆtoolsæ˜¯åœ¨ <code>ollama._types.ChatRequest</code> è¿›è¡Œè§£æï¼Œå…·ä½“è§ä¸‹é¢ä»£ç ã€‚</li>
<li>è¿™é‡Œçš„llmèµ°çš„æ˜¯chatç±»å‹çš„llmï¼Œæ‰€ä»¥åº•å±‚æ˜¯èµ° <code>/api/chat</code> æ¥å£ï¼Œè¯¥æ¥å£çš„å‚æ•°åˆ—è¡¨ä¸­å«æœ‰toolsã€‚ç›¸å½“äºè¯¥æ¥å£å·²ç»æŠŠtoolsçš„æè¿°å¦‚ä½•æ ¼å¼åŒ–éƒ½å·²ç»åœ¨å†…éƒ¨è§£å†³æ‰ï¼Œä¸éœ€è¦è°ƒç”¨æ–¹å°†toolsçš„æè¿°æ ¼å¼åŒ–åˆ° prompté‡Œé¢ã€‚</li>
<li>AgentExecutoré‡Œæœ€é‡è§†ä¾èµ– <code>iter</code>æ–¹æ³•æ¥ä¸æ–­è¿­ä»£ï¼Œåº•å±‚æ˜¯ä¾èµ–<code>_iter_next_step</code>æ¥è¿›è¡Œ thoughtã€actionæ­¥éª¤çš„ã€‚</li>
<li>å³chat_modelçš„æ¥å£éƒ½æ˜¯æ”¯æŒåœ¨è¯·æ±‚ä¸­åŠ å…¥toolså‚æ•°çš„ã€‚</li>
<li>prompt hub
<ol>
<li><a href="https://smith.langchain.com/hub/hwchase17/openai-functions-agent" target="_blank" rel="noopener" style="color:#42b983";>https://smith.langchain.com/hub/hwchase17/openai-functions-agent</a></li>
</ol>
</li>
<li><a href="https://platform.openai.com/docs/guides/function-calling" target="_blank" rel="noopener" style="color:#42b983";>å‡½æ•°è°ƒç”¨ - OpenAI API &mdash; Function calling - OpenAI API</a></li>
</ol>
<p><strong>ç›¸å…³å…³é”®ä»£ç å¦‚ä¸‹</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#776e71">#Runnableçš„æ–¹æ³•</span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">def</span> <span style="color:#06b6ef">bind</span>(self, <span style="color:#5bc4bf">**</span>kwargs: Any) <span style="color:#5bc4bf">-&gt;</span> Runnable[Input, Output]:  
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;&#34;&#34;Bind arguments to a `Runnable`, returning a new `Runnable`.  
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">  
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">    Useful when a `Runnable` in a chain requires an argument that is not    in the output of the previous `Runnable` or included in the user input.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#776e71">#langchain_ollama.chat_models.ChatOllama._create_chat_stream</span>
</span></span><span style="display:flex;"><span><span style="color:#776e71"># ollama/_client.py:351</span>
</span></span><span style="display:flex;"><span><span style="color:#776e71"># ollama._client.Client.chat</span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">return</span> self<span style="color:#5bc4bf">.</span>_request(  
</span></span><span style="display:flex;"><span>  ChatResponse,  
</span></span><span style="display:flex;"><span>  <span style="color:#48b685">&#39;POST&#39;</span>,  
</span></span><span style="display:flex;"><span>  <span style="color:#48b685">&#39;/api/chat&#39;</span>,  
</span></span><span style="display:flex;"><span>  json<span style="color:#5bc4bf">=</span>ChatRequest(  
</span></span><span style="display:flex;"><span>    model<span style="color:#5bc4bf">=</span>model,  
</span></span><span style="display:flex;"><span>    messages<span style="color:#5bc4bf">=</span>list(_copy_messages(messages)),  
</span></span><span style="display:flex;"><span>    tools<span style="color:#5bc4bf">=</span>list(_copy_tools(tools)),  
</span></span><span style="display:flex;"><span>    stream<span style="color:#5bc4bf">=</span>stream,  
</span></span><span style="display:flex;"><span>    think<span style="color:#5bc4bf">=</span>think,  
</span></span><span style="display:flex;"><span>    format<span style="color:#5bc4bf">=</span>format,  
</span></span><span style="display:flex;"><span>    options<span style="color:#5bc4bf">=</span>options,  
</span></span><span style="display:flex;"><span>    keep_alive<span style="color:#5bc4bf">=</span>keep_alive,  
</span></span><span style="display:flex;"><span>  )<span style="color:#5bc4bf">.</span>model_dump(exclude_none<span style="color:#5bc4bf">=</span><span style="color:#815ba4">True</span>),  
</span></span><span style="display:flex;"><span>  stream<span style="color:#5bc4bf">=</span>stream,  
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#776e71">#langchain_classic.agents.agent.AgentExecutor._iter_next_step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> <span style="color:#06b6ef">_iter_next_step</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        name_to_tool_map: dict[str, BaseTool],
</span></span><span style="display:flex;"><span>        color_mapping: dict[str, str],
</span></span><span style="display:flex;"><span>        inputs: dict[str, str],
</span></span><span style="display:flex;"><span>        intermediate_steps: list[tuple[AgentAction, str]],
</span></span><span style="display:flex;"><span>        run_manager: CallbackManagerForChainRun <span style="color:#5bc4bf">|</span> <span style="color:#815ba4">None</span> <span style="color:#5bc4bf">=</span> <span style="color:#815ba4">None</span>,
</span></span><span style="display:flex;"><span>    ) <span style="color:#5bc4bf">-&gt;</span> Iterator[AgentFinish <span style="color:#5bc4bf">|</span> AgentAction <span style="color:#5bc4bf">|</span> AgentStep]:
</span></span><span style="display:flex;"><span>        <span style="color:#48b685">&#34;&#34;&#34;Take a single step in the thought-action-observation loop.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        Override this to take control of how the agent makes and acts on choices.
</span></span></span><span style="display:flex;"><span><span style="color:#48b685">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">try</span>:
</span></span><span style="display:flex;"><span>            intermediate_steps <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>_prepare_intermediate_steps(intermediate_steps)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#776e71"># Call the LLM to see what to do.</span>
</span></span><span style="display:flex;"><span>            output <span style="color:#5bc4bf">=</span> self<span style="color:#5bc4bf">.</span>_action_agent<span style="color:#5bc4bf">.</span>plan(
</span></span><span style="display:flex;"><span>                intermediate_steps,
</span></span><span style="display:flex;"><span>                callbacks<span style="color:#5bc4bf">=</span>run_manager<span style="color:#5bc4bf">.</span>get_child() <span style="color:#815ba4">if</span> run_manager <span style="color:#815ba4">else</span> <span style="color:#815ba4">None</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5bc4bf">**</span>inputs,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">except</span> OutputParserException <span style="color:#815ba4">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#5bc4bf">......</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#776e71"># If the tool chosen is the finishing tool, then we end and return.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">if</span> isinstance(output, AgentFinish):
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">yield</span> output
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        actions: list[AgentAction]
</span></span><span style="display:flex;"><span>        actions <span style="color:#5bc4bf">=</span> [output] <span style="color:#815ba4">if</span> isinstance(output, AgentAction) <span style="color:#815ba4">else</span> output
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">for</span> agent_action <span style="color:#5bc4bf">in</span> actions:
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">yield</span> agent_action
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">for</span> agent_action <span style="color:#5bc4bf">in</span> actions:
</span></span><span style="display:flex;"><span>            <span style="color:#815ba4">yield</span> self<span style="color:#5bc4bf">.</span>_perform_agent_action(
</span></span><span style="display:flex;"><span>                name_to_tool_map,
</span></span><span style="display:flex;"><span>                color_mapping,
</span></span><span style="display:flex;"><span>                agent_action,
</span></span><span style="display:flex;"><span>                run_manager,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        <span style="color:#5bc4bf">...</span>
</span></span></code></pre></div><h4 id="project-06-groq-inference">Project 06 Groq inference<a hidden class="anchor" aria-hidden="true" href="#project-06-groq-inference">#</a></h4>
<ol>
<li>æœ¬åœ°æœåŠ¡å’Œè¿œç¨‹æœåŠ¡çš„ä»£ç†è®¾ç½®ï¼Œå¦‚ä¸‹é¢ä»£ç 
<ol>
<li>HTTP_PROXY å’Œ HTTPS_PROXYç”¨äºè®¾ç½®é€šè¿‡httpæœåŠ¡çš„ä»£ç†</li>
<li>NO_PROXY ç”¨äºæœ¬åœ°æœåŠ¡ç»•è¿‡ä¸Šé¢è®¾ç½®çš„ä»£ç†ï¼Œå¦‚æœ¬åœ°çš„OllamaæœåŠ¡ã€‚</li>
</ol>
</li>
<li><code>vectorstore.as_retriever</code> å¯ä»¥ç›´æ¥è½¬æ¢ä¸ºæ£€ç´¢å™¨
<ol>
<li>æ–¹æ³•å‚æ•°<code>search_kwargs</code> ä¸­ä¹Ÿå¯ä»¥è®¾ç½®è¿”å›çš„æ–‡æ¡£æ•°ç›®kã€MMRå¤šæ ·æ€§ç®—æ³•ã€å…ƒæ•°æ®è¿‡æ»¤å™¨å‡½æ•°ç­‰ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#5bc4bf">import</span> <span style="color:#fec418">os</span>  
</span></span><span style="display:flex;"><span><span style="color:#776e71"># è®¾ç½®httpçš„ä»£ç†å’Œä¸ä»£ç†çš„åœ°å€  </span>
</span></span><span style="display:flex;"><span>os<span style="color:#5bc4bf">.</span>environ[<span style="color:#48b685">&#39;HTTP_PROXY&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;http://127.0.0.1:7890&#34;</span>  
</span></span><span style="display:flex;"><span>os<span style="color:#5bc4bf">.</span>environ[<span style="color:#48b685">&#39;HTTPS_PROXY&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;http://127.0.0.1:7890&#34;</span>  
</span></span><span style="display:flex;"><span>os<span style="color:#5bc4bf">.</span>environ[<span style="color:#48b685">&#39;NO_PROXY&#39;</span>] <span style="color:#5bc4bf">=</span> <span style="color:#48b685">&#34;http://127.0.0.1:11434&#34;</span> <span style="color:#776e71">#ollamaçš„æœ¬åœ°æœåŠ¡åœ°å€</span>
</span></span></code></pre></div><h4 id="project-07-gen-ai">Project 07 Gen AI<a hidden class="anchor" aria-hidden="true" href="#project-07-gen-ai">#</a></h4>
<ol>
<li>HuggingFaceEndpoint æ¥å£é—®é¢˜
<ol>
<li>bug  <a href="https://github.com/langchain-ai/langchain/issues/31434#issuecomment-2936308959" target="_blank" rel="noopener" style="color:#42b983";>https://github.com/langchain-ai/langchain/issues/31434#issuecomment-2936308959</a></li>
<li>å› ä¸ºå®˜æ–¹æœåŠ¡ä¸å†æä¾› text-generationçš„æ¨¡å‹æœåŠ¡ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨ ChatHuggingFaceæ¥ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚</li>
</ol>
</li>
</ol>
<h4 id="project-08-powerful-doc-qa-chatbot">Project 08 Powerful Doc Q&amp;A Chatbot<a hidden class="anchor" aria-hidden="true" href="#project-08-powerful-doc-qa-chatbot">#</a></h4>
<ol>
<li>OllamaEmbeddings åœ¨æœ¬åœ°çš„ç¬”è®°æœ¬ä¸Šå¯¹äº4ç¯‡è®ºæ–‡çš„è®¡ç®—éå¸¸æ…¢ã€‚
<ol>
<li>ä½¿ç”¨äº†HuggingFaceEmbeddingsåŠ ä¸€ä¸ªå°embæ¨¡å‹è®¡ç®—æ—¶é—´å˜å°‘äº†å¾ˆå¤šã€‚</li>
</ol>
</li>
</ol>
<h4 id="project-09-advance-qa-chatbot">Project 09 Advance Q&amp;A Chatbot<a hidden class="anchor" aria-hidden="true" href="#project-09-advance-qa-chatbot">#</a></h4>
<ol>
<li>langchain-ObjectBox ç‰ˆæœ¬å¤ªè€ï¼Œæ²¡æ³•å®‰è£…ã€‚è¯¥æ•°æ®åº“ ObjectBox ç»´æŠ¤ä¼¼ä¹ä¸æ˜¯å¾ˆå¤šã€‚</li>
</ol>
<h4 id="project-11-imageenhancer">Project 11 ImageEnhancer<a hidden class="anchor" aria-hidden="true" href="#project-11-imageenhancer">#</a></h4>
<ol>
<li>model_scope å…¼å®¹æ¥å£
<ol>
<li><a href="https://modelscope.cn/docs/model-service/API-Inference/intro" target="_blank" rel="noopener" style="color:#42b983";>APIæ¨ç†ä»‹ç» Â· æ–‡æ¡£ä¸­å¿ƒ</a></li>
<li>å…¼å®¹openaiæ¥å£</li>
</ol>
</li>
<li>streamlit åº”ç”¨ debug
<ol>
<li>é€‰æ‹©module streamlit</li>
<li>å‚æ•°å¡«å†™ run app.py</li>
<li>working directory å¡«å†™app.pyçš„ç›®å½•</li>
</ol>
</li>
<li>ä½¿ç”¨modelscopeæœåŠ¡æ¥ä»£æ›¿openaiçš„å›¾åƒç”Ÿæˆæ¥å£ã€‚
<ol>
<li>æ–‡ç”Ÿå›¾æ¨¡å‹ æ”¯æŒAPIè°ƒç”¨çš„æ¨¡å‹åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡<a href="https://www.modelscope.cn/aigc/models" target="_blank" rel="noopener" style="color:#42b983";>AIGCæ¨¡å‹</a>é¡µé¢è¿›è¡Œæœç´¢ã€‚</li>
<li>ä¸Šè¿°é¡µé¢ä¸­åˆ—å‡ºçš„å¾ˆå¤šæ¨¡å‹éƒ½å¾®è°ƒçš„å¾ˆå·®ï¼Œä½¿ç”¨åç”Ÿæˆç»“æœå¾ˆå¤šå¹¶ä¸èƒ½éµä»æŒ‡ä»¤ã€‚</li>
</ol>
</li>
<li>è°ƒæ•´äº† gpu_memory_utilization ä»0.9 åˆ°0.95
<ol>
<li>æŠ¥é”™
<ol>
<li><code>ValueError: To serve at least one request with the models's max seq len (40960), (5.62 GiB KV cache is needed, which is larger than the available KV cache memory (4.81 GiB).</code></li>
</ol>
</li>
<li>å·®ä¸€ç‚¹å†…å­˜ï¼Œæ‰€ä»¥å¢åŠ äº†gpuçš„åˆ©ç”¨ç‡ã€‚</li>
<li>ä»è¿™ç‚¹çœ‹ï¼Œå¤§æ¨¡å‹ä¸€æ¬¡æ¨ç†éå¸¸æ¶ˆè€—æ˜¾å­˜ã€‚</li>
<li>ä¸€æ¡æ•°æ®çš„æœ€å¤§æ˜¾å­˜æ¶ˆè€—
<ol>
<li><code>æ˜¾å­˜æ¶ˆè€—=2(key+value) * seq_len(40960) * model_layer * hidden_size * head_dim * 2(byte FP16)</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="p02-demo_simple_rag_py">P02 demo_simple_rag_py<a hidden class="anchor" aria-hidden="true" href="#p02-demo_simple_rag_py">#</a></h2>
<p><strong>è¯¥é¡¹ç›®å±•ç¤ºRAGåŸç†çš„æç®€ä»£ç </strong>ã€‚</p>
<ol>
<li>å‚è€ƒèµ„æ–™
<ol>
<li>å…³è”åšæ–‡ <a href="https://huggingface.co/blog/ngxson/make-your-own-rag" target="_blank" rel="noopener" style="color:#42b983";>Code a simple RAG from scratch</a></li>
<li>é¡¹ç›®ä»£ç  <a href="https://huggingface.co/ngxson/demo_simple_rag_py/blob/main/demo.py" target="_blank" rel="noopener" style="color:#42b983";>demo.py Â· ngxson/demo_simple_rag_py at main</a>
<ol>
<li>å¾ˆå¥½çš„å±•ç¤ºRAGåŸç†æ€§çš„å°demoï¼Œä¸éœ€è¦å®‰è£…å‘é‡æ•°æ®åº“ã€‚</li>
</ol>
</li>
</ol>
</li>
<li>æ¨¡å‹ID bartowski/Llama-3.2-1B-Instruct-GGUF è¿™ä¸ªæ¨¡å‹ä¸­çš„instructçš„æ„æ€
<ol>
<li>instructæ„æ€å°±æ˜¯æŒ‡æ¨¡å‹æ˜¯ç»è¿‡ åœ¨base modelä¸Šç»è¿‡æŒ‡ä»¤å¾®è°ƒï¼ˆæˆ–è€…å«ç›‘ç£å¾®è°ƒï¼‰è¿‡ç¨‹ä¹‹åäº§ç”Ÿçš„æ¨¡å‹ï¼Œå¯ä»¥ç›´æ¥ç”¨äºèŠå¤©ã€åŠ©æ‰‹ç±»åº”ç”¨</li>
</ol>
</li>
<li><strong>Ollamaé—®é¢˜</strong>
<ol>
<li>æ¨¡å‹ä¸‹è½½é—®é¢˜  ollama æ‹‰å–hf.co ç½‘ç«™çš„æ¨¡å‹å¤±è´¥
<ol>
<li><code>Ollama pull è¿›åº¦å·²ç»100%ï¼Œ ä½†ä¸ºä»€ä¹ˆä¼šæŠ¥å¦‚ä¸‹é”™è¯¯</code>
<ol>
<li><code>Error: max retries exceeded: Get &quot;https://huggingface.co/v2/bartowski/Llama-3.2-1B-Instruct-GGUF/blobs/sha256:948af2743fc78a328dcb3b0f5a31b3d75f415840fdb699e8b1235978392ecf85?__sign=eyJhbGciOiJFZERTQSJ9.eyJyZWFkIjp0cnVlLCJwZXJtaXNzaW9ucyI6eyJyZXBvLmNvbnRlbnQucmVhZCI6dHJ1ZX0sImlhdCI6MTc2Mjc1MzA3Niwic3ViIjoiL2JhcnRvd3NraS9MbGFtYS0zLjItMUItSW5zdHJ1Y3QtR0dVRiIsImV4cCI6MTc2Mjc1MzY3NiwiaXNzIjoiaHR0cHM6Ly9odWdnaW5nZmFjZS5jbyJ9.wVhqKCuc0vtHoS8DUStd86RoS1dhE0e-IqqMIpLZ_mEbfz6ahWeaoQiuTpWuaJCels7Q7uIIwEky9DhHsynYCg&quot;: dial tcp 54.89.135.129:443: connect: connection refused</code></li>
</ol>
</li>
<li>æ£€æŸ¥ç½‘ç»œæ˜¯å¯ä»¥è¿æ¥ hf.coç½‘ç«™çš„ã€‚</li>
<li>æ‰¾ä¸åˆ°åŸå› ã€‚</li>
</ol>
</li>
<li>ollama ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–ã€‚ <a href="https://docs.ollama.com/import#quantizing-a-model" target="_blank" rel="noopener" style="color:#42b983";>quantizing-a-model - Ollama</a></li>
<li>ollamaå¯¹ä»“åº“æ¨¡å‹çš„é€‰æ‹©
<ol>
<li>ollama run model_repo_idï¼Œå¦‚æœrepoä¸­æœ‰å¤šç‰ˆæœ¬æ¨¡å‹ï¼Œé‚£ä¹ˆollamaä¼šé€‰æ‹©Q4ç‰ˆæœ¬çš„ã€‚æ›´å¥½çš„æ–¹æ³•æ˜¯æ˜¾å¼æŒ‡å®šå…·ä½“ç‰ˆæœ¬ <code>ollama run hf.co/{username}/{repository}:{quantization}</code>
<ol>
<li>æ¯”å¦‚ <code>ollama run hf.co/bartowski/Llama-3.2-3B-Instruct-GGUF:Llama-3.2-3B-Instruct-IQ3_M.gguf</code></li>
</ol>
</li>
<li>å‚è€ƒèµ„æ–™ <a href="https://huggingface.co/docs/hub/en/ollama" target="_blank" rel="noopener" style="color:#42b983";>Use Ollama with any GGUF Model on Hugging Face Hub</a></li>
</ol>
</li>
</ol>
</li>
<li><strong>æ¨¡å‹æ–‡ä»¶é—®é¢˜</strong>
<ol>
<li>GGUF æ–‡ä»¶åŒ…å«äº†tokenizerçš„æ•°æ®ã€‚</li>
<li><strong>æ¨¡å‹çš„Ollamaæ„å»ºæ–¹æ³•</strong>ï¼šæ‰‹åŠ¨ä¸‹è½½ggufæ¨¡å‹æ–‡ä»¶ï¼Œç„¶åæœ¬åœ°è¿›è¡Œollamaæ‰‹åŠ¨æ„å»ºã€‚
<ol>
<li>æ‰‹åŠ¨ä¸‹è½½ <a href="https://huggingface.co/bartowski/Llama-3.2-1B-Instruct-GGUF/tree/main" target="_blank" rel="noopener" style="color:#42b983";>https://huggingface.co/bartowski/Llama-3.2-1B-Instruct-GGUF/tree/main</a> ä¸­çš„ Llama-3.2-1B-Instruct-Q4_K_M.ggufæ–‡ä»¶ã€‚</li>
<li>ç„¶åæ ¹æ®æ–‡æ¡£<a href="https://docs.ollama.com/import#importing-a-gguf-based-model-or-adapter" target="_blank" rel="noopener" style="color:#42b983";>Importing a Model - Ollama</a>æ¥å¯¼å…¥åˆ°æœ¬åœ°ollamaçš„ç¼“å­˜ç›®å½•ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç©ºç›®å½•</li>
<li>åˆ›å»º ModelFileæ–‡ä»¶ï¼Œå†…å®¹ä¸º <code>FROM ./Llama-3.2-1B-Instruct-Q4_K_M.gguf</code></li>
<li>æ‰§è¡Œå‘½ä»¤<code>ollama create bartowski/Llama-3.2-1B-Instruct-GGUF</code></li>
<li>æ¨¡å‹å°±å¯ä»¥è¢«æ„å»ºç¼“å¹¶å¤åˆ¶åˆ° ollamaçš„ç¼“å­˜ç›®å½•ä¸­ã€‚</li>
<li>å¹¶åŒæ ·æ„å»º bge-base-en-v1.5-q4_k_m.gguf æ¨¡å‹</li>
<li><code>ollama.embed(model=&quot;CompendiumLabs/bge-base-en-v1.5-gguf&quot;)</code>
<ol>
<li>è¿™é‡Œçš„æ¨¡å‹åæŒ‰ç…§/æ¥åˆ†å‰²ï¼Œå³è¯´æ˜æ˜¯æœ¬åœ°æ–‡ä»¶çš„æ¨¡å‹ã€‚</li>
<li>å¦‚æœæ˜¯æ­£å¸¸çš„:åˆ†å‰²çš„æ¨¡å‹åï¼Œåˆ™ollamaä¼šè‡ªåŠ¨ä»ç¼“å­˜ç›®å½•ä¸­çš„ libraryå­ç›®å½•ä¸­æŸ¥æ‰¾ã€‚</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>åœ¨ChatModelçš„streamæ¨¡å¼ä¸‹ï¼Œè¿”å›æ˜¯ä¸€ä¸ªè¯ä¸€ä¸ªè¯çš„è¿›è¡Œè¿”å›çš„ã€‚</li>
<li>åœ¨è¯¥demoç¤ºä¾‹ä¸­ï¼Œæ£€ç´¢åˆ°çš„æ–‡æ¡£æ˜¯å…¨è¢«å¡åˆ°ä¸€ä¸ªsystem messageä¸‹ï¼Œç„¶ååç»­çš„å¯¹è¯ä½†å°±æ˜¯æ ¹æ®æ­¤æ¥è¿›è¡Œäº¤äº’ã€‚</li>
</ol>
<h2 id="p03-rag-optimization-practices">P03 RAG-Optimization-Practices<a hidden class="anchor" aria-hidden="true" href="#p03-rag-optimization-practices">#</a></h2>
<h4 id="é¡¹ç›®åŸç†å’Œç»“æœ">é¡¹ç›®åŸç†å’Œç»“æœ<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®åŸç†å’Œç»“æœ">#</a></h4>
<ol>
<li>ç›¸å…³èµ„æ–™
<ol>
<li>é¡¹ç›®æ¥æº <a href="https://github.com/kanhaoning/RAG-Optimization-Practices" target="_blank" rel="noopener" style="color:#42b983";>kanhaoning/RAG-Optimization-Practices</a></li>
<li><a href="https://sbert.net/docs/quickstart.html#sentence-transformer" target="_blank" rel="noopener" style="color:#42b983";>Quickstart â€” Sentence Transformers documentation</a>
<ol>
<li>å®˜æ–¹æ–‡æ¡£å¾ˆä¸é”™ã€‚</li>
</ol>
</li>
</ol>
</li>
<li>é˜¿é‡Œäº‘æœåŠ¡å™¨
<ol>
<li>uv ä¸‹è½½ç»å¸¸è¶…æ—¶çš„è§£å†³æ–¹æ¡ˆï¼Œéå¸¸å¥½ç”¨ã€‚
<ol>
<li><code>export UV_HTTP_TIMEOUT=240</code></li>
<li><code>export UV_CONCURRENT_DOWNLOADS=2</code></li>
</ol>
</li>
<li>å¦‚ä½•åŠ å¿«å®‰è£…uvç¯å¢ƒã€ç¼“å­˜
<ol>
<li>åœ¨ä¸€å°ä¾¿å®œçš„æœºå™¨ä¸Šä½¿ç”¨uvæ¥æ„å»ºä¸€ä¸ªdummyé¡¹ç›®ï¼Œuvçš„ç¼“å­˜å°±ä¼šç•™ä¸‹ã€‚</li>
<li>rsync uvç¼“å­˜ç›®å½•åˆ° ç›®æ ‡æœåŠ¡å™¨çš„uvç¼“å­˜ç›®å½•ä¸‹ã€‚åŒä¸€ä¸ªvpcä¸‹ä¸¤ä¸ªæœåŠ¡å™¨çš„rsyncé€Ÿåº¦éå¸¸å¿«ï¼Œ300M/sã€‚å¹¶ä¸”rsyncä¼šä¿æŒæ–‡ä»¶çš„è½¯é“¾æ¥ã€‚</li>
<li>è¿™æ ·æ•´ä½“èŠ±é’±å°‘ï¼Œå¹¶ä¸”æ„å»ºé€Ÿåº¦å¿«ã€‚</li>
</ol>
</li>
</ol>
</li>
<li>Qwen-rerankerå’Œbertä¸€æ ·æ˜¯åŒå‘æ³¨æ„åŠ›è®¡ç®—æ–¹å¼ã€‚</li>
<li>å¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥</li>
<li>é˜¿é‡Œäº‘ossfsçš„ä»£ç å­˜æ¡£ã€‚
<ol>
<li>å®‰è£…ossfs
<ol>
<li><code>wget https://github.com/aliyun/ossfs/releases/download/v1.91.8/ossfs_1.91.8_ubuntu24.04_amd64.deb</code></li>
<li><code>sudo apt install ./ossfs_1.91.8_ubuntu24.04_amd64.deb</code></li>
</ol>
</li>
</ol>
</li>
<li>ç¯å¢ƒé…ç½®
<ol>
<li>A10 GPUï¼ˆæ˜¾å­˜24Gï¼‰</li>
</ol>
</li>
<li><strong>Reranker distillationæ•´ä½“æ­¥éª¤</strong>
<ol>
<li>è¯´æ˜
<ol>
<li>æ¨¡å‹æœ¬è´¨å°±æ˜¯cross-encoderï¼Œå³å°†QAè¿›è¡Œæ‹¼æ¥ï¼Œè¾“å…¥LLMè¿›è€Œå¾—åˆ°ç›¸ä¼¼åº¦ã€‚</li>
</ol>
</li>
<li>generate_logits ç”Ÿæˆ59ä¸‡æ¡æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰ï¼Œè¿è¡Œæ—¶é•¿ï¼ˆ250minï¼‰ã€‚
<ol>
<li>å³é’ˆå¯¹  query å’Œdoc ç”Ÿæˆä¸€ä¸ªlogprobåˆ†æ•°ï¼Œå³ <code>(query, passage, score)</code>ã€‚</li>
<li>logprobåˆ†æ•°åˆ©ç”¨äº† promptæ¨¡æ¿ + LLMçš„chatæ¥å£ è¿›è¡Œæ‰“åˆ†ã€‚ promptæ¨¡æ¿å¦‚ä¸‹ã€‚
<ol>
<li><code>Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be &quot;yes&quot; or &quot;no&quot;. </code></li>
<li><code>&lt;Instruct&gt;: {instruction}\n&lt;Query&gt;: {query}\n&lt;Document&gt;: {doc}</code></li>
<li>å…¶ä¸­ instructå˜é‡ä¸º <code>Given a web search query, retrieve relevant passages that answer the query</code></li>
</ol>
</li>
<li>prompt é™åˆ¶äº†è¾“å‡ºtokençš„èŒƒå›´ä¸º ä¸¤ä¸ªtoken ï¼ˆyes or noï¼‰ ã€‚</li>
<li>æ¨ç†ä½¿ç”¨ vLLMçš„sdkï¼ŒåŠ è½½æœ¬åœ°æ¨¡å‹æ–‡ä»¶ã€‚</li>
</ol>
</li>
<li>ä¸‰å…ƒç»„è’¸é¦æ•°æ®ï¼ˆè®­ç»ƒé›†+æµ‹è¯•é›†ï¼‰
<ol>
<li>ç”Ÿæˆä¸‰å…ƒç»„è’¸é¦æ•°æ® <code>(query, positive passage, negative passage, logits_diff)</code></li>
<li>æ­£æ ·æœ¬ä¸ºlogits æœ€é«˜top_ké‡ŒæŠ½æ ·ã€‚</li>
<li>è´Ÿæ ·æœ¬æŒ‰ç…§logitsæ’åº æ¯ä¸ªæ­£æ ·æœ¬ä½ç½®åé¢çš„æ ·æœ¬ã€‚</li>
<li>å³ä¸¤ä¸¤ç»„åˆï¼Œç»„åˆæ•°é‡ä¸º <code>n*(n-1)/2</code></li>
<li>å¹¶éä½¿ç”¨è¯¥é¡¹ç›®æ•°æ®é›†çœŸæ­£çš„åŸå§‹ ground-truth labelã€‚</li>
</ol>
</li>
<li>è®­ç»ƒ
<ol>
<li>åˆ©ç”¨ embeddingå°æ¨¡å‹ + ä¸‰å…ƒç»„è’¸é¦æ•°æ® è¿›è¡Œè®­ç»ƒï¼Œå°†é¢†åŸŸçŸ¥è¯†è’¸é¦è¿›å°æ¨¡å‹ã€‚</li>
</ol>
</li>
<li>è¯„ä¼°
<ol>
<li>å¯¹å¾®è°ƒå‰çš„æ¨¡å‹å’Œå¾®è°ƒåçš„æ¨¡å‹åˆ©ç”¨æµ‹è¯•é›†æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚</li>
</ol>
</li>
</ol>
</li>
<li><strong>Embedding-distillatioinæ•´ä½“æ­¥éª¤</strong>
<ol>
<li>è¯´æ˜
<ol>
<li>æ¨¡å‹å…¶å®å°±æ˜¯bi-encoderï¼Œå³æ¨¡å‹è¾“å‡ºembeddingï¼Œç„¶åè®¡ç®—QAç›¸ä¼¼åº¦ã€‚</li>
<li><a href="https://zhuanlan.zhihu.com/p/1933693856077026394" target="_blank" rel="noopener" style="color:#42b983";>ç”¨KLæ•£åº¦å°†Qwen3-Embedding-8Bå‘é‡å¤§æ¨¡å‹çŸ¥è¯†è’¸é¦ç»™å°æ¨¡å‹BGE-m3 - çŸ¥ä¹</a></li>
</ol>
</li>
<li>generate_logits
<ol>
<li>é’ˆå¯¹åŸå§‹æ•°æ®ä¸­æ¯ä¸€è¡Œä¸­çš„ ä¸€ä¸ªqueryã€å¤šä¸ªpositiveæ–‡æ¡£ã€å¤šä¸ªnegativeæ–‡æ¡£ åˆ†åˆ«è¾“å…¥ Qwen3-embeddingæ¨¡å‹ï¼Œå¾—åˆ°å‘é‡ã€‚</li>
<li>é’ˆå¯¹æ•°æ®å½¢å¼ <code>ï¼ˆqueryï¼ŒpositiveDocï¼Œ[negativeDoc,negativeDoc2ï¼Œ...]ï¼‰</code>ï¼Œåˆ†åˆ«è®¡ç®—queryå’Œæ¯ä¸ªdocçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œç„¶åå°† æ‰€æœ‰çš„ç›¸ä¼¼åº¦ è§†ä¸ºä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒã€‚</li>
</ol>
</li>
<li>train.sh
<ol>
<li>å¯¹äºå­¦ç”Ÿæ¨¡å‹åŒæ ·äº§ç”Ÿä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œå’Œè€å¸ˆæ¨¡å‹çš„åˆ†å¸ƒè®¡ç®—KLæŸå¤±ï¼Œè¿›è€Œè®­ç»ƒå­¦ç”Ÿæ¨¡å‹ã€‚</li>
</ol>
</li>
<li>è¯„ä¼°
<ol>
<li>åˆ©ç”¨é¢„ç•™çš„æµ‹è¯•é›†è¿›è¡Œè¯„ä¼°ã€‚</li>
</ol>
</li>
</ol>
</li>
<li><strong>uv ç¼“å­˜ç®¡ç†é—®é¢˜</strong>
<ol>
<li>å› ä¸º é¡¹ç›®ç›®å½•å’Œ uvç¼“å­˜ç›®å½•ä¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæ‰€ä»¥uvç¼“å­˜æ— æ³•é«˜æ•ˆè¿è½¬ï¼Œåªèƒ½åªç”¨ç¡¬å¤åˆ¶æ¥æ„å»ºvenvç¯å¢ƒã€‚æ‰€ä»¥éœ€è¦è¿ç§»uvç¼“å­˜åˆ°åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚
<ol>
<li>æ¸…ç†ç¼“å­˜é¡¹ç›®ï¼Œuvç®¡ç†ã€‚</li>
<li><code>du -sh ~/.cache/uv .venv</code> å¯ä»¥ç”¨æ¥ç»Ÿè®¡ venvæ˜¯å¦çœŸæ­£å¤šå ç”¨äº†å­˜å‚¨ã€‚</li>
<li>uv ç¼“å­˜è¿ç§»çš„æ—¶å€™ ä¸èƒ½ä½¿ç”¨ mv å’Œ cpå‘½ä»¤ï¼Œå¿…é¡»ä½¿ç”¨ <code>rsync -av</code> å‘½ä»¤ï¼Œä¸ç„¶æ— æ³•ä¿æŒ è½¯ç¡¬é“¾æ¥çš„å…³ç³»ã€‚</li>
<li>uv ç¼“å­˜ é€šè¿‡ .bashrc ç¯å¢ƒå˜é‡æ¥æŒ‡å®š <code>export UV_CACHE_DIR=/mnt/fast-ssd/uv-cache</code></li>
<li>ä¸Šè¿°å®Œæˆä¹‹åï¼Œé¡¹ç›®çš„uvæ„å»ºé€Ÿåº¦å¤§å¹…æå‡è‡³&lt;1ç§’ã€‚</li>
</ol>
</li>
</ol>
</li>
<li>CrossEncoder
<ol>
<li><a href="https://sbert.net/examples/cross_encoder/applications/README.html" target="_blank" rel="noopener" style="color:#42b983";>Cross-Encoders â€” Sentence Transformers documentation</a></li>
<li>Cross-Encoder achieve higher performance than Bi-Encoders, however, they do not scale well for large datasets. Here, it can make sense to combine Cross- and Bi-Encoders, for example in Information Retrieval / Semantic Search scenarios: First, you use an efficient Bi-Encoder to retrieve e.g. the top-100 most similar sentences for a query. Then, you use a Cross-Encoder to re-rank these 100 hits by computing the score for every (query, hit) combination.</li>
</ol>
</li>
</ol>
<p><strong>promptæ ¼å¼</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># promptæ ¼å¼
</span></span><span style="display:flex;"><span>message = [
</span></span><span style="display:flex;"><span>    {&#34;role&#34;: &#34;system&#34;, &#34;content&#34;: &#34;Judge whether the Document meets the requirements based on the Query and the Instruct provided. Note that the answer can only be \&#34;yes\&#34; or \&#34;no\&#34;.&#34;},
</span></span><span style="display:flex;"><span>    {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: f&#34;&lt;Instruct&gt;: {instruction}\n&lt;Query&gt;: {query}\n&lt;Document&gt;: {doc}&#34;}
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>#LLMé‡‡æ ·å‚æ•°ï¼Œåªå…è®¸ yes å’Œ no é€‰é¡¹çš„logproè¾“å‡ºã€‚
</span></span><span style="display:flex;"><span>    # å®šä¹‰å›ºå®šçš„ token å’Œé‡‡æ ·å‚æ•°
</span></span><span style="display:flex;"><span>    true_token = tokenizer(&#34;yes&#34;, add_special_tokens=False).input_ids[0]
</span></span><span style="display:flex;"><span>    false_token = tokenizer(&#34;no&#34;, add_special_tokens=False).input_ids[0]
</span></span><span style="display:flex;"><span>    sampling_params = SamplingParams(
</span></span><span style="display:flex;"><span>        temperature=0,
</span></span><span style="display:flex;"><span>        max_tokens=1,
</span></span><span style="display:flex;"><span>        logprobs=20,
</span></span><span style="display:flex;"><span>        allowed_token_ids=[true_token, false_token],
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p><strong>rerankerè’¸é¦è¯„ä¼°ç»“æœ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#776e71"># reranker è’¸é¦è®­ç»ƒä¹‹åçš„è¯„ä¼°ç»“æœ</span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">(</span>rag-optimization-practices<span style="color:#5bc4bf">)</span> root@dsw-1457330-845c588466-dwlc9:/mnt/workspace/large_model_demo/RAG/RAG-Level-02/P03-RAG-Optimization-Practices/Reranker-Distillation# bash evaluate.sh 
</span></span><span style="display:flex;"><span>æ­£åœ¨ä» data/test.jsonl åŠ è½½æ•°æ®é›†...
</span></span><span style="display:flex;"><span>åŠ è½½å®Œæˆï¼å…± <span style="color:#f99b15">2992</span> æ¡æ ·æœ¬ã€‚
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: /mnt/workspace/modelscope/BAAI/bge-reranker-v2-m3 ---
</span></span><span style="display:flex;"><span>--- æ­£åœ¨åŠ è½½å¹¶è¯„ä¼°æ¨¡å‹: ./output/checkpoint-1217 ---
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">==================================================</span>
</span></span><span style="display:flex;"><span>âœ… <span style="color:#ef6155">æœ€ç»ˆè¯„ä¼°ç»“æœæ±‡æ€»</span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">==================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ã€è’¸é¦å‰ã€‘æ¨¡å‹æ€§èƒ½:
</span></span><span style="display:flex;"><span>  - MAP: 0.472061
</span></span><span style="display:flex;"><span>  - MRR@10: 0.478234
</span></span><span style="display:flex;"><span>  - NDCG@10: 0.547284
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ã€è’¸é¦åã€‘æ¨¡å‹æ€§èƒ½:
</span></span><span style="display:flex;"><span>  - MAP: 0.564523
</span></span><span style="display:flex;"><span>  - MRR@10: 0.573106
</span></span><span style="display:flex;"><span>  - NDCG@10: 0.638634
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">==================================================</span>
</span></span><span style="display:flex;"><span>ğŸš€ æ€§èƒ½å˜åŒ–åˆ†æ <span style="color:#5bc4bf">(</span>è’¸é¦å vs. è’¸é¦å‰<span style="color:#5bc4bf">)</span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">==================================================</span>
</span></span><span style="display:flex;"><span>æŒ‡æ ‡ <span style="color:#5bc4bf">[</span>MAP<span style="color:#5bc4bf">]</span>:
</span></span><span style="display:flex;"><span>  - ç»å¯¹æå‡: +0.092462
</span></span><span style="display:flex;"><span>  - ç›¸å¯¹æå‡: +19.59% â†‘
</span></span><span style="display:flex;"><span>æŒ‡æ ‡ <span style="color:#5bc4bf">[</span>MRR@10<span style="color:#5bc4bf">]</span>:
</span></span><span style="display:flex;"><span>  - ç»å¯¹æå‡: +0.094872
</span></span><span style="display:flex;"><span>  - ç›¸å¯¹æå‡: +19.84% â†‘
</span></span><span style="display:flex;"><span>æŒ‡æ ‡ <span style="color:#5bc4bf">[</span>NDCG@10<span style="color:#5bc4bf">]</span>:
</span></span><span style="display:flex;"><span>  - ç»å¯¹æå‡: +0.091349
</span></span><span style="display:flex;"><span>  - ç›¸å¯¹æå‡: +16.69% â†‘
</span></span><span style="display:flex;"><span>è¯„ä¼°å®Œæˆï¼âœ¨
</span></span></code></pre></div><p><strong>embeddingè’¸é¦è¯„ä¼°ç»“æœ</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>(rag<span style="color:#5bc4bf">-</span>optimization<span style="color:#5bc4bf">-</span>practices) root<span style="color:#5bc4bf">@dsw</span><span style="color:#5bc4bf">-</span><span style="color:#f99b15">1457330</span><span style="color:#5bc4bf">-</span><span style="color:#f99b15">845</span>c588466<span style="color:#5bc4bf">-</span>dwlc9:<span style="color:#5bc4bf">/</span>mnt<span style="color:#5bc4bf">/</span>workspace<span style="color:#5bc4bf">/</span>large_model_demo<span style="color:#5bc4bf">/</span>RAG<span style="color:#5bc4bf">/</span>RAG<span style="color:#5bc4bf">-</span>Level<span style="color:#5bc4bf">-</span><span style="color:#f99b15">02</span><span style="color:#5bc4bf">/</span>P03<span style="color:#5bc4bf">-</span>RAG<span style="color:#5bc4bf">-</span>Optimization<span style="color:#5bc4bf">-</span>Practices<span style="color:#5bc4bf">/</span>Embedding<span style="color:#5bc4bf">-</span>Distillation<span style="color:#776e71"># bash evaluation.sh </span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>æ¨¡å‹æ€§èƒ½å¯¹æ¯”è¯„ä¼°
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------</span>
</span></span><span style="display:flex;"><span>é¢†åŸŸå†…æ•°æ®é›†è¯„ä¼°
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ¨¡å‹: <span style="color:#5bc4bf">/</span>mnt<span style="color:#5bc4bf">/</span>workspace<span style="color:#5bc4bf">/</span>modelscope<span style="color:#5bc4bf">/</span>BAAI<span style="color:#5bc4bf">/</span>bge<span style="color:#5bc4bf">-</span>m3
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ•°æ®é›†: data<span style="color:#5bc4bf">/</span>dataset_scidocs<span style="color:#5bc4bf">/</span>test<span style="color:#5bc4bf">.</span>jsonl
</span></span><span style="display:flex;"><span>æˆåŠŸåŠ è½½ <span style="color:#f99b15">3978</span> æ¡æ ·æœ¬
</span></span><span style="display:flex;"><span>å¼€å§‹è¯„ä¼°<span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">63</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">63</span> [<span style="color:#f99b15">00</span>:<span style="color:#f99b15">06</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>,  <span style="color:#f99b15">9.34</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">1854</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">1854</span> [<span style="color:#f99b15">03</span>:<span style="color:#f99b15">29</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>,  <span style="color:#f99b15">8.85</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ¨¡å‹: output<span style="color:#5bc4bf">/</span>checkpoint<span style="color:#5bc4bf">-</span><span style="color:#f99b15">477</span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ•°æ®é›†: data<span style="color:#5bc4bf">/</span>dataset_scidocs<span style="color:#5bc4bf">/</span>test<span style="color:#5bc4bf">.</span>jsonl
</span></span><span style="display:flex;"><span>æˆåŠŸåŠ è½½ <span style="color:#f99b15">3978</span> æ¡æ ·æœ¬
</span></span><span style="display:flex;"><span>å¼€å§‹è¯„ä¼°<span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">63</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">63</span> [<span style="color:#f99b15">00</span>:<span style="color:#f99b15">06</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>,  <span style="color:#f99b15">9.28</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">1854</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">1854</span> [<span style="color:#f99b15">03</span>:<span style="color:#f99b15">34</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>,  <span style="color:#f99b15">8.63</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------</span>
</span></span><span style="display:flex;"><span>é¢†åŸŸå¤–æ•°æ®é›†è¯„ä¼°
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ¨¡å‹: <span style="color:#5bc4bf">/</span>mnt<span style="color:#5bc4bf">/</span>workspace<span style="color:#5bc4bf">/</span>modelscope<span style="color:#5bc4bf">/</span>BAAI<span style="color:#5bc4bf">/</span>bge<span style="color:#5bc4bf">-</span>m3
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ•°æ®é›†: data<span style="color:#5bc4bf">/</span>dataset_stackoverflowdupquestions<span style="color:#5bc4bf">/</span>test<span style="color:#5bc4bf">.</span>jsonl
</span></span><span style="display:flex;"><span>æˆåŠŸåŠ è½½ <span style="color:#f99b15">2992</span> æ¡æ ·æœ¬
</span></span><span style="display:flex;"><span>å¼€å§‹è¯„ä¼°<span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">47</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">47</span> [<span style="color:#f99b15">00</span>:<span style="color:#f99b15">04</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>, <span style="color:#f99b15">10.51</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">1398</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">1398</span> [<span style="color:#f99b15">01</span>:<span style="color:#f99b15">56</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>, <span style="color:#f99b15">12.03</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ¨¡å‹: output<span style="color:#5bc4bf">/</span>checkpoint<span style="color:#5bc4bf">-</span><span style="color:#f99b15">477</span>
</span></span><span style="display:flex;"><span>æ­£åœ¨åŠ è½½æ•°æ®é›†: data<span style="color:#5bc4bf">/</span>dataset_stackoverflowdupquestions<span style="color:#5bc4bf">/</span>test<span style="color:#5bc4bf">.</span>jsonl
</span></span><span style="display:flex;"><span>æˆåŠŸåŠ è½½ <span style="color:#f99b15">2992</span> æ¡æ ·æœ¬
</span></span><span style="display:flex;"><span>å¼€å§‹è¯„ä¼°<span style="color:#5bc4bf">...</span>
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">47</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">47</span> [<span style="color:#f99b15">00</span>:<span style="color:#f99b15">04</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>, <span style="color:#f99b15">10.15</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>Batches: <span style="color:#f99b15">100</span><span style="color:#5bc4bf">%|</span><span style="color:#ef6155">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</span><span style="color:#5bc4bf">|</span> <span style="color:#f99b15">1398</span><span style="color:#5bc4bf">/</span><span style="color:#f99b15">1398</span> [<span style="color:#f99b15">01</span>:<span style="color:#f99b15">57</span><span style="color:#5bc4bf">&lt;</span><span style="color:#f99b15">00</span>:<span style="color:#f99b15">00</span>, <span style="color:#f99b15">11.88</span>it<span style="color:#5bc4bf">/</span>s]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>é¢†åŸŸå†…æ•°æ®é›† æ€§èƒ½å¯¹æ¯”
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>æŒ‡æ ‡                 è’¸é¦å‰         è’¸é¦å        ç»å¯¹å˜åŒ–     ç›¸å¯¹å˜åŒ–(<span style="color:#5bc4bf">%</span>)
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>map             <span style="color:#f99b15">0.7744</span>      <span style="color:#f99b15">0.8516</span>     <span style="color:#5bc4bf">+</span><span style="color:#f99b15">0.0773</span>       <span style="color:#5bc4bf">+</span><span style="color:#f99b15">9.98</span>
</span></span><span style="display:flex;"><span>mrr<span style="color:#5bc4bf">@</span><span style="color:#f99b15">10</span>          <span style="color:#f99b15">0.9321</span>      <span style="color:#f99b15">0.9548</span>     <span style="color:#5bc4bf">+</span><span style="color:#f99b15">0.0227</span>       <span style="color:#5bc4bf">+</span><span style="color:#f99b15">2.43</span>
</span></span><span style="display:flex;"><span>ndcg<span style="color:#5bc4bf">@</span><span style="color:#f99b15">10</span>         <span style="color:#f99b15">0.8296</span>      <span style="color:#f99b15">0.8956</span>     <span style="color:#5bc4bf">+</span><span style="color:#f99b15">0.0660</span>       <span style="color:#5bc4bf">+</span><span style="color:#f99b15">7.96</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>é¢†åŸŸå¤–æ•°æ®é›† æ€§èƒ½å¯¹æ¯”
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">============================================================</span>
</span></span><span style="display:flex;"><span>æŒ‡æ ‡                 è’¸é¦å‰         è’¸é¦å        ç»å¯¹å˜åŒ–     ç›¸å¯¹å˜åŒ–(<span style="color:#5bc4bf">%</span>)
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>map             <span style="color:#f99b15">0.5166</span>      <span style="color:#f99b15">0.5034</span>     <span style="color:#5bc4bf">-</span><span style="color:#f99b15">0.0132</span>       <span style="color:#5bc4bf">-</span><span style="color:#f99b15">2.56</span>
</span></span><span style="display:flex;"><span>mrr<span style="color:#5bc4bf">@</span><span style="color:#f99b15">10</span>          <span style="color:#f99b15">0.5238</span>      <span style="color:#f99b15">0.5110</span>     <span style="color:#5bc4bf">-</span><span style="color:#f99b15">0.0127</span>       <span style="color:#5bc4bf">-</span><span style="color:#f99b15">2.43</span>
</span></span><span style="display:flex;"><span>ndcg<span style="color:#5bc4bf">@</span><span style="color:#f99b15">10</span>         <span style="color:#f99b15">0.5902</span>      <span style="color:#f99b15">0.5778</span>     <span style="color:#5bc4bf">-</span><span style="color:#f99b15">0.0124</span>       <span style="color:#5bc4bf">-</span><span style="color:#f99b15">2.10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>è¯„ä¼°å®Œæˆ
</span></span></code></pre></div><h4 id="é—®é¢˜å¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®æœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€é‚£ä¹ˆvllmä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥">é—®é¢˜ï¼šå¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€ï¼Œé‚£ä¹ˆvLLMä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜å¯¹äºä¸€ä¸ªbatchå†…çš„æ•°æ®æœ‰å¾ˆå¤šæ¡æ•°æ®æœ‰å…±åŒçš„å‰ç¼€é‚£ä¹ˆvllmä¸­æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µçš„ä¼˜åŒ–æ¨ç†ç­–ç•¥">#</a></h4>
<p>æ˜¯çš„ï¼<strong>vLLM ç¡®å®é’ˆå¯¹ã€Œbatch å†…å¤šæ¡è¯·æ±‚å…·æœ‰å…±åŒå‰ç¼€ï¼ˆshared prefixï¼‰ã€çš„åœºæ™¯æä¾›äº†ä¸“é—¨çš„ä¼˜åŒ–ç­–ç•¥</strong>ï¼Œè¿™é¡¹æŠ€æœ¯ç§°ä¸ºï¼š</p>
<p><strong>âœ… Prefix Cachingï¼ˆå‰ç¼€ç¼“å­˜ï¼‰</strong> æˆ– <strong>Prompt Sharing</strong>
è¿™æ˜¯ vLLM çš„æ ¸å¿ƒä¼˜åŒ–ä¹‹ä¸€ï¼Œèƒ½<strong>æ˜¾è‘—èŠ‚çœæ˜¾å­˜ã€æå‡ååã€é™ä½å»¶è¿Ÿ</strong>ï¼Œå°¤å…¶é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p>
<ul>
<li>RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼šå¤šä¸ªæ–‡æ¡£å…±äº«ç›¸åŒçš„ prompt æ¨¡æ¿</li>
<li>å¤šè½®å¯¹è¯ç³»ç»Ÿï¼šå†å²ä¸Šä¸‹æ–‡ç›¸åŒï¼Œä»…ç”¨æˆ·æœ€æ–°è¾“å…¥ä¸åŒ</li>
<li>æ‰¹é‡æ¨ç†ï¼šå¦‚ <code>â€œæ€»ç»“ä»¥ä¸‹æ–‡æœ¬ï¼š&lt;text&gt;â€</code>ï¼Œå…¶ä¸­ <code>&lt;text&gt;</code> ä¸åŒä½†æŒ‡ä»¤ç›¸åŒ</li>
</ul>
<p><strong>ğŸ” å·¥ä½œåŸç†</strong></p>
<p><strong>1. KV Cache å…±äº«</strong></p>
<ul>
<li>LLM æ¨ç†ä¸­ï¼Œ<strong>Prefill é˜¶æ®µä¼šä¸º prompt ç”Ÿæˆ KV Cacheï¼ˆKey/Value ç¼“å­˜ï¼‰</strong></li>
<li>å¦‚æœå¤šä¸ªè¯·æ±‚çš„ <strong>prompt å‰ç¼€å®Œå…¨ç›¸åŒ</strong>ï¼Œå®ƒä»¬çš„ <strong>KV Cache å‰ç¼€éƒ¨åˆ†ä¹Ÿå®Œå…¨ç›¸åŒ</strong></li>
<li>vLLM ä¼šï¼š
<ul>
<li><strong>åªè®¡ç®—ä¸€æ¬¡è¯¥å…¬å…±å‰ç¼€çš„ KV Cache</strong></li>
<li><strong>å¤šä¸ªè¯·æ±‚å…±äº«è¿™ä»½ç¼“å­˜</strong></li>
<li>åç»­å„è‡ªä¸åŒçš„éƒ¨åˆ†ç‹¬ç«‹è®¡ç®—</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ“Œ æœ¬è´¨ï¼š<strong>é¿å…é‡å¤è®¡ç®—å’Œå­˜å‚¨ç›¸åŒçš„ä¸Šä¸‹æ–‡</strong></p>
</blockquote>
<p><strong>2. ä¸ PagedAttention ååŒ</strong></p>
<ul>
<li>vLLM ä½¿ç”¨ <strong>PagedAttention</strong> ç®¡ç† KV Cacheï¼ˆç±»ä¼¼æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼‰</li>
<li>å…¬å…±å‰ç¼€çš„ KV Cache è¢«å­˜å‚¨åœ¨<strong>å…±äº«ç‰©ç†é¡µ</strong>ä¸­</li>
<li>æ¯ä¸ªè¯·æ±‚çš„é€»è¾‘å—ï¼ˆlogical blocksï¼‰æŒ‡å‘è¿™äº›å…±äº«é¡µ + è‡ªæœ‰é¡µ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Request 1: [Shared Prefix] + [Suffix A]
</span></span><span style="display:flex;"><span>Request 2: [Shared Prefix] + [Suffix B]
</span></span><span style="display:flex;"><span>Request 3: [Shared Prefix] + [Suffix C]
</span></span><span style="display:flex;"><span>â†’ KV Cache:
</span></span><span style="display:flex;"><span>   Shared Pages: [K/V of &#34;Shared Prefix&#34;]
</span></span><span style="display:flex;"><span>   Private Pages: [K/V of &#34;Suffix A&#34;], [Suffix B], [Suffix C]
</span></span></code></pre></div><p><strong>ğŸš€ æ€§èƒ½æ”¶ç›Š</strong></p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ä¼˜åŒ–æ•ˆæœ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ˜¾å­˜å ç”¨</strong></td>
<td>â†“ æ˜¾è‘—å‡å°‘ï¼ˆå…¬å…±éƒ¨åˆ†åªå­˜ä¸€ä»½ï¼‰</td>
</tr>
<tr>
<td><strong>Prefill è®¡ç®—é‡</strong></td>
<td>â†“ å‡å°‘ï¼ˆå…¬å…±å‰ç¼€åªè®¡ç®—ä¸€æ¬¡ï¼‰</td>
</tr>
<tr>
<td><strong>ååï¼ˆthroughputï¼‰</strong></td>
<td>â†‘ æå‡ 2â€“5 å€ï¼ˆå®æµ‹å¸¸è§ï¼‰</td>
</tr>
<tr>
<td><strong>æ”¯æŒ batch size</strong></td>
<td>â†‘ å¯å®¹çº³æ›´å¤šè¯·æ±‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ å®æµ‹æ¡ˆä¾‹ï¼ˆRAG åœºæ™¯ï¼‰ï¼š</p>
<ul>
<li>10 ä¸ªè¯·æ±‚ï¼Œå…±äº« 2K token çš„ prompt æ¨¡æ¿</li>
<li><strong>æ˜¾å­˜èŠ‚çœ &gt;60%</strong>ï¼Œååæå‡ <strong>3.2 å€</strong></li>
</ul>
</blockquote>
<p><strong>ğŸ›  å¦‚ä½•å¯ç”¨ï¼Ÿï¼ˆvLLM ä¸­é»˜è®¤å¼€å¯ï¼ï¼‰</strong></p>
<ul>
<li><strong>æ— éœ€é¢å¤–é…ç½®</strong>ï¼švLLM <strong>é»˜è®¤è‡ªåŠ¨æ£€æµ‹å¹¶å¯ç”¨ Prefix Caching</strong></li>
<li>æ¡ä»¶ï¼š
<ul>
<li>å¤šä¸ªè¯·æ±‚çš„ <strong>prompt å‰ç¼€å¿…é¡»å­—èŠ‚çº§å®Œå…¨ç›¸åŒ</strong></li>
<li>ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹å’Œå‚æ•°ï¼ˆtemperature ç­‰ä¸å½±å“ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>ç¤ºä¾‹ï¼ˆPython clientï¼‰ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5bc4bf">from</span> <span style="color:#fec418">vllm</span> <span style="color:#5bc4bf">import</span> LLM, SamplingParams
</span></span><span style="display:flex;"><span>llm <span style="color:#5bc4bf">=</span> LLM(model<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;Qwen/Qwen-7B-Chat&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">**</span>å…±äº«å‰ç¼€<span style="color:#ef6155">ï¼š</span><span style="color:#48b685">&#34;ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼š&#34;</span><span style="color:#5bc4bf">**</span>
</span></span><span style="display:flex;"><span>prompts <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šå·´é»æ˜¯å“ªä¸ªå›½å®¶çš„é¦–éƒ½ï¼Ÿ&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šé‡å­åŠ›å­¦æ˜¯è°æå‡ºçš„ï¼Ÿ&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;ä½ æ˜¯ä¸€ä¸ª helpful AIã€‚è¯·å›ç­”ï¼šPython å¦‚ä½•è¯»å–æ–‡ä»¶ï¼Ÿ&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>outputs <span style="color:#5bc4bf">=</span> llm<span style="color:#5bc4bf">.</span>generate(prompts, SamplingParams(temperature<span style="color:#5bc4bf">=</span><span style="color:#f99b15">0.7</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">**</span><span style="color:#ef6155">â†’</span> vLLM è‡ªåŠ¨å…±äº«å‰ç¼€çš„ KV Cache<span style="color:#ef6155">ï¼</span><span style="color:#5bc4bf">**</span>
</span></span></code></pre></div><p><strong>âš ï¸ æ³¨æ„äº‹é¡¹</strong></p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å‰ç¼€å¿…é¡»å®Œå…¨ä¸€è‡´</strong></td>
<td>åŒ…æ‹¬ç©ºæ ¼ã€æ ‡ç‚¹ã€æ¢è¡Œç¬¦ã€‚<code>&quot;ä½ å¥½&quot;</code> â‰  <code>&quot;ä½ å¥½ &quot;</code></td>
</tr>
<tr>
<td><strong>ä¸æ”¯æŒåŠ¨æ€æ’å…¥</strong></td>
<td>å¦‚æœå‰ç¼€åœ¨è¿è¡Œæ—¶æ‹¼æ¥ï¼ˆå¦‚åŠ æ—¶é—´æˆ³ï¼‰ï¼Œåˆ™æ— æ³•å…±äº«</td>
</tr>
<tr>
<td><strong>ä¸ LoRA å…¼å®¹æ€§</strong></td>
<td>è‹¥ä½¿ç”¨ä¸åŒ LoRA adapterï¼Œå³ä½¿ prompt ç›¸åŒä¹Ÿæ— æ³•å…±äº«</td>
</tr>
<tr>
<td><strong>ä»…é™ Prefill é˜¶æ®µ</strong></td>
<td>Decode é˜¶æ®µå› è¾“å‡ºä¸åŒï¼Œæ— æ³•å…±äº«</td>
</tr>
</tbody>
</table>
<p><strong>ğŸ”§ é«˜çº§ç”¨æ³•ï¼šæ‰‹åŠ¨æ§åˆ¶ï¼ˆvLLM â‰¥ 0.4.0ï¼‰</strong>
å¯é€šè¿‡ <code>enable_prefix_caching=True</code> æ˜¾å¼å¯ç”¨ï¼ˆé»˜è®¤å·²å¼€ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>llm <span style="color:#5bc4bf">=</span> LLM(
</span></span><span style="display:flex;"><span>    model<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;meta-llama/Llama-3-8b&#34;</span>,
</span></span><span style="display:flex;"><span>    enable_prefix_caching<span style="color:#5bc4bf">=</span><span style="color:#815ba4">True</span>  <span style="color:#776e71"># é»˜è®¤ True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>ä¹Ÿå¯é€šè¿‡ç¯å¢ƒå˜é‡ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ef6155">VLLM_ENABLE_PREFIX_CACHING</span><span style="color:#5bc4bf">=</span><span style="color:#f99b15">1</span>
</span></span></code></pre></div><p><strong>ğŸ†š ä¸å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¯”</strong></p>
<table>
<thead>
<tr>
<th>ç³»ç»Ÿ</th>
<th>æ˜¯å¦æ”¯æŒå‰ç¼€å…±äº«</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>vLLM</strong></td>
<td>âœ… æ˜¯ï¼ˆåŸºäº PagedAttentionï¼‰</td>
</tr>
<tr>
<td><strong>HuggingFace TGI</strong></td>
<td>âŒ å¦ï¼ˆæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ KV Cacheï¼‰</td>
</tr>
<tr>
<td><strong>TensorRT-LLM</strong></td>
<td>âœ… æ˜¯ï¼ˆéœ€æ‰‹åŠ¨æ„å»º shared contextï¼‰</td>
</tr>
<tr>
<td><strong>SGLang</strong></td>
<td>âœ… æ˜¯ï¼ˆRadixAttention æœºåˆ¶ï¼‰</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ vLLM çš„å®ç°æ˜¯<strong>è‡ªåŠ¨ã€é€æ˜ã€é«˜æ•ˆ</strong>çš„ä»£è¡¨ã€‚</p>
</blockquote>
<p><strong>âœ… æ€»ç»“</strong></p>
<ul>
<li><strong>vLLM æ”¯æŒ Prefix Caching</strong>ï¼Œè‡ªåŠ¨ä¼˜åŒ–å…±äº«å‰ç¼€çš„ batch è¯·æ±‚</li>
<li><strong>æ— éœ€ä»£ç ä¿®æ”¹</strong>ï¼Œåªè¦ prompt å‰ç¼€ç›¸åŒå³å¯ç”Ÿæ•ˆ</li>
<li><strong>æ˜¾è‘—èŠ‚çœæ˜¾å­˜ + æå‡åå</strong>ï¼Œç‰¹åˆ«é€‚åˆ RAGã€æ‰¹é‡æŒ‡ä»¤ç­‰åœºæ™¯</li>
<li>ç¡®ä¿ä½ çš„ prompt æ¨¡æ¿<strong>ä¸¥æ ¼ä¸€è‡´</strong>ï¼ˆé¿å…å°¾éƒ¨ç©ºæ ¼/æ¢è¡Œå·®å¼‚ï¼‰</li>
</ul>
<blockquote>
<p>å¦‚æœä½ æ­£åœ¨åš RAG æˆ–æ‰¹é‡æ¨ç†ï¼Œ<strong>Prefix Caching æ˜¯ vLLM ç»™ä½ çš„ä¸€ä»½å…è´¹æ€§èƒ½å¤§ç¤¼åŒ…</strong>ï¼ğŸ‰</p>
</blockquote>
<h4 id="é—®é¢˜ä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€é‚£ä¹ˆè¿™ä¸ªæ—¶å€™-cacheè¿˜æ²¡äº§ç”Ÿå§">é—®é¢˜ï¼šä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ cacheè¿˜æ²¡äº§ç”Ÿå§ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜ä½†æ˜¯ä¸€ä¸ªbatchå†…çš„æ•°æ®æ˜¯ä¸€èµ·è¿›è¡Œå¹¶è¡Œæ¨ç†çš„å‘€é‚£ä¹ˆè¿™ä¸ªæ—¶å€™-cacheè¿˜æ²¡äº§ç”Ÿå§">#</a></h4>
<p>è¿™æ˜¯ä¸€ä¸ª<strong>éå¸¸å…³é”®ä¸”æ·±åˆ»çš„é—®é¢˜</strong>ï¼ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ï¼š<strong>å¦‚æœæ•´ä¸ª batch æ˜¯â€œåŒæ—¶â€è¿›è¡Œ prefillï¼ˆå³å¹¶è¡Œå¤„ç†æ‰€æœ‰ promptï¼‰ï¼Œé‚£ä¼¼ä¹è¿˜æ²¡ç”Ÿæˆ KV Cacheï¼Œæ€ä¹ˆå…±äº«ï¼Ÿ</strong>
ä½†å®é™…æƒ…å†µæ˜¯ï¼š<strong>vLLM çš„ Prefix Caching å¹¶ä¸æ˜¯åœ¨â€œbatch å†…éƒ¨å¹¶è¡Œæ—¶â€åŠ¨æ€å‘ç°å…±äº«çš„ï¼Œè€Œæ˜¯åœ¨è°ƒåº¦é˜¶æ®µé€šè¿‡â€œå‰ç¼€æ ‘ï¼ˆRadix Tree / Trieï¼‰â€é¢„å…ˆç»„ç»‡è¯·æ±‚ï¼Œä½¿å¾—ç›¸åŒå‰ç¼€çš„è¯·æ±‚åœ¨é€»è¾‘ä¸Šè¢«è¯†åˆ«å¹¶å¤ç”¨å·²ç¼“å­˜çš„ KV å—ã€‚</strong>
ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥æ¾„æ¸…è¿™ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„é—®é¢˜ï¼š</p>
<p><strong>âœ… æ ¸å¿ƒç­”æ¡ˆ</strong></p>
<blockquote>
<p><strong>Prefix Caching çš„â€œcacheâ€å¹¶ä¸æ˜¯æ¥è‡ªå½“å‰ batch å†…éƒ¨çš„å…¶ä»–è¯·æ±‚ï¼Œè€Œæ˜¯æ¥è‡ªï¼š</strong></p>
<ol>
<li><strong>ä¹‹å‰å·²å®Œæˆçš„è¯·æ±‚ï¼ˆè·¨ batch å…±äº«ï¼‰</strong>ï¼Œæˆ–</li>
<li><strong>åœ¨å½“å‰ batch å†…éƒ¨ï¼ŒvLLM è°ƒåº¦å™¨ä¼šå…ˆå¤„ç†å…¬å…±å‰ç¼€ä¸€æ¬¡ï¼Œå†å¹¿æ’­ç»™å…¶ä»–è¯·æ±‚ï¼ˆé€»è¾‘ä¸Šä¸²è¡ŒåŒ–å‰ç¼€è®¡ç®—ï¼‰</strong>
ä½†åœ¨ <strong>çº¯é¦–æ¬¡ batchï¼ˆæ²¡æœ‰ä»»ä½•å†å² cacheï¼‰ä¸”æ‰€æœ‰è¯·æ±‚é¦–æ¬¡å‡ºç°</strong> çš„æƒ…å†µä¸‹ï¼Œ<strong>åŒä¸€ä¸ª batch å†…çš„è¯·æ±‚ç¡®å®æ— æ³•å½¼æ­¤å…±äº« KV Cache</strong> â€”â€” <strong>é™¤é vLLM æ˜¾å¼åœ°å°†å…¬å…±å‰ç¼€æå–å‡ºæ¥å•ç‹¬è®¡ç®—ä¸€æ¬¡</strong>ã€‚
è€Œ <strong>vLLM æ­£æ˜¯è¿™ä¹ˆåšçš„ï¼</strong></li>
</ol>
</blockquote>
<p><strong>ğŸ” æ·±å…¥æœºåˆ¶ï¼švLLM å¦‚ä½•åœ¨å•ä¸ª batch å†…å®ç°å‰ç¼€å…±äº«ï¼Ÿ</strong></p>
<p><strong>å…³é”®æŠ€æœ¯ï¼š<strong>Radix Treeï¼ˆåŸºæ•°æ ‘ï¼‰ + Block-wise KV Cache Management</strong></strong>
vLLM åœ¨è°ƒåº¦ä¸€ä¸ª batch å‰ï¼Œä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š</p>
<p><strong>æ­¥éª¤ 1ï¼šæ„å»º Radix Tree</strong></p>
<ul>
<li>å°† batch ä¸­æ‰€æœ‰ prompt æ’å…¥ä¸€æ£µ <strong>å‰ç¼€æ ‘ï¼ˆTrieï¼‰</strong></li>
<li>è‡ªåŠ¨è¯†åˆ«æœ€é•¿å…¬å…±å‰ç¼€ï¼ˆLCPï¼‰</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Prompts:
</span></span><span style="display:flex;"><span>  &#34;ä½ æ˜¯AIã€‚Q: å·´é»?&#34;
</span></span><span style="display:flex;"><span>  &#34;ä½ æ˜¯AIã€‚Q: é‡å­?&#34;
</span></span><span style="display:flex;"><span>  &#34;ä½ æ˜¯AIã€‚Q: Python?&#34;
</span></span><span style="display:flex;"><span>â†’ Radix Tree:
</span></span><span style="display:flex;"><span>  root
</span></span><span style="display:flex;"><span>   â””â”€â”€ &#34;ä½ æ˜¯AIã€‚Q: &#34;
</span></span><span style="display:flex;"><span>        â”œâ”€â”€ &#34;å·´é»?&#34;
</span></span><span style="display:flex;"><span>        â”œâ”€â”€ &#34;é‡å­?&#34;
</span></span><span style="display:flex;"><span>        â””â”€â”€ &#34;Python?&#34;
</span></span></code></pre></div><p><strong>æ­¥éª¤ 2ï¼šåˆ†å±‚ Prefillï¼ˆHierarchical Prefillï¼‰</strong></p>
<ul>
<li><strong>å…ˆå¯¹å…¬å…±å‰ç¼€ <code>&quot;ä½ æ˜¯AIã€‚Q: &quot;</code> æ‰§è¡Œä¸€æ¬¡ prefill</strong>
<ul>
<li>ç”Ÿæˆå…¶å¯¹åº”çš„ KV Cache blocks</li>
</ul>
</li>
<li><strong>å†å¯¹æ¯ä¸ªåç¼€ï¼ˆ&ldquo;å·´é»?&rdquo; ç­‰ï¼‰åˆ†åˆ«æ‰§è¡Œ prefill</strong>
<ul>
<li>æ¯ä¸ªåç¼€çš„ attention è®¡ç®—ä¼š <strong>æ‹¼æ¥å…¬å…±å‰ç¼€çš„ KV blocks + è‡ªèº«åç¼€çš„ KV blocks</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ¯ è¿™ç›¸å½“äº <strong>æŠŠä¸€ä¸ªé•¿ prompt æ‹†æˆ â€œshared part + unique partâ€</strong>ï¼Œå¹¶åœ¨è®¡ç®—æ—¶ç»„åˆã€‚</p>
</blockquote>
<p><strong>æ­¥éª¤ 3ï¼šPagedAttention æ”¯æŒéè¿ç»­ KV å—</strong></p>
<ul>
<li>æ¯ä¸ªè¯·æ±‚çš„å®Œæ•´ KV Cache = [shared_block_ids] + [unique_block_ids]</li>
<li>Attention è®¡ç®—æ—¶ï¼ŒPagedAttention è‡ªåŠ¨ä»å¤šä¸ªç‰©ç†é¡µè¯»å–ï¼Œå¯¹æ¨¡å‹é€æ˜</li>
</ul>
<p><strong>ğŸ“Œ é‡è¦æ¾„æ¸…</strong></p>
<table>
<thead>
<tr>
<th>è¯¯è§£</th>
<th>äº‹å®</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€œbatch å†…æ‰€æœ‰ prompt åŒæ—¶å¹¶è¡Œè®¡ç®—â€</td>
<td>âŒ å®é™…æ˜¯ï¼š<strong>å…¬å…±å‰ç¼€å…ˆç®—ä¸€æ¬¡ï¼Œåç¼€å†å¹¶è¡Œ</strong>ï¼ˆé€»è¾‘ä¸Šåˆ†é˜¶æ®µï¼‰</td>
</tr>
<tr>
<td>â€œcache å¿…é¡»æ¥è‡ªå†å²è¯·æ±‚â€</td>
<td>âŒ <strong>å³ä½¿å…¨æ˜¯æ–°è¯·æ±‚ï¼ŒvLLM ä¹Ÿèƒ½åœ¨ batch å†…éƒ¨æ„é€ å…±äº«</strong></td>
</tr>
<tr>
<td>â€œPrefill æ˜¯å®Œå…¨ç‹¬ç«‹çš„â€</td>
<td>âŒ vLLM çš„è°ƒåº¦å™¨ä¼š<strong>ä¸»åŠ¨é‡ç»„è®¡ç®—å›¾ä»¥å¯ç”¨å…±äº«</strong></td>
</tr>
</tbody>
</table>
<p><strong>ğŸ§ª å®éªŒéªŒè¯ï¼ˆæ€æƒ³å®éªŒï¼‰</strong>
å‡è®¾ batch æœ‰ 3 ä¸ªå…¨æ–°è¯·æ±‚ï¼Œæ— ä»»ä½•å†å² cacheï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>prompts <span style="color:#5bc4bf">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;Hello world A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;Hello world B&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#48b685">&#34;Hello world C&#34;</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>vLLM çš„æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>è°ƒåº¦å™¨å‘ç°å…¬å…±å‰ç¼€ <code>&quot;Hello world &quot;</code></li>
<li><strong>åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿâ€œå…±äº«è¯·æ±‚â€</strong>ï¼Œprefill <code>&quot;Hello world &quot;</code> â†’ å¾—åˆ° KV blocks S</li>
<li>å¯¹æ¯ä¸ªåç¼€ <code>&quot;A&quot;</code>, <code>&quot;B&quot;</code>, <code>&quot;C&quot;</code>ï¼š
<ul>
<li>æ„é€ è¾“å…¥ï¼š<code>&quot;Hello world X&quot;</code></li>
<li>ä½† KV Cache = S + prefill(&ldquo;X&rdquo;) çš„ç»“æœ</li>
</ul>
</li>
<li>æœ€ç»ˆæ¯ä¸ªè¯·æ±‚çš„è¾“å‡ºæ­£ç¡®ï¼Œä¸” <strong>S åªè®¡ç®—äº†ä¸€æ¬¡</strong></li>
</ol>
<blockquote>
<p>ğŸ’¡ è¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ <strong>è®¡ç®—å›¾èåˆä¼˜åŒ–</strong>ï¼Œç”± vLLM çš„ scheduler è‡ªåŠ¨å®Œæˆã€‚</p>
</blockquote>
<p><strong>ğŸ“š å®˜æ–¹ä¾æ®</strong></p>
<ul>
<li>vLLM è®ºæ–‡ï¼ˆ<a href="https://arxiv.org/abs/2309.06180" target="_blank" rel="noopener" style="color:#42b983";>vLLM: Easy, Fast, and Cheap LLM Serving</a>ï¼‰æåˆ°ï¼š
<blockquote>
<p><em>&ldquo;PagedAttention enables sharing of memory blocks across requests with common prefixes.&rdquo;</em></p>
</blockquote>
</li>
<li>æºç ä¸­ <code>RadixAttention</code>ï¼ˆåç»­æ¼”è¿›ï¼‰å’Œ <code>PrefixCacher</code> ç»„ä»¶æ˜ç¡®æ”¯æŒ <strong>intra-batch prefix sharing</strong></li>
</ul>
<blockquote>
<p>ğŸ”— å‚è€ƒï¼š<a href="https://docs.vllm.ai/en/latest/design/prefix_caching.html" target="_blank" rel="noopener" style="color:#42b983";>vLLM Prefix Caching Design Doc</a></p>
</blockquote>
<p><strong>âœ… æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>å›ç­”</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åŒä¸€ä¸ª batch å†…çš„è¯·æ±‚èƒ½å…±äº«å‰ç¼€å—ï¼Ÿ</strong></td>
<td>âœ… <strong>èƒ½ï¼å³ä½¿å…¨æ˜¯æ–°è¯·æ±‚</strong></td>
</tr>
<tr>
<td><strong>cache æ˜¯å“ªé‡Œæ¥çš„ï¼Ÿ</strong></td>
<td>æ¥è‡ª <strong>å½“å‰ batch å†…éƒ¨å¯¹å…¬å…±å‰ç¼€çš„é¦–æ¬¡è®¡ç®—</strong>ï¼ˆè°ƒåº¦å™¨ä¸»åŠ¨æå–ï¼‰</td>
</tr>
<tr>
<td><strong>æ˜¯å¦éœ€è¦å†å²è¯·æ±‚ï¼Ÿ</strong></td>
<td>âŒ ä¸éœ€è¦ï¼ˆè·¨ batch å…±äº«æ˜¯é¢å¤– bonusï¼‰</td>
</tr>
<tr>
<td><strong>æ˜¯å¦ç ´åå¹¶è¡Œæ€§ï¼Ÿ</strong></td>
<td>âš ï¸ å…¬å…±å‰ç¼€è®¡ç®—æ˜¯ä¸²è¡Œçš„ï¼Œä½†åç¼€ä»å¯å¹¶è¡Œï¼Œ<strong>æ•´ä½“ååä»å¤§å¹…æå‡</strong></td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ æ‰€ä»¥ä½ çš„è§‚å¯Ÿå¾ˆæ•é”ï¼Œä½† vLLM é€šè¿‡ <strong>æ™ºèƒ½è°ƒåº¦ + Radix Tree + PagedAttention</strong> è§£å†³äº†è¿™ä¸ªâ€œé¸¡ç”Ÿè›‹â€é—®é¢˜ã€‚
è¿™æ­£æ˜¯ vLLM ç›¸æ¯”ä¼ ç»Ÿæ¨ç†å¼•æ“ï¼ˆå¦‚ HF Transformersï¼‰çš„å…ˆè¿›ä¹‹å¤„ï¼</p>
</blockquote>
<h2 id="p04-rag-best-practices">P04 rag-best-practices<a hidden class="anchor" aria-hidden="true" href="#p04-rag-best-practices">#</a></h2>
<h4 id="é¡¹ç›®åŸç†å’Œç»“æœ-1">é¡¹ç›®åŸç†å’Œç»“æœ<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®åŸç†å’Œç»“æœ-1">#</a></h4>
<p>å‚è€ƒé¡¹ç›® <a href="https://github.com/chaoql/rag-best-practices" target="_blank" rel="noopener" style="color:#42b983";>chaoql/rag-best-practices: å¤§æ¨¡å‹æ£€ç´¢å¢å¼ºç”ŸæˆæŠ€æœ¯æœ€ä½³å®è·µã€‚</a></p>
<ol>
<li>Qdrantçš„ä»£ç ç»„ç»‡éå¸¸ç³Ÿç³•ã€‚
<ol>
<li>QdrantVectorStore é‡Œé¢è¿˜å¥—äº†ä¸€ä¸ªfastembedæ¨¡å‹ã€‚</li>
<li>å¯¹äºæ¨¡å‹ä¸‹è½½æ¨¡å—çš„é—®é¢˜å®šä¹‰äº†ç‹¬ç«‹çš„ç¼“å­˜ç›®å½•ï¼Œä½†æ˜¯åˆå’Œhfçš„ç›®å½•æ··åˆ°äº†ä¸€å—ã€‚å¹¶ä¸”å‡½æ•°æ¥å£å†™å¾—å¾ˆä¸é€šç”¨ã€‚</li>
<li>æ‰€ä»¥æ”¾å¼ƒè¿™å—åŠŸèƒ½çš„è·‘é€šã€‚</li>
</ol>
</li>
<li><strong>åŸç†</strong>
<ol>
<li>æ‰€è°“æ··åˆæ£€ç´¢å°±æ˜¯å¿«æ…¢ç»“åˆï¼Œfastembed(sparse embed) å’Œdenseembed</li>
<li>HyDE
<ol>
<li><strong>Hypothetical Document Embeddingsï¼ˆHyDEï¼‰</strong> æ˜¯ä¸€ç§<strong>æå‡æ£€ç´¢è´¨é‡çš„é«˜çº§åµŒå…¥æŠ€æœ¯</strong>ï¼Œç”± Gao et al. åœ¨ 2022 å¹´æå‡ºï¼ˆè®ºæ–‡ï¼šPrecise Zero-Shot Dense Retrieval without Relevance Labelsï¼‰ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š
<ol>
<li><strong>ä¸ç›´æ¥ç”¨ç”¨æˆ·æŸ¥è¯¢ï¼ˆqueryï¼‰å»æ£€ç´¢ï¼Œè€Œæ˜¯å…ˆè®©å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ç”Ÿæˆä¸€ä¸ªâ€œå‡è®¾æ€§ç­”æ¡ˆâ€ï¼ˆhypothetical documentï¼‰ï¼Œå†ç”¨è¿™ä¸ªå‡è®¾ç­”æ¡ˆçš„åµŒå…¥å‘é‡å»æ£€ç´¢çœŸå®æ–‡æ¡£ã€‚</strong></li>
</ol>
</li>
</ol>
</li>
<li>è¿™ä¸ªé¡¹ç›®ä¸­çš„hybrid æ¨¡å¼çš„æ„æ€æ˜¯ï¼Œqueryç”Ÿæˆä¸€ä¸ª<strong>ç¨€ç–å‘é‡ã€ä¸€ä¸ªç¨ å¯†å‘é‡ï¼Œä¸¤ç§åŒæ—¶è¯·æ±‚æ•°æ®åº“</strong>ï¼Œè€Œç¨€ç–å‘é‡å¯èƒ½æ˜¯æŒ‰ç…§ä¼ ç»Ÿå€’æ’ç´¢å¼•æ¥è¿›è¡Œç´¢å¼•æ„å»ºçš„ï¼Œå³æœ€ç»ˆæ—¢æœ‰ å€’æ’ç´¢å¼•æœç´¢ åˆæœ‰å‘é‡æœç´¢ã€‚
<ol>
<li>å½“ç„¶Qrant æœ¬èº«ä¹Ÿå…è®¸è¯·æ±‚å¸¦ filterï¼Œå³å…³é”®è¯æ£€ç´¢ã€ç±»åˆ«æ£€ç´¢ç­‰ã€‚</li>
</ol>
</li>
</ol>
</li>
<li><strong>embedding æ¨¡å‹å¾®è°ƒè¿‡ç¨‹</strong>
<ol>
<li>å¯¹äºè¾“å…¥æ•°æ®æ–‡ä»¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®ï¼Œé€šè¿‡chatglmæ¨¡å‹ï¼Œæ„é€ promptï¼ˆå…¶ä¸­åŒ…å«ä¸€æ¡æ–‡æ¡£ï¼‰ï¼Œè¦æ±‚æ¨¡å‹è¿”å›ä¸€äº›å’Œä¸Šä¸‹æ–‡ç›¸å…³çš„é—®é¢˜ï¼Œå³å½¢æˆäº†Answer-Question å¯¹ã€‚</li>
<li>ç„¶ååè½¬A-Qå¯¹ï¼ˆæ˜ å°„å…³ç³»ä¸ºn-to-1ï¼‰ï¼Œæ„é€ å‡ºå¾®è°ƒæ•°æ®ã€‚</li>
<li>æ€»ä½“æ¥è¯´ï¼Œå°±æ˜¯ä¾èµ–ä¸€ä¸ªè¶…å¤§çš„chatå¤§æ¨¡å‹å’Œä¸€ä¸ªæ–‡æ¡£æ•°æ®é›†ï¼Œæ„é€ å‡ºQ-Aç›¸ä¼¼å¯¹ï¼Œè¿›è€Œå°†chatå¤§æ¨¡å‹çš„å¯¹è¯¥æ–‡æ¡£çš„ç›¸å…³çŸ¥è¯†ï¼ˆå¯¹æ–‡æ¡£æ•°æ®é›†é¢†åŸŸçš„çŸ¥è¯†ç†è§£æ›´é€å½»ã€æ›´ç²¾ç»†ï¼‰ å¾®è°ƒåˆ°ä¸€ä¸ªembå°æ¨¡å‹å†…ã€‚</li>
<li>æ¨¡å‹å¾®è°ƒä½¿ç”¨çš„æ˜¯llama-index ä¸­ embedding æ¨¡å‹å¾®è°ƒçš„åŠŸèƒ½ç±»  <code>llama_index.finetuning.embeddings.sentence_transformer.SentenceTransformersFinetuneEngine</code>ã€‚
<ol>
<li>å…¶ä¸­æŸå¤±å‡½æ•°æ˜¯ MultipleNegativesRankingLoss</li>
<li>MultipleNegativesRankingLoss å¯¹äºæœ¬æ–‡çš„æ•°æ®å½¢å¼ å³ Q-Aå¯¹ï¼Œå³å°†Aè§†ä½œä¸€ä¸ªæ­£æ ·æœ¬ï¼ŒåŒæ—¶é‡‡æ · in-batchå†…çš„å…¶ä»–æ ·æœ¬ä½œä¸ºå¤šä¸ªè´Ÿæ ·æœ¬ï¼Œæ¥è®¡ç®—å‡ºä¸€ä¸ª Softmax Cross-Entropy Lossï¼Œç„¶åå†Qç»´åº¦ä¸Šå–å‡å€¼å³ä¸ºbatchæŸå¤±ã€‚</li>
</ol>
</li>
<li><a href="https://developers.llamaindex.ai/python/framework/module_guides/querying/response_synthesizers/#configuring-the-response-mode" target="_blank" rel="noopener" style="color:#42b983";>Configuring the Response Mode</a></li>
</ol>
</li>
<li><strong>æ¨¡å‹ä¸‹è½½</strong>
<ol>
<li>HuggingfaceEmbedding ç±» å¦‚ä½•è§£å†³å¤–ç½‘ä¸å¯è®¿é—®çš„é—®é¢˜ã€‚
<ol>
<li>ä½¿ç”¨ modelscopeä¸‹è½½æ¨¡å‹ï¼Œç„¶ååˆ¶å®š HuggingfaceEmbeddingçš„æ¨¡å‹åŠ è½½è·¯å¾„ä¸º modelscopeç¼“å­˜ä¸­æ¨¡å‹çš„ç»å¯¹è·¯å¾„ã€‚ï¼ˆä¸æ˜¯æ¨¡å‹ç¼“å­˜çš„çˆ¶ç›®å½•ï¼Œè€Œæ˜¯å…·ä½“åˆ°ä¸€ä¸ªæ¨¡å‹çš„ç›®å½•ï¼‰</li>
<li>modelscopeä¸Šçš„æ¨¡å‹ä¸å…¨ï¼Œæœ‰äº›çŸ¥ååº¦ä¸é«˜çš„æ¨¡å‹ hfä¸Šæ¸¸ï¼Œä½†modelscopeä¸Šç¼ºå°‘ã€‚</li>
</ol>
</li>
<li>æœåŠ¡å™¨
<ol>
<li>é˜¿é‡Œäº‘æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ modelscope æ¥è¿›è¡Œä¸‹è½½ï¼Œç„¶åç„¶åæ¨¡å‹åŠ è½½éƒ½ä½¿ç”¨ç»å¯¹è·¯å¾„æ¥åŠ è½½ã€‚</li>
</ol>
</li>
<li>æœ¬åœ°å¼€å‘
<ol>
<li>å¯ä»¥ä½¿ç”¨ huggingface æ¥è¿›è¡Œä¸‹è½½å’Œç®¡ç†ã€‚</li>
</ol>
</li>
<li>FlagEmbeddingReranker
<ol>
<li>â€œFlagâ€ in FlagEmbeddingReranker = BAAIï¼ˆæ™ºæºç ”ç©¶é™¢ï¼‰çš„å¼€æºæ¨¡å‹å“ç‰Œæ ‡è¯†ï¼Œæ„ä¸ºâ€œæ——èˆ°çº§åµŒå…¥/é‡æ’æ¨¡å‹â€ï¼Œæ— ç‰¹æ®ŠæŠ€æœ¯å«ä¹‰ï¼Œä¸»è¦æ˜¯é¡¹ç›®å‘½åçš„ä¸€éƒ¨åˆ†ã€‚</li>
</ol>
</li>
<li>modelscopeçš„æ¨¡å‹ç›®å½•æ¶æ„å’Œhuggingfaceçš„æ¨¡å‹ç›®å½•ç»“æ„ å·®å¼‚å¾ˆå¤§ï¼Œä¸èƒ½ç›´æ¥å¤ç”¨ã€‚æ‰€ä»¥å¦‚æœè¦åŠ è½½æœ¬åœ°æ¨¡å‹ï¼ŒåŠ¡å¿…ä½¿ç”¨æ¨¡å‹ç»å¯¹è·¯å¾„ã€‚</li>
</ol>
</li>
<li><strong>å·¥ç¨‹</strong>
<ol>
<li>Qdrant
<ol>
<li><strong>é«˜çº§è¿‡æ»¤èƒ½åŠ›ï¼š</strong> æ”¯æŒç»“åˆå‘é‡ç›¸ä¼¼æ€§æœç´¢å’Œä»»æ„ Payload ç»“æ„åŒ–æ•°æ®è¿‡æ»¤ï¼ˆç§°ä¸º <strong>Hybrid Search</strong>ï¼‰ã€‚</li>
</ol>
</li>
<li>node_parser
<ol>
<li>llama_index.core.node_parser.text.sentence_window.SentenceWindowNodeParser æŒ‰ç…§å¥å­è¿›è¡Œåˆ‡å‰²ï¼Œå¤šä¸ªå¥å­ä½œä¸ºä¸€ä¸ªç´¢å¼•æ–‡æ¡£ã€‚</li>
<li><a href="https://developers.llamaindex.ai/python/framework/module_guides/loading/node_parsers/modules/" target="_blank" rel="noopener" style="color:#42b983";>Node Parser Modules | LlamaIndex Python Documentation</a></li>
</ol>
</li>
<li>pickleæ–¹å¼ä¸å®‰å…¨æ˜¯å› ä¸º <code>__reduce__</code>æ–¹æ³•ä¸­å¯ä»¥å®šä¹‰ä¸€ä¸ª æŒ‡ä»¤å­—èŠ‚æµï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™å¯ä»¥è§¦å‘å¯¹åº”æŒ‡ä»¤çš„æ‰§è¡Œã€‚</li>
</ol>
</li>
</ol>
<h4 id="é—®é¢˜pytorch_modelbin-å’Œ-modelsafetensors-åˆ†åˆ«æ˜¯ä»€ä¹ˆ">é—®é¢˜ï¼špytorch_model.bin å’Œ model.safetensors åˆ†åˆ«æ˜¯ä»€ä¹ˆ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜pytorch_modelbin-å’Œ-modelsafetensors-åˆ†åˆ«æ˜¯ä»€ä¹ˆ">#</a></h4>
<p><code>pytorch_model.bin</code> å’Œ <code>model.safetensors</code> æ˜¯ä¸¤ç§å¸¸è§çš„ç”¨äºå­˜å‚¨æ·±åº¦å­¦ä¹ æ¨¡å‹æƒé‡ï¼ˆå‚æ•°ï¼‰çš„æ–‡ä»¶æ ¼å¼ï¼Œå¹¿æ³›ç”¨äº Hugging Face Transformers ç­‰ç”Ÿæ€ä¸­ã€‚å®ƒä»¬çš„æ ¸å¿ƒç›®çš„ç›¸åŒï¼š<strong>ä¿å­˜ç¥ç»ç½‘ç»œçš„å¯è®­ç»ƒå‚æ•°</strong>ï¼Œä½†åœ¨è®¾è®¡å“²å­¦ã€å®‰å…¨æ€§ã€æ€§èƒ½å’Œå…¼å®¹æ€§æ–¹é¢æœ‰æ˜¾è‘—åŒºåˆ«ã€‚</p>
<p><strong>1. <code>pytorch_model.bin</code></strong></p>
<p><strong>æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<ul>
<li>è¿™æ˜¯ <strong>PyTorch åŸç”Ÿçš„æ¨¡å‹æƒé‡ä¿å­˜æ ¼å¼</strong>ã€‚</li>
<li>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé€šè¿‡ <code>torch.save()</code> ä¿å­˜çš„ <strong>Python pickle æ–‡ä»¶</strong>ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ªå­—å…¸ï¼Œé”®ä¸ºå‚æ•°åï¼ˆå¦‚ <code>&quot;transformer.h.0.attn.c_attn.weight&quot;</code>ï¼‰ï¼Œå€¼ä¸ºå¯¹åº”çš„ <code>torch.Tensor</code>ã€‚</li>
</ul>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ ¼å¼</strong></td>
<td>åŸºäº Python çš„ <code>pickle</code> åºåˆ—åŒ–</td>
</tr>
<tr>
<td><strong>å…¼å®¹æ€§</strong></td>
<td>åªèƒ½åœ¨ PyTorch ç¯å¢ƒä¸­åŠ è½½ï¼ˆéœ€åŒ¹é…ç‰ˆæœ¬ï¼‰</td>
</tr>
<tr>
<td><strong>å®‰å…¨æ€§</strong> â—</td>
<td><strong>ä¸å®‰å…¨</strong>ï¼š<code>pickle</code> å¯æ‰§è¡Œä»»æ„ä»£ç ï¼ŒåŠ è½½ä¸å—ä¿¡ä»»çš„ <code>.bin</code> æ–‡ä»¶å¯èƒ½å¯¼è‡´<strong>è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰æ¼æ´</strong></td>
</tr>
<tr>
<td><strong>é€Ÿåº¦</strong></td>
<td>åŠ è½½/ä¿å­˜è¾ƒå¿«ï¼Œä½†ä¾èµ– Python ååºåˆ—åŒ–</td>
</tr>
<tr>
<td><strong>è·¨è¯­è¨€</strong></td>
<td>ä¸æ”¯æŒï¼ˆå¼ºä¾èµ– Python å’Œ PyTorchï¼‰</td>
</tr>
<tr>
<td><strong>å…¸å‹ç”¨é€”</strong></td>
<td>Hugging Face æ¨¡å‹ä»“åº“ä¸­çš„é»˜è®¤æƒé‡æ ¼å¼ï¼ˆå°¤å…¶æ—§æ¨¡å‹ï¼‰</td>
</tr>
</tbody>
</table>
<p><strong>ç¤ºä¾‹åŠ è½½æ–¹å¼ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5bc4bf">import</span> <span style="color:#fec418">torch</span>
</span></span><span style="display:flex;"><span>state_dict <span style="color:#5bc4bf">=</span> torch<span style="color:#5bc4bf">.</span>load(<span style="color:#48b685">&#34;pytorch_model.bin&#34;</span>, map_location<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#5bc4bf">.</span>load_state_dict(state_dict)
</span></span></code></pre></div><blockquote>
<p>âš ï¸ è­¦å‘Šï¼šæ°¸è¿œä¸è¦åŠ è½½æ¥è‡ªä¸å¯ä¿¡æ¥æºçš„ <code>pytorch_model.bin</code>ï¼</p>
</blockquote>
<p><strong>2. <code>model.safetensors</code></strong></p>
<p><strong>æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<ul>
<li>ç”± <strong>Hugging Face å’Œ CarperAI è”åˆå¼€å‘</strong>çš„ä¸€ç§<strong>å®‰å…¨ã€å¿«é€Ÿã€æ¡†æ¶æ— å…³</strong>çš„æ¨¡å‹æƒé‡å­˜å‚¨æ ¼å¼ã€‚</li>
<li><strong>ä¸ä½¿ç”¨ <code>pickle</code></strong>ï¼Œè€Œæ˜¯å°†å¼ é‡æ•°æ®ä»¥åŸå§‹äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨ï¼Œå¹¶é™„å¸¦ JSON å…ƒæ•°æ®æè¿°å¼ é‡ç»“æ„ã€‚</li>
</ul>
<p><strong>ç‰¹ç‚¹ï¼š</strong></p>
<table>
<thead>
<tr>
<th>æ–¹é¢</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ ¼å¼</strong></td>
<td>è‡ªå®šä¹‰äºŒè¿›åˆ¶æ ¼å¼ + JSON headerï¼ˆæ— ä»£ç æ‰§è¡Œï¼‰</td>
</tr>
<tr>
<td><strong>å®‰å…¨æ€§</strong> âœ…</td>
<td><strong>å®‰å…¨</strong>ï¼šä»…åŒ…å«æ•°å€¼æ•°æ®ï¼Œæ— æ³•æ‰§è¡Œä»»æ„ä»£ç </td>
</tr>
<tr>
<td><strong>é€Ÿåº¦</strong></td>
<td>åŠ è½½é€šå¸¸æ¯” <code>.bin</code> æ›´å¿«ï¼ˆå°¤å…¶å¤§æ¨¡å‹ï¼‰ï¼Œæ”¯æŒå†…å­˜æ˜ å°„ï¼ˆ<code>mmap</code>ï¼‰</td>
</tr>
<tr>
<td><strong>è·¨æ¡†æ¶</strong></td>
<td>æ”¯æŒ PyTorchã€TensorFlowã€Flaxã€JAX ç­‰ï¼ˆåªè¦èƒ½è¯»å– NumPy-like å¼ é‡ï¼‰</td>
</tr>
<tr>
<td><strong>æ–‡ä»¶å¤§å°</strong></td>
<td>ä¸ <code>.bin</code> å‡ ä¹ç›¸åŒï¼ˆæœªå‹ç¼©ï¼Œä½†å¯é€‰ gzipï¼‰</td>
</tr>
<tr>
<td><strong>å…¸å‹ç”¨é€”</strong></td>
<td>Hugging Face æ–°æ¨¡å‹æ¨èæ ¼å¼ï¼Œå°¤å…¶åœ¨å…¬å¼€åˆ†äº«æˆ– Web æœåŠ¡ä¸­</td>
</tr>
</tbody>
</table>
<p><strong>æ–‡ä»¶ç»“æ„ç®€è¿°ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[JSON metadata header (UTF-8, padded to 8-byte align)]
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;weight1&#34;: {&#34;dtype&#34;: &#34;F32&#34;, &#34;shape&#34;: [1024, 1024], &#34;data_offsets&#34;: [0, 4194304]},
</span></span><span style="display:flex;"><span>  &#34;weight2&#34;: {&#34;dtype&#34;: &#34;F16&#34;, &#34;shape&#34;: [512], &#34;data_offsets&#34;: [4194304, 4195328]}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>[Raw binary tensor data (concatenated)]
</span></span></code></pre></div><p><strong>ç¤ºä¾‹åŠ è½½æ–¹å¼ï¼ˆPyTorchï¼‰ï¼š</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#5bc4bf">from</span> <span style="color:#fec418">safetensors.torch</span> <span style="color:#5bc4bf">import</span> load_file
</span></span><span style="display:flex;"><span>state_dict <span style="color:#5bc4bf">=</span> load_file(<span style="color:#48b685">&#34;model.safetensors&#34;</span>, device<span style="color:#5bc4bf">=</span><span style="color:#48b685">&#34;cpu&#34;</span>)
</span></span><span style="display:flex;"><span>model<span style="color:#5bc4bf">.</span>load_state_dict(state_dict)
</span></span></code></pre></div><p><strong>å¯¹æ¯”æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th><code>pytorch_model.bin</code></th>
<th><code>model.safetensors</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åº•å±‚æœºåˆ¶</strong></td>
<td>Python <code>pickle</code></td>
<td>è‡ªå®šä¹‰äºŒè¿›åˆ¶ + JSON</td>
</tr>
<tr>
<td><strong>å®‰å…¨æ€§</strong></td>
<td>âŒ å±é™©ï¼ˆå¯æ‰§è¡Œä»£ç ï¼‰</td>
<td>âœ… å®‰å…¨ï¼ˆçº¯æ•°æ®ï¼‰</td>
</tr>
<tr>
<td><strong>åŠ è½½é€Ÿåº¦</strong></td>
<td>å¿«</td>
<td>é€šå¸¸æ›´å¿«ï¼ˆæ”¯æŒ mmapï¼‰</td>
</tr>
<tr>
<td><strong>è·¨å¹³å°/è¯­è¨€</strong></td>
<td>å¦ï¼ˆPyTorch + Pythonï¼‰</td>
<td>æ˜¯ï¼ˆå¤šæ¡†æ¶æ”¯æŒï¼‰</td>
</tr>
<tr>
<td><strong>Hugging Face æ¨è</strong></td>
<td>æ—§æ¨¡å‹é»˜è®¤</td>
<td>æ–°æ¨¡å‹é¦–é€‰</td>
</tr>
<tr>
<td><strong>æ–‡ä»¶æ‰©å±•å</strong></td>
<td><code>.bin</code></td>
<td><code>.safetensors</code></td>
</tr>
</tbody>
</table>
<p><strong>å®é™…å»ºè®®</strong></p>
<ul>
<li>âœ… <strong>ä¼˜å…ˆä½¿ç”¨ <code>.safetensors</code></strong>ï¼šå°¤å…¶å½“ä½ ä»ç½‘ä¸Šä¸‹è½½æ¨¡å‹ã€éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæˆ–æä¾› API æœåŠ¡æ—¶ã€‚</li>
<li>ğŸ”’ <strong>é¿å…åŠ è½½æœªçŸ¥æ¥æºçš„ <code>.bin</code> æ–‡ä»¶</strong>ï¼šé™¤éä½ å®Œå…¨ä¿¡ä»»æä¾›è€…ã€‚</li>
<li>ğŸ”„ å¾ˆå¤šæ¨¡å‹ä»“åº“åŒæ—¶æä¾›ä¸¤ç§æ ¼å¼ï¼ˆå¦‚ Llama 3ã€Mistralï¼‰ï¼Œä½ å¯ä»¥è‡ªç”±é€‰æ‹©ã€‚</li>
<li>ğŸ› ï¸ å¯ç”¨å·¥å…·è½¬æ¢ï¼š
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#776e71"># ä½¿ç”¨ Hugging Face transformers è‡ªåŠ¨è½¬æ¢</span>
</span></span><span style="display:flex;"><span>from transformers import AutoModel
</span></span><span style="display:flex;"><span><span style="color:#ef6155">model</span> <span style="color:#5bc4bf">=</span> AutoModel.from_pretrained<span style="color:#5bc4bf">(</span><span style="color:#48b685">&#34;your-model&#34;</span>, <span style="color:#ef6155">use_safetensors</span><span style="color:#5bc4bf">=</span>True<span style="color:#5bc4bf">)</span>  <span style="color:#776e71"># è‡ªåŠ¨ä¼˜å…ˆåŠ è½½ .safetensors</span>
</span></span></code></pre></div></li>
</ul>
<p>å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªéœ€è¦åŠ è½½å¤–éƒ¨æ¨¡å‹çš„åº”ç”¨ï¼ˆå¦‚ Web UIã€æ¨ç†æœåŠ¡ï¼‰ï¼Œ<strong>å¼ºçƒˆå»ºè®®åªæ”¯æŒ <code>.safetensors</code> æ ¼å¼</strong>ä»¥è§„é¿å®‰å…¨é£é™©ã€‚</p>
<h4 id="é—®é¢˜sparse-text-embeddings-å’Œ-dense-text-embeddings-çš„åŒºåˆ«">é—®é¢˜ï¼šSparse text embeddings å’Œ dense text embeddings çš„åŒºåˆ«<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜sparse-text-embeddings-å’Œ-dense-text-embeddings-çš„åŒºåˆ«">#</a></h4>
<p><strong>Sparse text embeddings</strong> å’Œ <strong>dense text embeddings</strong> æ˜¯ä¸¤ç§ä¸åŒçš„æ–‡æœ¬è¡¨ç¤ºæ–¹æ³•ï¼Œå®ƒä»¬åœ¨ç»“æ„ã€ç”Ÿæˆæ–¹å¼ã€åº”ç”¨åœºæ™¯å’Œæ€§èƒ½ç‰¹ç‚¹ä¸Šæœ‰æ˜¾è‘—åŒºåˆ«ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†å¯¹æ¯”ï¼š</p>
<p><strong>ä¸€ã€æ ¸å¿ƒå®šä¹‰</strong></p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>å®šä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dense Embeddingsï¼ˆç¨ å¯†åµŒå…¥ï¼‰</strong></td>
<td>å°†æ–‡æœ¬æ˜ å°„ä¸ºä¸€ä¸ª<strong>ä½ç»´ï¼ˆé€šå¸¸å‡ ç™¾åˆ°å‡ åƒç»´ï¼‰ã€è¿ç»­ã€ç¨ å¯†</strong>çš„å®æ•°å‘é‡ï¼Œå‡ ä¹æ‰€æœ‰ç»´åº¦éƒ½æœ‰éé›¶å€¼ã€‚</td>
</tr>
<tr>
<td><strong>Sparse Embeddingsï¼ˆç¨€ç–åµŒå…¥ï¼‰</strong></td>
<td>å°†æ–‡æœ¬è¡¨ç¤ºä¸ºä¸€ä¸ª<strong>é«˜ç»´ï¼ˆå¯èƒ½æ•°ä¸‡åˆ°ç™¾ä¸‡ç»´ï¼‰ã€ç¦»æ•£ã€ç¨€ç–</strong>çš„å‘é‡ï¼Œç»å¤§å¤šæ•°ç»´åº¦ä¸º 0ï¼Œåªæœ‰å°‘æ•°ç»´åº¦æœ‰éé›¶å€¼ï¼ˆé€šå¸¸æ˜¯æ­£æƒé‡ï¼‰ã€‚</td>
</tr>
</tbody>
</table>
<p><strong>äºŒã€å…¸å‹ä»£è¡¨</strong></p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>æ¨¡å‹/æ–¹æ³•ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Dense</strong></td>
<td>- BERT, RoBERTa  <br>- Sentence-BERT (SBERT)  <br>- BGE (BAAI General Embedding)  <br>- OpenAI Embeddings  <br>- Cohere Embeddings</td>
</tr>
<tr>
<td><strong>Sparse</strong></td>
<td>- BM25ï¼ˆä¼ ç»Ÿï¼Œéå­¦ä¹ å‹ï¼‰  <br>- SPLADE  <br>- uniCOIL  <br>- DeepImpact  <br>- ColBERTï¼ˆéƒ¨åˆ†ç¨€ç–ï¼Œå¸¦åæœŸäº¤äº’ï¼‰</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ğŸ’¡ æ³¨æ„ï¼šBM25 è™½ç„¶å¸¸è¢«å½’ä¸ºâ€œç¨€ç–æ£€ç´¢â€ï¼Œä½†å®ƒä¸æ˜¯â€œembedding æ¨¡å‹â€ï¼ˆæ— ç¥ç»ç½‘ç»œï¼‰ï¼Œè€Œ SPLADE ç­‰æ˜¯<strong>åŸºäºæ·±åº¦å­¦ä¹ çš„ç¨€ç– embedding æ¨¡å‹</strong>ã€‚</p>
</blockquote>
<p><strong>ä¸‰ã€ç»“æ„å¯¹æ¯”ï¼ˆä¸¾ä¾‹ï¼‰</strong>
å‡è®¾è¯æ±‡è¡¨å¤§å°ä¸º 30,000ï¼š</p>
<ul>
<li><strong>Sparse embedding</strong>ï¼ˆå¦‚ SPLADEï¼‰ï¼š
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>[<span style="color:#f99b15">0</span>, <span style="color:#f99b15">0</span>, <span style="color:#f99b15">0</span>, <span style="color:#5bc4bf">...</span>, <span style="color:#f99b15">2.1</span>, <span style="color:#f99b15">0</span>, <span style="color:#f99b15">0</span>, <span style="color:#5bc4bf">...</span>, <span style="color:#f99b15">0.8</span>, <span style="color:#5bc4bf">...</span>, <span style="color:#f99b15">0</span>]  <span style="color:#776e71"># é•¿åº¦=30,000ï¼Œä»…å‡ åä¸ªéé›¶å€¼</span>
</span></span></code></pre></div>â†’ æ¯ä¸ªéé›¶ä½ç½®å¯¹åº”ä¸€ä¸ªè¯ï¼ˆå¦‚ &ldquo;apple&rdquo; åœ¨ç´¢å¼• 12345ï¼‰ï¼Œå€¼è¡¨ç¤ºé‡è¦æ€§ã€‚</li>
<li><strong>Dense embedding</strong>ï¼ˆå¦‚ BGEï¼‰ï¼š
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>[<span style="color:#f99b15">0.23</span>, <span style="color:#5bc4bf">-</span><span style="color:#f99b15">0.41</span>, <span style="color:#f99b15">0.88</span>, <span style="color:#5bc4bf">...</span>, <span style="color:#f99b15">0.05</span>]  <span style="color:#776e71"># é•¿åº¦=1024ï¼Œå‡ ä¹æ¯ä¸ªå€¼éƒ½éé›¶</span>
</span></span></code></pre></div>â†’ å‘é‡ç»´åº¦ä¸è¯æ±‡è¡¨æ— å…³ï¼Œè¯­ä¹‰ä¿¡æ¯åˆ†å¸ƒåœ¨æ•´ä¸ªå‘é‡ä¸­ã€‚</li>
</ul>
<p><strong>å››ã€å…³é”®åŒºåˆ«æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>ç»´åº¦</th>
<th>Sparse Embeddings</th>
<th>Dense Embeddings</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç»´åº¦</strong></td>
<td>é«˜ç»´ï¼ˆâ‰ˆè¯æ±‡è¡¨å¤§å°ï¼Œå¦‚ 30kâ€“1Mï¼‰</td>
<td>ä½ç»´ï¼ˆé€šå¸¸ 384â€“4096ï¼‰</td>
</tr>
<tr>
<td><strong>éé›¶å…ƒç´ </strong></td>
<td>æå°‘ï¼ˆ&lt; 100 ä¸ªï¼‰</td>
<td>å‡ ä¹å…¨éƒ¨éé›¶</td>
</tr>
<tr>
<td><strong>å¯è§£é‡Šæ€§</strong></td>
<td>âœ… é«˜ï¼ˆæ¯ä¸ªéé›¶ç»´å¯¹åº”ä¸€ä¸ªè¯ï¼‰</td>
<td>âŒ ä½ï¼ˆè¯­ä¹‰åˆ†å¸ƒåœ¨éšç©ºé—´ï¼‰</td>
</tr>
<tr>
<td><strong>å­˜å‚¨æ•ˆç‡</strong></td>
<td>âœ… é«˜ï¼ˆå¯ç”¨å€’æ’ç´¢å¼•å‹ç¼©å­˜å‚¨ï¼‰</td>
<td>âš ï¸ ä¸­ç­‰ï¼ˆéœ€å­˜å‚¨å®Œæ•´æµ®ç‚¹æ•°ç»„ï¼‰</td>
</tr>
<tr>
<td><strong>æ£€ç´¢æ–¹å¼</strong></td>
<td>å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰ + TF-IDF/BM25 é£æ ¼æ‰“åˆ†</td>
<td>å‘é‡ç›¸ä¼¼åº¦ï¼ˆå¦‚ä½™å¼¦ã€å†…ç§¯ï¼‰+ ANNï¼ˆå¦‚ FAISS, HNSWï¼‰</td>
</tr>
<tr>
<td><strong>è®­ç»ƒç›®æ ‡</strong></td>
<td>ä¼˜åŒ–è¯çº§é‡è¦æ€§ï¼ˆå¦‚é€šè¿‡ KL æ•£åº¦å¯¹é½ BM25ï¼‰</td>
<td>ä¼˜åŒ–å¥å­/æ®µè½çº§è¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆå¦‚å¯¹æ¯”å­¦ä¹ ï¼‰</td>
</tr>
<tr>
<td><strong>å¤šè¯­è¨€æ”¯æŒ</strong></td>
<td>ä¾èµ–è¯æ±‡è¡¨ï¼Œè·¨è¯­è¨€è¾ƒéš¾</td>
<td>æ›´å®¹æ˜“é€šè¿‡å…±äº«è¯­ä¹‰ç©ºé—´å®ç°</td>
</tr>
<tr>
<td><strong>ç¡¬ä»¶åŠ é€Ÿ</strong></td>
<td>CPU å‹å¥½ï¼Œé€‚åˆå¤§è§„æ¨¡æ–‡æ¡£åº“</td>
<td>GPU/ANN åŠ é€Ÿæ•ˆæœæ›´å¥½</td>
</tr>
</tbody>
</table>
<p><strong>äº”ã€åº”ç”¨åœºæ™¯</strong></p>
<p><strong>âœ… Sparse æ›´é€‚åˆï¼š</strong></p>
<ul>
<li><strong>å¤§è§„æ¨¡æ–‡æ¡£æ£€ç´¢</strong>ï¼ˆå¦‚æœç´¢å¼•æ“ï¼‰ï¼š==åˆ©ç”¨æˆç†Ÿçš„å€’æ’ç´¢å¼•æŠ€æœ¯==ï¼Œé«˜æ•ˆè¿‡æ»¤æµ·é‡æ–‡æ¡£ã€‚</li>
<li><strong>å…³é”®è¯æ•æ„Ÿä»»åŠ¡</strong>ï¼šéœ€è¦ç²¾ç¡®åŒ¹é…æœ¯è¯­ï¼ˆå¦‚æ³•å¾‹ã€åŒ»ç–—æ£€ç´¢ï¼‰ã€‚</li>
<li><strong>èµ„æºå—é™ç¯å¢ƒ</strong>ï¼šæ— éœ€ GPUï¼Œçº¯ CPU å³å¯é«˜æ•ˆè¿è¡Œã€‚</li>
</ul>
<p><strong>âœ… Dense æ›´é€‚åˆï¼š</strong></p>
<ul>
<li><strong>è¯­ä¹‰ç›¸ä¼¼åº¦ä»»åŠ¡</strong>ï¼šç†è§£åŒä¹‰ã€ paraphraseã€ä¸Šä¸‹æ–‡å«ä¹‰ï¼ˆå¦‚ â€œcarâ€ â‰ˆ â€œautomobileâ€ï¼‰ã€‚</li>
<li><strong>å°æ ·æœ¬æˆ– zero-shot åœºæ™¯</strong>ï¼šæ³›åŒ–èƒ½åŠ›å¼ºã€‚</li>
<li><strong>RAG ç³»ç»Ÿä¸­çš„ç²¾æ’</strong>ï¼šä¸ LLM ç»“åˆæ•ˆæœå¥½ã€‚</li>
</ul>
<p><strong>å…­ã€æ··åˆæ–¹æ³•ï¼ˆHybrid Retrievalï¼‰</strong>
ç°ä»£ç³»ç»Ÿå¸¸<strong>ç»“åˆä¸¤è€…ä¼˜åŠ¿</strong>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Query â†’ [Sparse Retriever (BM25/SPLADE)] â†’ Top K candidates
</span></span><span style="display:flex;"><span>       + [Dense Retriever (BGE)]          â†’ Top K candidates
</span></span><span style="display:flex;"><span>       â†’ åˆå¹¶å»é‡ â†’ Reranker (e.g., BGE-reranker)
</span></span></code></pre></div><ul>
<li><strong>ColBERT</strong>ï¼šè™½è¾“å‡ºç¨ å¯† token å‘é‡ï¼Œä½†é€šè¿‡ MaxSim å®ç°ç±»ä¼¼ç¨€ç–çš„ç»†ç²’åº¦åŒ¹é…ã€‚</li>
<li><strong>BGE-M3</strong>ï¼ˆBAAI æœ€æ–°æ¨¡å‹ï¼‰ï¼šåŒæ—¶è¾“å‡º denseã€sparse å’Œ multi-vector è¡¨ç¤ºï¼Œæ”¯æŒç»Ÿä¸€æ£€ç´¢ã€‚</li>
</ul>
<p><strong>ä¸ƒã€å¯è§†åŒ–æ¯”å–»</strong></p>
<ul>
<li><strong>Sparse</strong>ï¼šåƒä¸€æœ¬<strong>ç´¢å¼•ç›®å½•</strong>â€”â€”åªåˆ—å‡ºå…³é”®è¯åŠå…¶é¡µç ï¼ˆä½ç½®+æƒé‡ï¼‰ã€‚</li>
<li><strong>Dense</strong>ï¼šåƒä¸€å¹…<strong>æŠ½è±¡ç”»</strong>â€”â€”æ•´ä½“è¡¨è¾¾è¯­ä¹‰ï¼Œæ— æ³•æ‹†è§£å•ä¸ªå…ƒç´ å«ä¹‰ã€‚</li>
</ul>
<p><strong>æ€»ç»“ä¸€å¥è¯ï¼š</strong></p>
<blockquote>
<p><strong>Sparse embeddings = å…³é”®è¯åŠ æƒï¼ˆå¯è§£é‡Šã€é«˜æ•ˆï¼‰ï¼›Dense embeddings = è¯­ä¹‰å‹ç¼©ï¼ˆæ³›åŒ–å¼ºã€éœ€å‘é‡æ£€ç´¢ï¼‰</strong>ã€‚
æ ¹æ®ä½ çš„ä»»åŠ¡éœ€æ±‚ï¼ˆç²¾åº¦ vs æ•ˆç‡ã€å…³é”®è¯åŒ¹é… vs è¯­ä¹‰ç†è§£ï¼‰ï¼Œå¯ä»¥é€‰æ‹©åˆé€‚ç±»å‹ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ <strong>hybrid æ–¹æ¡ˆ</strong>è·å¾—æœ€ä½³æ•ˆæœã€‚</p>
</blockquote>
<h4 id="é—®é¢˜sparse-embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ°-è¾“å‡ºç¨€ç–å‘é‡çš„">é—®é¢˜ï¼šSparse Embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ° è¾“å‡ºç¨€ç–å‘é‡çš„<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜sparse-embeddingsçš„æ¨¡å‹å¦‚ä½•åšåˆ°-è¾“å‡ºç¨€ç–å‘é‡çš„">#</a></h4>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼<strong>Sparse Embeddings æ¨¡å‹ï¼ˆå¦‚ SPLADEã€uniCOILã€DeepImpact ç­‰ï¼‰ä¹‹æ‰€ä»¥èƒ½è¾“å‡ºâ€œç¨€ç–ä½†æœ‰ä¿¡æ¯é‡â€çš„å‘é‡ï¼Œå…³é”®åœ¨äºå®ƒä»¬é€šè¿‡ç¥ç»ç½‘ç»œå­¦ä¹ æ¯ä¸ªè¯é¡¹ï¼ˆtermï¼‰çš„é‡è¦æ€§æƒé‡ï¼Œå¹¶å¼ºåˆ¶ç»å¤§å¤šæ•°æƒé‡ä¸ºé›¶æˆ–æ¥è¿‘é›¶</strong>ã€‚ä¸‹é¢ä»åŸç†ã€æŠ€æœ¯æ‰‹æ®µå’Œè®­ç»ƒç›®æ ‡ä¸‰ä¸ªæ–¹é¢è¯¦ç»†è§£é‡Šï¼š</p>
<p><strong>ä¸€ã€æ ¸å¿ƒæ€æƒ³ï¼šå°†æ–‡æœ¬æ˜ å°„åˆ°â€œè¯æ±‡è¡¨ç»´åº¦â€çš„ç¨€ç–å‘é‡</strong>
ä¸ dense embedding è¾“å‡ºä¸€ä¸ªå›ºå®šä½ç»´å‘é‡ä¸åŒï¼Œ<strong>sparse embedding æ¨¡å‹çš„è¾“å‡ºç»´åº¦ = è¯æ±‡è¡¨å¤§å°ï¼ˆVï¼‰</strong>ï¼ˆä¾‹å¦‚ V = 30,000ï¼‰ã€‚<br>
å¯¹äºè¾“å…¥æ–‡æœ¬ï¼Œæ¨¡å‹ä¼šä¸ºè¯æ±‡è¡¨ä¸­çš„æ¯ä¸ªè¯ $w_i$ é¢„æµ‹ä¸€ä¸ª <strong>éè´Ÿé‡è¦æ€§åˆ†æ•° $s_i \geq 0$</strong>ï¼Œæœ€ç»ˆè¾“å‡ºå‘é‡ä¸ºï¼š
$$ \mathbf{e} = [s_1, s_2, &hellip;, s_V] $$
å…¶ä¸­ <strong>ç»å¤§å¤šæ•° $s_i = 0$</strong>ï¼Œåªæœ‰å°‘æ•°å…³é”®è¯çš„ $s_i &gt; 0$ï¼Œå½¢æˆç¨€ç–è¡¨ç¤ºã€‚</p>
<blockquote>
<p>âœ… è¿™ä¸ªå‘é‡å¯ä»¥ç›´æ¥ç”¨äº <strong>å€’æ’ç´¢å¼•ï¼ˆInverted Indexï¼‰æ£€ç´¢</strong>ï¼Œå°±åƒ BM25 ä¸€æ ·é«˜æ•ˆã€‚</p>
</blockquote>
<p><strong>äºŒã€å¦‚ä½•å®ç°â€œç¨€ç–æ€§â€ï¼Ÿå…³é”®æŠ€æœ¯æ‰‹æ®µ</strong></p>
<p><strong>1. <strong>ä½¿ç”¨å¸¦ç¨€ç–è¯±å¯¼çš„æ¿€æ´»å‡½æ•°</strong></strong>
æœ€å¸¸ç”¨çš„æ˜¯ <strong>ReLU + å¯¹æ•°å˜æ¢ + FLOPS æ­£åˆ™åŒ–</strong>ï¼ˆä»¥ SPLADE ä¸ºä»£è¡¨ï¼‰ï¼š</p>
<p><strong>ï¼ˆ1ï¼‰åŸºäº BERT çš„ token-level logits</strong></p>
<ul>
<li>è¾“å…¥æ–‡æœ¬ â†’ BERT ç¼–ç å™¨ â†’ å¾—åˆ°æ¯ä¸ª token çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚</li>
<li>é€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚ï¼ˆæˆ– MLM headï¼‰é¢„æµ‹ <strong>æ•´ä¸ªè¯æ±‡è¡¨ä¸Šæ¯ä¸ªè¯çš„ logits</strong>ï¼ˆç±»ä¼¼æ©ç è¯­è¨€å»ºæ¨¡ï¼‰ã€‚</li>
</ul>
<p><strong>ï¼ˆ2ï¼‰åº”ç”¨ <strong>$\text{ReLU}(\log(1 + \exp(x)))$</strong> æˆ–ç›´æ¥ <strong>$\text{F}(x) = \max(0, x)$</strong></strong></p>
<ul>
<li>å°† logits ç»è¿‡ <strong>éè´Ÿæ¿€æ´»</strong>ï¼Œç¡®ä¿è¾“å‡º â‰¥ 0ã€‚</li>
<li>å®é™…ä¸­å¸¸ç”¨ï¼š<br>
$$s_i = \text{ReLU}\left( \text{MLM logits}_i \right)$$ æˆ–æ›´å¹³æ»‘çš„ï¼š $$ s_i = \log\left(1 + \exp(\text{MLM logits}_i)\right) \quad \text{(softplus)} $$</li>
</ul>
<blockquote>
<p>ğŸ“Œ æ³¨æ„ï¼šå³ä½¿ logits æ˜¯ç¨ å¯†çš„ï¼Œåç»­ä¼šé€šè¿‡æ­£åˆ™åŒ–è®©å¤§å¤šæ•° $s_i \to 0$ã€‚</p>
</blockquote>
<p><strong>2. <strong>å¼•å…¥ç¨€ç–æ€§æ­£åˆ™åŒ–ï¼ˆSparsity Regularizationï¼‰</strong></strong>
è¿™æ˜¯å®ç°â€œçœŸæ­£ç¨€ç–â€çš„å…³é”®ï¼æ¨¡å‹åœ¨è®­ç»ƒæ—¶ä¼š<strong>æƒ©ç½šéé›¶å…ƒç´ çš„æ•°é‡æˆ–å¤§å°</strong>ã€‚</p>
<p><strong>å¸¸è§æ­£åˆ™é¡¹ï¼ˆåŠ åœ¨ loss ä¸­ï¼‰ï¼š</strong></p>
<ul>
<li><strong>L1 æ­£åˆ™åŒ–</strong>ï¼š$\lambda \sum_i |s_i|$<br>
â†’ é¼“åŠ±æƒé‡è¶‹è¿‘äº 0ã€‚</li>
<li><strong>FLOPS æ­£åˆ™åŒ–ï¼ˆSPLADE æå‡ºï¼‰</strong>ï¼š<br>
$$ \mathcal{L}_{\text{flops}} = \left( \frac{1}{V} \sum_i \mathbb{E}[s_i] \right)^2 $$ â†’ æƒ©ç½š<strong>å¹³å‡æ¿€æ´»å¼ºåº¦</strong>ï¼Œä¿ƒä½¿æ¨¡å‹åªæ¿€æ´»æå°‘æ•°è¯ã€‚</li>
<li><strong>Group Lasso / Top-k çº¦æŸ</strong>ï¼šå¼ºåˆ¶åªä¿ç•™ top-k ä¸ªæœ€å¤§æƒé‡ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¡ è®­ç»ƒå®Œæˆåï¼Œæ¨ç†æ—¶å¯è®¾ç½®é˜ˆå€¼ï¼ˆå¦‚ $s_i &lt; 1e-4$ åˆ™ç½® 0ï¼‰ï¼Œè¿›ä¸€æ­¥æå‡ç¨€ç–åº¦ã€‚</p>
</blockquote>
<p><strong>3. <strong>åˆ©ç”¨é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„ MLM Head</strong></strong></p>
<ul>
<li>SPLADE ç­‰æ¨¡å‹ç›´æ¥å¤ç”¨ <strong>BERT çš„ Masked Language Model (MLM) å¤´</strong>ã€‚</li>
<li>MLM å¤´æœ¬æ¥å°±èƒ½é¢„æµ‹â€œå“ªäº›è¯å¯èƒ½å‡ºç°åœ¨ä¸Šä¸‹æ–‡ä¸­â€ï¼Œå¤©ç„¶å…·æœ‰<strong>è¯çº§è¯­ä¹‰æ„ŸçŸ¥èƒ½åŠ›</strong>ã€‚</li>
<li>é€šè¿‡å¾®è°ƒ MLM å¤´ï¼Œä½¿å…¶è¾“å‡ºçš„ logits ä¸å†ç”¨äºé¢„æµ‹è¢«é®ç›–è¯ï¼Œè€Œæ˜¯ä½œä¸º<strong>å…¨æ–‡çš„è¯é‡è¦æ€§åˆ†å¸ƒ</strong>ã€‚</li>
</ul>
<blockquote>
<p>âœ… è¿™æ ·æ—¢åˆ©ç”¨äº†é¢„è®­ç»ƒçŸ¥è¯†ï¼Œåˆå®ç°äº†ç«¯åˆ°ç«¯çš„ç¨€ç–è¡¨ç¤ºå­¦ä¹ ã€‚</p>
</blockquote>
<p><strong>ä¸‰ã€è®­ç»ƒç›®æ ‡ï¼šå¯¹é½ç›¸å…³æ€§ä¿¡å·</strong>
ä¸ºäº†è®©ç¨€ç–å‘é‡â€œæœ‰ä¿¡æ¯é‡â€ï¼ˆå³èƒ½æœ‰æ•ˆæ’åºç›¸å…³æ–‡æ¡£ï¼‰ï¼Œæ¨¡å‹é€šå¸¸é‡‡ç”¨ä»¥ä¸‹ç›‘ç£ä¿¡å·ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>è®­ç»ƒç›®æ ‡</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>SPLADE</strong></td>
<td>æœ€å¤§åŒ–æŸ¥è¯¢-æ­£æ ·æœ¬æ–‡æ¡£çš„ç›¸ä¼¼åº¦ï¼ˆå†…ç§¯ï¼‰ï¼Œæœ€å°åŒ–æŸ¥è¯¢-è´Ÿæ ·æœ¬çš„ç›¸ä¼¼åº¦ + ç¨€ç–æ­£åˆ™</td>
</tr>
<tr>
<td><strong>DeepImpact / uniCOIL</strong></td>
<td>å›å½’åˆ°ä¼ªæ ‡ç­¾ï¼ˆå¦‚ BM25 åˆ†æ•°ã€æ•™å¸ˆæ¨¡å‹æ‰“åˆ†ï¼‰</td>
</tr>
<tr>
<td><strong>æ— ç›‘ç£ SPLADE</strong></td>
<td>ä½¿ç”¨å¯¹æ¯”å­¦ä¹ æˆ–è‡ªç›‘ç£ï¼ˆå¦‚æ–‡æ¡£-æ ‡é¢˜å¯¹ï¼‰</td>
</tr>
<tr>
<td>ç›¸ä¼¼åº¦è®¡ç®—æ–¹å¼ï¼š $$ \text{score}(q, d) = \sum_{i=1}^V \text{ReLU}(q_i) \cdot \text{ReLU}(d_i) $$ â†’ æœ¬è´¨æ˜¯ <strong>åŠ æƒè¯é‡å ï¼ˆWeighted Term Matchingï¼‰</strong>ï¼Œä½†æƒé‡ç”±ç¥ç»ç½‘ç»œå­¦ä¹ å¾—åˆ°ï¼Œæ¯” TF-IDF/BM25 æ›´æ™ºèƒ½ã€‚</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>å››ã€ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼šSPLADE å¦‚ä½•å·¥ä½œï¼Ÿ</strong></p>
<ol>
<li>è¾“å…¥æŸ¥è¯¢ <code>&quot;How to bake a cake?&quot;</code></li>
<li>ç»è¿‡ BERT + MLM head â†’ è¾“å‡º 30,000 ç»´ logits</li>
<li>åº”ç”¨ $\text{ReLU}(\cdot)$ â†’ å¾—åˆ°éè´Ÿåˆ†æ•°</li>
<li>åŠ å…¥ FLOPS æ­£åˆ™ â†’ æ¨¡å‹å­¦ä¼šåªç»™ <code>&quot;bake&quot;</code>, <code>&quot;cake&quot;</code>, <code>&quot;recipe&quot;</code> ç­‰è¯é«˜åˆ†ï¼Œå…¶ä½™ä¸º 0</li>
<li>æœ€ç»ˆè¾“å‡ºç¨€ç–å‘é‡ï¼šä»…å‡ åä¸ªéé›¶å€¼ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªå…³é”®è¯åŠå…¶è¯­ä¹‰é‡è¦æ€§
ğŸ” æ£€ç´¢æ—¶ï¼š</li>
</ol>
<ul>
<li>æ–‡æ¡£ä¹Ÿç”¨åŒæ ·æ–¹å¼ç¼–ç æˆç¨€ç–å‘é‡</li>
<li>é€šè¿‡å€’æ’ç´¢å¼•å¿«é€Ÿè®¡ç®—å†…ç§¯å¾—åˆ†ï¼ˆåªè®¡ç®—éé›¶ç»´åº¦äº¤é›†ï¼‰</li>
</ul>
<p><strong>äº”ã€ä¸ºä»€ä¹ˆå«â€œå“äº®â€ï¼ˆinformativeï¼‰ï¼Ÿ</strong></p>
<ul>
<li>è™½ç„¶ç¨€ç–ï¼Œä½†<strong>éé›¶ç»´åº¦æ˜¯æ¨¡å‹ç²¾å¿ƒæŒ‘é€‰çš„å…³é”®è¯</strong>ï¼Œä¸”æƒé‡åæ˜ å…¶åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„<strong>è¯­ä¹‰é‡è¦æ€§</strong>ã€‚</li>
<li>ç›¸æ¯” BM25 çš„é™æ€ TF-IDFï¼Œsparse embedding èƒ½ï¼š
<ul>
<li>ç†è§£åŒä¹‰è¯ï¼ˆ&ldquo;car&rdquo; â†’ æ¿€æ´» &ldquo;automobile&rdquo;ï¼‰</li>
<li>æŠ‘åˆ¶åœç”¨è¯ï¼ˆ&ldquo;the&rdquo;, &ldquo;how&rdquo; æƒé‡â‰ˆ0ï¼‰</li>
<li>æ ¹æ®ä¸Šä¸‹æ–‡åŠ¨æ€è°ƒæ•´ï¼ˆ&ldquo;apple&rdquo; åœ¨ç§‘æŠ€ vs æ°´æœè¯­å¢ƒä¸‹æ¿€æ´»ä¸åŒè¯ï¼‰</li>
</ul>
</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<table>
<thead>
<tr>
<th>å…³é”®ç‚¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>è¾“å‡ºç»´åº¦</strong></td>
<td>= è¯æ±‡è¡¨å¤§å°ï¼ˆé«˜ç»´ï¼‰</td>
</tr>
<tr>
<td><strong>ç¨€ç–æ€§æ¥æº</strong></td>
<td>ReLU/Softplus æ¿€æ´» + L1/FLOPS æ­£åˆ™åŒ–</td>
</tr>
<tr>
<td><strong>ä¿¡æ¯é‡æ¥æº</strong></td>
<td>åŸºäºé¢„è®­ç»ƒ MLM å¤´ + ç›¸å…³æ€§ç›‘ç£å­¦ä¹ </td>
</tr>
<tr>
<td><strong>æ£€ç´¢å…¼å®¹æ€§</strong></td>
<td>å®Œå…¨å…¼å®¹ä¼ ç»Ÿå€’æ’ç´¢å¼•ç³»ç»Ÿï¼ˆå¦‚ Lucene, Elasticsearchï¼‰</td>
</tr>
<tr>
<td><strong>ä»£è¡¨æ¨¡å‹</strong></td>
<td>SPLADEï¼ˆæœ€ç»å…¸ï¼‰ã€uniCOILã€DeepImpactã€BGE-M3ï¼ˆæ”¯æŒ sparse è¾“å‡ºï¼‰</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… æ‰€ä»¥ï¼Œ<strong>â€œç¨€ç–ä½†å“äº®â€ = åªä¿ç•™æœ€å…³é”®çš„å‡ ä¸ªè¯ï¼Œä½†æ¯ä¸ªè¯çš„æƒé‡éƒ½ç»è¿‡æ·±åº¦è¯­ä¹‰ç†è§£ä¼˜åŒ–</strong>ã€‚
å¦‚æœä½ æ­£åœ¨æ„å»ºæ£€ç´¢ç³»ç»Ÿï¼Œsparse embeddings èƒ½è®©ä½ åœ¨ä¸ç‰ºç‰²å¤ªå¤šè¯­ä¹‰èƒ½åŠ›çš„å‰æä¸‹ï¼Œäº«å—ä¼ ç»Ÿæœç´¢å¼•æ“çš„é«˜æ•ˆä¸å¯æ‰©å±•æ€§ã€‚</p>
</blockquote>
<h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–é—®é¢˜">#</a></h2>
<h4 id="é—®é¢˜langchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„">é—®é¢˜ï¼šlangchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜langchainä¸­çš„ç«–çº¿è¿ç®—ç¬¦æ˜¯ç”±å“ªäº›æ–¹æ³•æ¥å®ç°çš„">#</a></h4>
<p>åœ¨ <code>langchain</code> ä¸­ï¼Œç«–çº¿è¿ç®—ç¬¦ï¼ˆ<code>|</code>ï¼‰çš„å®ç°ä¸»è¦ä¾èµ–äºä»¥ä¸‹æ–¹æ³•ï¼š</p>
<p><strong>æ ¸å¿ƒå®ç°æ–¹æ³•</strong></p>
<ol>
<li><strong><code>__or__</code> æ–¹æ³•</strong>
<ul>
<li>è¿™æ˜¯ Python ä¸­å®ç°ç«–çº¿è¿ç®—ç¬¦çš„æ ¸å¿ƒé­”æœ¯æ–¹æ³•</li>
<li>å½“ä½¿ç”¨ <code>a | b</code> è¯­æ³•æ—¶ï¼ŒPython ä¼šè°ƒç”¨ <code>a.__or__(b)</code></li>
</ul>
</li>
<li><strong><code>__ror__</code> æ–¹æ³•</strong>
<ul>
<li>å³ä¾§å¯¹è±¡çš„åå‘æˆ–è¿ç®—æ–¹æ³•</li>
<li>å½“å·¦ä¾§å¯¹è±¡æ²¡æœ‰å®ç° <code>__or__</code> æ—¶è°ƒç”¨</li>
</ul>
</li>
</ol>
<p><strong>åœ¨ Langchain ä¸­çš„åº”ç”¨</strong>
åœ¨ä½ çš„ä»£ç ä¸­ <code>prompt|llm|output_parser</code> è¿™ä¸ªé“¾æ¡ä¸­ï¼š</p>
<ul>
<li>promptï¼ˆ<code>ChatPromptTemplate</code> å¯¹è±¡ï¼‰å®ç°äº† <code>__or__</code> æ–¹æ³•</li>
<li>llmï¼ˆ<code>ChatOpenAI</code> å¯¹è±¡ï¼‰ä¹Ÿå®ç°äº† <code>__or__</code> æ–¹æ³•</li>
<li>output_parserï¼ˆ<code>StrOutputParser</code> å¯¹è±¡ï¼‰åŒæ ·æ”¯æŒé“¾å¼æ“ä½œ</li>
</ul>
<p><strong>å®ç°æœºåˆ¶</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5bc4bf">**</span>ä¼ªä»£ç ç¤ºä¾‹<span style="color:#5bc4bf">**</span>
</span></span><span style="display:flex;"><span><span style="color:#815ba4">class</span> <span style="color:#fec418">BaseComponent</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#815ba4">def</span> __or__(self, other):
</span></span><span style="display:flex;"><span>        <span style="color:#815ba4">return</span> Chain(self, other)
</span></span></code></pre></div><p>è¿™ç§è®¾è®¡æ¨¡å¼å…è®¸ä¸åŒçš„ <code>langchain</code> ç»„ä»¶ï¼ˆå¦‚ promptã€llmã€output_parserï¼‰é€šè¿‡ç«–çº¿è¿ç®—ç¬¦ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„å¤„ç†é“¾ chainã€‚</p>
<h4 id="é—®é¢˜langchainä¸­çš„stroutputparser-æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹-chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„">é—®é¢˜ï¼šlangchainä¸­çš„StrOutputParser æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹ chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜langchainä¸­çš„stroutputparser-æ˜¯å¦‚ä½•è‡ªåŠ¨å¯¹-chatbotçš„ç»“æœè¿›è¡Œæ¸²æŸ“çš„">#</a></h4>
<p>ä½œä¸ºä¸€åèµ„æ·±æŠ€æœ¯å¯¼å¸ˆï¼Œæˆ‘æ¥è¯¦ç»†è§£é‡Š LangChain ä¸­çš„ <code>StrOutputParser</code> <strong>ä¸æ˜¯</strong>å¦‚ä½•â€œè‡ªåŠ¨æ¸²æŸ“â€ç»“æœçš„ï¼Œè€Œæ˜¯å®ƒåœ¨ LangChain è¡¨è¾¾å¼è¯­è¨€ (LCEL) ç®¡é“ä¸­æ‰®æ¼”çš„<strong>å…³é”®è§’è‰²</strong>ã€‚</p>
<p><strong>æ ¸å¿ƒè§‚ç‚¹ï¼š<code>StrOutputParser</code> å¹¶éæ¸²æŸ“å™¨ï¼Œè€Œæ˜¯è½¬æ¢å™¨</strong>
<code>StrOutputParser</code> çš„ä½œç”¨<strong>ä¸æ˜¯</strong>å¯¹ç»“æœè¿›è¡Œå¤æ‚çš„â€œæ¸²æŸ“â€ï¼ˆå¦‚æ ¼å¼åŒ–ä¸º Markdown æˆ– HTMLï¼‰ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€ä¸ªéå¸¸ç®€å•ä½†è‡³å…³é‡è¦çš„<strong>ç±»å‹è½¬æ¢</strong>ï¼š
<strong>å®ƒç¡®ä¿ç®¡é“ï¼ˆChainï¼‰çš„æœ€ç»ˆè¾“å‡ºæ˜¯æ ‡å‡†çš„ Python å­—ç¬¦ä¸²ï¼ˆ<code>str</code>ï¼‰ç±»å‹ã€‚</strong>
åœ¨ LangChain ç®¡é“ä¸­ï¼Œâ€œæ¸²æŸ“â€è¿™ä¸ªè¯é€šå¸¸æ„å‘³ç€å°†è¾“å‡ºä»ä¸€ä¸ªå¤æ‚å¯¹è±¡è½¬æ¢ä¸ºç”¨æˆ·æˆ–ä¸‹ä¸€ä¸ªç»„ä»¶å¯ä»¥ä½¿ç”¨çš„æ ¼å¼ã€‚</p>
<p><strong>1. ä¸ºä»€ä¹ˆéœ€è¦ <code>StrOutputParser</code>ï¼Ÿ</strong>
LLM æ¨¡å‹çš„åŸå§‹è¾“å‡ºé€šå¸¸æ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼š</p>
<table>
<thead>
<tr>
<th><strong>åŸå§‹è¾“å‡ºç±»å‹</strong></th>
<th><strong>è§£é‡Š</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>BaseMessage</code></strong></td>
<td>å¯¹äº <strong>Chat æ¨¡å‹</strong> (<code>ChatOpenAI</code>, <code>ChatGroq</code> ç­‰)ï¼Œå®ƒä»¬çš„ <code>invoke()</code> æˆ– <code>stream()</code> æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª <code>BaseMessage</code> å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ <code>AIMessage</code> æˆ– <code>HumanMessage</code> çš„å­ç±»ï¼‰ã€‚</td>
</tr>
<tr>
<td><strong><code>Generation</code></strong></td>
<td>å¯¹äº <strong>Completion æ¨¡å‹</strong> (<code>OpenAI</code> ç­‰)ï¼Œå®ƒä»¬çš„ <code>invoke()</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <code>Generation</code> å¯¹è±¡çš„åˆ—è¡¨ï¼ˆåŒ…è£…åœ¨ <code>LLMResult</code> ä¸­ï¼‰ã€‚</td>
</tr>
<tr>
<td><strong><code>StrOutputParser</code> çš„å·¥ä½œå°±æ˜¯ä»è¿™äº›å¤æ‚çš„å¯¹è±¡ä¸­ï¼Œå®‰å…¨åœ°æå–å‡ºäººç±»å¯è¯»çš„å­—ç¬¦ä¸²å†…å®¹ã€‚</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>2. <code>StrOutputParser</code> çš„å·¥ä½œæœºåˆ¶</strong>
<code>StrOutputParser</code> åœ¨ LCEL ç®¡é“ä¸­å®ç°äº† <code>BaseOutputParser</code> æ¥å£ï¼Œå®ƒçš„æ ¸å¿ƒé€»è¾‘éå¸¸ç®€å•ï¼š</p>
<p><strong>A. å¤„ç† Chat æ¨¡å‹è¾“å‡º (<code>BaseMessage</code> å¯¹è±¡)</strong>
å½“å®ƒæ¥æ”¶åˆ° <code>AIMessage</code> æˆ–å…¶ä»– <code>BaseMessage</code> å¯¹è±¡æ—¶ï¼Œå®ƒä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„ <code>.content</code> å±æ€§ã€‚</p>
<ul>
<li><strong>è¾“å…¥ç¤ºä¾‹ï¼š</strong> <code>&lt;AIMessage content='ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIã€‚'&gt;</code></li>
<li><strong>è¾“å‡ºç»“æœï¼š</strong> <code>'ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIã€‚'</code></li>
</ul>
<p><strong>B. å¤„ç† Completion æ¨¡å‹è¾“å‡º (<code>LLMResult</code> / <code>Generation</code> å¯¹è±¡)</strong>
å¦‚æœå®ƒæ¥æ”¶åˆ°çš„æ˜¯ Completion æ¨¡å‹è¿”å›çš„ç»“æ„ï¼Œå®ƒä¼šæå–ç¬¬ä¸€ä¸ª <code>Generation</code> å¯¹è±¡çš„æ–‡æœ¬å†…å®¹ã€‚</p>
<p><strong>C. å¤„ç†æµå¼è¾“å‡º (Streaming)</strong>
åœ¨æµå¼ä¼ è¾“ä¸­ï¼Œ<code>StrOutputParser</code> ä¼šæŒç»­æ¥æ”¶åˆ°ç‰‡æ®µï¼ˆChunksï¼‰çš„ <code>BaseMessage</code> å¯¹è±¡æˆ–å­—ç¬¦ä¸²ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li><strong>æå–å†…å®¹ï¼š</strong> ä»æ¯ä¸ªä¼ å…¥çš„ Chunk ä¸­æå– <code>.content</code> å±æ€§ã€‚</li>
<li><strong>æ‹¼æ¥å†…å®¹ï¼š</strong> å°†è¿™äº›å†…å®¹ç‰‡æ®µ<strong>å®‰å…¨åœ°æ‹¼æ¥</strong>èµ·æ¥ï¼Œå½¢æˆæœ€ç»ˆçš„å®Œæ•´å­—ç¬¦ä¸²ã€‚è¿™ç¡®ä¿äº†å‰ç«¯æˆ–ç”¨æˆ·æ¥æ”¶åˆ°çš„æµæ˜¯è¿ç»­ä¸”æ­£ç¡®çš„æ–‡æœ¬ã€‚</li>
</ul>
<p><strong>3. å¦‚ä½•â€œè‡ªåŠ¨æ¸²æŸ“â€çš„è¯¯è§£</strong>
ç”¨æˆ·ä¹‹æ‰€ä»¥è§‰å¾—å®ƒæ˜¯â€œè‡ªåŠ¨æ¸²æŸ“â€çš„ï¼Œæ˜¯å› ä¸ºå®ƒå°†ä¸€ä¸ªä¸é€æ˜çš„ LangChain å†…éƒ¨å¯¹è±¡ï¼ˆå¦‚ <code>AIMessage</code>ï¼‰è½¬æ¢æˆäº†åº”ç”¨ç¨‹åºå‰ç«¯å¯ä»¥ç›´æ¥æ˜¾ç¤ºçš„ <strong>Python <code>str</code> ç±»å‹</strong>ã€‚
åœ¨ LCEL ç®¡é“ä¸­ï¼Œ<code>StrOutputParser</code> é€šå¸¸ä½äºç®¡é“çš„<strong>æœ«ç«¯</strong>ï¼Œå› ä¸ºå®ƒç¡®ä¿äº†ç®¡é“çš„è¾“å‡ºèƒ½å¤Ÿè¢«åç»­çš„ç³»ç»Ÿï¼ˆå¦‚ Flask API å“åº”ã€Streamlit ç•Œé¢æˆ–ç®€å•çš„ <code>print()</code> è¯­å¥ï¼‰è½»æ¾æ¶ˆè´¹ã€‚</p>
<p><strong>æ€»ç»“</strong>
<code>StrOutputParser</code> æ˜¯ LangChain ç®¡é“ä¸­ä¸€ä¸ª<strong>ç±»å‹è½¬æ¢</strong>ç»„ä»¶ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š</p>
<ol>
<li>ä» LLM è¿”å›çš„å¤æ‚å¯¹è±¡ï¼ˆå¦‚ <code>AIMessage</code>ï¼‰ä¸­<strong>æå–</strong>çº¯æ–‡æœ¬å†…å®¹ã€‚</li>
<li>ç¡®ä¿ Chain çš„è¾“å‡ºç±»å‹å§‹ç»ˆæ˜¯æ ‡å‡†çš„ <strong><code>str</code></strong>ï¼Œä»¥ä¾¿äºåç»­å¤„ç†å’Œå±•ç¤ºã€‚</li>
<li>åœ¨æµå¼ä¼ è¾“ä¸­ï¼Œè´Ÿè´£å°†æ¥æ”¶åˆ°çš„å†…å®¹<strong>ç‰‡æ®µå®‰å…¨æ‹¼æ¥</strong>ã€‚</li>
</ol>
<h4 id="é—®é¢˜é‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„">é—®é¢˜ï¼šé‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜é‚£ä¹ˆstreamlitçš„writeæ–¹æ³•æ˜¯å¦‚ä½•å°†markdownæ ¼å¼æ–‡æœ¬è‡ªåŠ¨æ¸²æŸ“ä¸ºæœ‰æ ¼å¼çš„htmlçš„">#</a></h4>
<p>ä»£ç  streamlit.elements.write.WriteMixin.write ä¸­æœ‰è®²è§£è¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº† Streamlit çš„æ ¸å¿ƒæœºåˆ¶å’Œå‰ç«¯äº¤äº’åŸç†ã€‚
<code>streamlit.write()</code> æ–¹æ³•è‡ªèº«ä¸ä¼šæ‰§è¡Œ Markdown æ¸²æŸ“ï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œä¸‡èƒ½â€å‘½ä»¤ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„æ•°æ®ç±»å‹è¿›è¡Œ<strong>åˆ†æ´¾ï¼ˆDispatchï¼‰</strong>ã€‚å½“å®ƒæ¥æ”¶åˆ°<strong>å­—ç¬¦ä¸²</strong>æ—¶ï¼Œå®ƒä¼šå°†æ¸²æŸ“å·¥ä½œå§”æ‰˜ç»™ä¸“é—¨çš„å‡½æ•°ã€‚
ä¸‹é¢æ˜¯ <code>st.write()</code> å¦‚ä½•å°† Markdown æ–‡æœ¬è‡ªåŠ¨è½¬æ¢ä¸º HTML æ ¼å¼åŒ–æ˜¾ç¤ºçš„è¯¦ç»†è¿‡ç¨‹ã€‚</p>
<p><strong>1. <code>st.write()</code> çš„åˆ†æ´¾æœºåˆ¶ (The Swiss Army Knife)</strong>
<code>st.write()</code> è¢«ç§°ä¸º Streamlit çš„â€œç‘å£«å†›åˆ€â€ï¼Œå®ƒä¼šæ£€æŸ¥ä¼ å…¥çš„å‚æ•°ç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th><strong>ä¼ å…¥å‚æ•°ç±»å‹</strong></th>
<th><strong>st.write() å®é™…è°ƒç”¨</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><code>str</code> (å­—ç¬¦ä¸²)</strong></td>
<td>å§”æ‰˜ç»™ <code>st.markdown()</code></td>
</tr>
<tr>
<td><code>pd.DataFrame</code></td>
<td>å§”æ‰˜ç»™ <code>st.dataframe()</code></td>
</tr>
<tr>
<td><code>dict</code> æˆ– <code>list</code></td>
<td>å§”æ‰˜ç»™ <code>st.json()</code></td>
</tr>
<tr>
<td><code>Altair/Plotly Chart</code></td>
<td>å§”æ‰˜ç»™ç›¸åº”çš„å›¾è¡¨å‡½æ•°</td>
</tr>
<tr>
<td><code>Exception</code></td>
<td>å§”æ‰˜ç»™ <code>st.exception()</code></td>
</tr>
<tr>
<td>å› æ­¤ï¼Œå½“ä½ ä¼ å…¥ä¸€ä¸ªåŒ…å« Markdown æ ¼å¼çš„å­—ç¬¦ä¸²æ—¶ï¼Œå®é™…æ‰§è¡Œæ¸²æŸ“çš„æ˜¯ <strong><code>st.markdown()</code></strong> å‡½æ•°ã€‚</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>2. <code>st.markdown()</code> çš„æ ¸å¿ƒæ¸²æŸ“è¿‡ç¨‹</strong>
<code>st.markdown()</code> æ˜¯ä¸“é—¨è´Ÿè´£å°† Markdown æ–‡æœ¬è½¬æ¢ä¸º HTML çš„å‡½æ•°ã€‚è¿™ä¸ªè½¬æ¢è¿‡ç¨‹åœ¨ Streamlit å†…éƒ¨æ˜¯è¿™æ ·è¿ä½œçš„ï¼š</p>
<p><strong>A. åç«¯ï¼ˆPythonï¼‰å¤„ç†ï¼šä½¿ç”¨ Markdown è§£æåº“</strong></p>
<ol>
<li><strong>è§£æå™¨ä½¿ç”¨ï¼š</strong> Streamlit çš„ Python åç«¯ä¸ä¼šè‡ªå·±ç¼–å†™ Markdown è½¬æ¢é€»è¾‘ã€‚å®ƒä¼šä¾èµ–ä¸€ä¸ªæˆ–å¤šä¸ªæˆç†Ÿçš„ã€é«˜æ€§èƒ½çš„ <strong>Python Markdown è§£æåº“</strong>ï¼ˆä¾‹å¦‚ï¼Œæ—©æœŸç‰ˆæœ¬å¯èƒ½ä¾èµ– <code>markdown-it-py</code> æˆ–ç±»ä¼¼çš„åº“ï¼‰ã€‚</li>
<li><strong>ç”Ÿæˆ HTML/æŠ½è±¡ç»“æ„ï¼š</strong> å½“ä½ è°ƒç”¨ <code>st.markdown(body)</code> æ—¶ï¼Œ<code>body</code> å­—ç¬¦ä¸²ä¼šè¢«è¿™ä¸ªå†…éƒ¨çš„ Markdown è§£æå™¨å¤„ç†ï¼Œå¹¶è½¬æ¢æˆå¯¹åº”çš„ <strong>HTML ç»“æ„</strong>ï¼ˆæˆ–ä¸€ä¸ªåŒ…å«æ¸²æŸ“æŒ‡ä»¤çš„ä¸­é—´æ•°æ®ç»“æ„ï¼‰ã€‚
<ul>
<li>ä¾‹å¦‚ï¼Œ<code>**bold**</code> è¢«è½¬æ¢ä¸º <code>&lt;strong&gt;bold&lt;/strong&gt;</code>ã€‚</li>
</ul>
</li>
<li><strong>åºåˆ—åŒ–ä¸ä¼ è¾“ï¼š</strong> Streamlit å°†è¿™ä¸ª HTML ç»“æ„æˆ–æ¸²æŸ“æŒ‡ä»¤<strong>åºåˆ—åŒ–</strong>ï¼ˆé€šå¸¸ä¸º JSON æ ¼å¼ï¼‰ã€‚</li>
<li><strong>WebSocket ä¼ è¾“ï¼š</strong> åºåˆ—åŒ–åçš„æ•°æ®é€šè¿‡ <strong>WebSocket</strong> è¿æ¥ï¼Œä» Python åç«¯å‘é€åˆ° Streamlit çš„å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ã€‚</li>
</ol>
<p><strong>B. å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰æ¸²æŸ“ï¼šReact + CSS</strong></p>
<ol>
<li><strong>å‰ç«¯æ¥æ”¶ï¼š</strong> Streamlit çš„å‰ç«¯ï¼ˆä½¿ç”¨ <strong>React</strong> æ¡†æ¶æ„å»ºï¼‰æ¥æ”¶åˆ°é€šè¿‡ WebSocket å‘é€è¿‡æ¥çš„æŒ‡ä»¤/æ•°æ®ã€‚</li>
<li><strong>DOM æ“ä½œï¼š</strong> React ç»„ä»¶æ ¹æ®æ”¶åˆ°çš„ HTML ç»“æ„æˆ–æŒ‡ä»¤ï¼Œå°†å…¶å®‰å…¨åœ°æ’å…¥åˆ° Web é¡µé¢çš„ <strong>DOM (Document Object Model)</strong> ä¸­ã€‚</li>
<li><strong>æµè§ˆå™¨æ¸²æŸ“ï¼š</strong> æµè§ˆå™¨è¯†åˆ«è¿™äº› HTML æ ‡ç­¾ï¼ˆå¦‚ <code>&lt;h1&gt;</code>, <code>&lt;p&gt;</code>, <code>&lt;strong&gt;</code>ï¼‰å¹¶åº”ç”¨é»˜è®¤æˆ– Streamlit è‡ªå®šä¹‰çš„ CSS æ ·å¼ã€‚
<ul>
<li><strong>æ ·å¼åº”ç”¨ï¼š</strong> Streamlit å…·æœ‰å†…ç½®çš„æ ·å¼è¡¨ï¼Œç¡®ä¿æ‰€æœ‰çš„ Markdown å…ƒç´ ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰éƒ½éµå¾ªåº”ç”¨çš„ä¸»é¢˜å’Œå¤–è§‚ï¼Œçœ‹èµ·æ¥ç¾è§‚ä¸”ä¸€è‡´ã€‚</li>
</ul>
</li>
</ol>
<p><strong>3. ä¸ºä»€ä¹ˆæ˜¯è‡ªåŠ¨çš„ï¼Ÿ</strong>
å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨ä¸”æ— æ„Ÿçš„ï¼Œå› ä¸ºï¼š</p>
<ol>
<li><strong>å°è£…ï¼š</strong> <code>st.write()</code> å’Œ <code>st.markdown()</code> å°è£…äº†ä» Markdown å­—ç¬¦ä¸²åˆ° HTML æ¸²æŸ“çš„æ‰€æœ‰æ­¥éª¤ã€‚</li>
<li><strong>å®æ—¶åŒæ­¥ï¼š</strong> Streamlit çš„æ¶æ„æœ¬èº«å°±æ˜¯ä¸ºäº†åœ¨ Python åç«¯ä»£ç ä¸æµè§ˆå™¨å‰ç«¯ä¹‹é—´æä¾›<strong>å®æ—¶åŒæ­¥</strong>ã€‚å½“ä½ è°ƒç”¨ä¸€ä¸ª Streamlit å‘½ä»¤æ—¶ï¼ŒPython æ¡†æ¶ä¼šç«‹å³å¤„ç†æ•°æ®å¹¶å‘Šè¯‰å‰ç«¯å¦‚ä½•æ›´æ–°ã€‚</li>
</ol>
<h4 id="é—®é¢˜pydantic-ä¸­-basemodel-çš„æ ¸å¿ƒä½œç”¨æ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ">é—®é¢˜ï¼šPydantic ä¸­ <code>BaseModel</code> çš„æ ¸å¿ƒä½œç”¨ï¼šæ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜pydantic-ä¸­-basemodel-çš„æ ¸å¿ƒä½œç”¨æ•°æ®æ¨¡å‹å’Œæ•°æ®æ ¡éªŒ">#</a></h4>
<p>åœ¨ Python çš„ <code>pydantic</code> åº“ä¸­ï¼Œ<code>BaseModel</code> æ˜¯<strong>æ„å»ºæ•°æ®æ¨¡å‹</strong>çš„åŸºçŸ³ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯<strong>å®šä¹‰æ•°æ®çš„ç»“æ„ã€ç±»å‹ï¼Œå¹¶è‡ªåŠ¨è¿›è¡ŒéªŒè¯</strong>ã€‚
ç®€å•æ¥è¯´ï¼Œ<code>BaseModel</code> å°†æ¾æ•£çš„ Python å­—å…¸æ•°æ®æå‡ä¸ºå…·æœ‰<strong>æ˜ç¡®ç»“æ„ã€ç±»å‹å’Œå†…ç½®éªŒè¯</strong>çš„å¼ºå¤§æ•°æ®å¯¹è±¡ã€‚</p>
<p><strong>ğŸš€ <code>BaseModel</code> çš„ä¸»è¦åŠŸèƒ½</strong></p>
<p><strong>1. å®šä¹‰æ¸…æ™°çš„æ•°æ®ç»“æ„ (Schema Definition)</strong>
<code>BaseModel</code> å…è®¸ä½ ä½¿ç”¨æ ‡å‡†çš„ Python ç±»å‹æ³¨è§£æ¥å®šä¹‰ä½ çš„æ•°æ®å¯¹è±¡åº”è¯¥é•¿ä»€ä¹ˆæ ·ï¼ŒåŒ…æ‹¬å“ªäº›å­—æ®µã€æ¯ä¸ªå­—æ®µçš„ç±»å‹ã€‚</p>
<ul>
<li><strong>ç¤ºä¾‹:</strong>
Python
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from pydantic import BaseModel
</span></span><span style="display:flex;"><span>from datetime import datetime
</span></span><span style="display:flex;"><span>class User(BaseModel):
</span></span><span style="display:flex;"><span>    id: int
</span></span><span style="display:flex;"><span>    name: str = &#34;John Doe&#34;  # å¸¦æœ‰é»˜è®¤å€¼
</span></span><span style="display:flex;"><span>    signup_ts: datetime | None = None # è”åˆç±»å‹
</span></span><span style="display:flex;"><span>    is_active: bool
</span></span></code></pre></div>è¿™ä¸ªç±»æ¸…æ¥šåœ°å®šä¹‰äº†ä¸€ä¸ªç”¨æˆ·å¯¹è±¡å¿…é¡»åŒ…å« <code>id</code>ï¼ˆæ•´æ•°ï¼‰ã€<code>name</code>ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€<code>signup_ts</code>ï¼ˆæ—¥æœŸæ—¶é—´æˆ– Noneï¼‰å’Œ <code>is_active</code>ï¼ˆå¸ƒå°”å€¼ï¼‰ã€‚</li>
</ul>
<p><strong>2. è‡ªåŠ¨æ•°æ®æ ¡éªŒ (Data Validation)</strong>
è¿™æ˜¯ <code>BaseModel</code> <strong>æœ€æ ¸å¿ƒ</strong>çš„åŠŸèƒ½ã€‚å½“ä½ å°è¯•åˆ›å»ºä¸€ä¸ª <code>BaseModel</code> å®ä¾‹æ—¶ï¼ŒPydantic ä¼šè‡ªåŠ¨æ£€æŸ¥ä¼ å…¥çš„æ•°æ®æ˜¯å¦ç¬¦åˆä½ å®šä¹‰çš„ç±»å‹å’Œç»“æ„ã€‚</p>
<ul>
<li><strong>å¦‚æœæ•°æ®ç±»å‹æ­£ç¡®ï¼š</strong> å®ƒä¼šå°†è¾“å…¥æ•°æ®ï¼ˆæ¯”å¦‚ JSON å­—ç¬¦ä¸²ã€å­—å…¸ï¼‰<strong>è½¬æ¢</strong>ä¸ºæ­£ç¡®çš„ Python ç±»å‹ï¼ˆä¾‹å¦‚å°† JSON å­—ç¬¦ä¸² &ldquo;1&rdquo; è½¬æ¢ä¸ºæ•´æ•° 1ï¼‰ã€‚</li>
<li><strong>å¦‚æœæ•°æ®æ ¡éªŒå¤±è´¥ï¼š</strong> å®ƒä¼šæŠ›å‡ºä¸€ä¸ªæ¸…æ™°çš„ <code>ValidationError</code>ï¼Œå‘Šè¯‰ä½ å“ªä¸ªå­—æ®µå‡ºäº†é—®é¢˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆã€‚è¿™æå¤§åœ°å‡å°‘äº†è¿è¡Œæ—¶é”™è¯¯å’Œè°ƒè¯•æ—¶é—´ã€‚</li>
</ul>
<p><strong>3. è‡ªåŠ¨æ•°æ®è½¬æ¢ (Data Coercion)</strong>
<code>BaseModel</code> ä¸ä»…è¿›è¡Œæ ¡éªŒï¼Œè¿˜å°è¯•è¿›è¡Œåˆç†çš„ç±»å‹è½¬æ¢ï¼š</p>
<ul>
<li><strong>å­—ç¬¦ä¸²åˆ°æ•°å­—ï¼š</strong> å­—ç¬¦ä¸² <code>&quot;123&quot;</code> ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºæ•´æ•° <code>123</code>ã€‚</li>
<li><strong>å­—ç¬¦ä¸²åˆ°æ—¥æœŸ/æ—¶é—´ï¼š</strong> éµå¾ª ISO æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸º <code>datetime</code> å¯¹è±¡ã€‚</li>
</ul>
<p><strong>4. å¼ºå¤§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</strong>
<code>BaseModel</code> å®ä¾‹å†…ç½®äº†å°†æ•°æ®å¯¹è±¡è½¬æ¢ä¸ºå…¶ä»–æ ¼å¼çš„æ–¹æ³•ï¼š</p>
<ul>
<li><strong>åºåˆ—åŒ– (Serialization):</strong>
<ul>
<li><code>user_instance.model_dump()</code>: å°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸ºæ ‡å‡†çš„ Python <strong>å­—å…¸ (dict)</strong>ã€‚</li>
<li><code>user_instance.model_dump_json()</code>: å°†æ¨¡å‹å®ä¾‹è½¬æ¢ä¸º <strong>JSON å­—ç¬¦ä¸²</strong>ï¼Œæ–¹ä¾¿ç½‘ç»œä¼ è¾“ã€‚</li>
</ul>
</li>
<li><strong>ååºåˆ—åŒ– (Deserialization):</strong>
<ul>
<li><code>User(**data_dict)</code>: ä»å­—å…¸åˆ›å»ºæ¨¡å‹å®ä¾‹ã€‚</li>
<li><code>User.model_validate(data_dict)</code>: ä»å­—å…¸æˆ– JSON æ•°æ®ä¸­éªŒè¯å¹¶åˆ›å»ºæ¨¡å‹å®ä¾‹ã€‚</li>
</ul>
</li>
</ul>
<p><strong>5. ä¸ FastAPI ç­‰æ¡†æ¶é›†æˆ</strong>
åœ¨ FastAPI ä¸­ï¼Œ<code>BaseModel</code> æ˜¯å®šä¹‰<strong>è¯·æ±‚ä½“ (Request Body)</strong> å’Œ <strong>å“åº”ä½“ (Response Body)</strong> çš„æ ‡å‡†æ–¹å¼ã€‚</p>
<ul>
<li>å½“ç”¨ä½œè¯·æ±‚ä½“æ—¶ï¼ŒFastAPI è‡ªåŠ¨ä½¿ç”¨ <code>BaseModel</code> æ¥æ ¡éªŒå®¢æˆ·ç«¯å‘é€çš„ JSON æ•°æ®ã€‚</li>
<li>å½“ç”¨ä½œå“åº”ä½“æ—¶ï¼ŒFastAPI è‡ªåŠ¨ä½¿ç”¨ <code>BaseModel</code> æ¥åºåˆ—åŒ–ä½ çš„ Python å¯¹è±¡ä¸º JSON å“åº”ã€‚
<strong>æ€»ç»“:</strong>
<code>BaseModel</code> çš„ä½œç”¨å°±æ˜¯å°† Python åº”ç”¨ç¨‹åºä¸­çš„æ•°æ®å¤„ç†ä»<strong>æ¾æ•£ã€æ˜“é”™çš„å­—å…¸æ“ä½œ</strong>ï¼Œå‡çº§ä¸º<strong>ç»“æ„åŒ–ã€ç±»å‹å®‰å…¨ä¸”è‡ªå¸¦éªŒè¯çš„å¼ºå¤§å¯¹è±¡æ¨¡å‹</strong>ã€‚</li>
</ul>
<h4 id="é—®é¢˜llama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ä¹Ÿå¯ä»¥ç”¨ollamaembeddingsæ¥åŠ è½½ä¹ˆ">é—®é¢˜ï¼šllama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ï¼Œä¹Ÿå¯ä»¥ç”¨OllamaEmbeddingsæ¥åŠ è½½ä¹ˆï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜llama2å¹¶éæ˜¯ä¸“å±çš„embeddingæ¨¡å‹ä¹Ÿå¯ä»¥ç”¨ollamaembeddingsæ¥åŠ è½½ä¹ˆ">#</a></h4>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸“ä¸šå’Œå…³é”®çš„é—®é¢˜ï¼Œå®ƒæ¶‰åŠåˆ°å¤§æ¨¡å‹çš„<strong>å¤šåŠŸèƒ½æ€§</strong>å’Œ <strong>Ollama å¹³å°çš„çµæ´»æ€§</strong>ã€‚
<strong>ç­”æ¡ˆæ˜¯ï¼šæ˜¯çš„ï¼Œæ‚¨å¯ä»¥å°† Llama 2 (æˆ– Llama 3 ç­‰èŠå¤©/ç”Ÿæˆæ¨¡å‹) ç”¨ä½œ <code>OllamaEmbeddings</code> çš„æ¨¡å‹ï¼Œä½†å®ƒå¹¶éæœ€ä½³å®è·µã€‚</strong>
ä»¥ä¸‹æ˜¯è¯¦ç»†çš„è§£é‡Šå’Œå»ºè®®ï¼š</p>
<p><strong>1. ä¸ºä»€ä¹ˆ Llama 2 å¯ä»¥ç”¨äºåµŒå…¥ï¼Ÿï¼ˆæŠ€æœ¯å¯è¡Œæ€§ï¼‰</strong>
Ollama å¹³å°æä¾›äº†ä¸€ä¸ªé€šç”¨çš„ <strong><code>/api/embeddings</code></strong> REST API ç«¯ç‚¹ã€‚
å½“æ‚¨åœ¨ <code>OllamaEmbeddings</code> ä¸­æŒ‡å®šä¸€ä¸ª<strong>éä¸“ç”¨</strong>çš„èŠå¤©æ¨¡å‹ï¼ˆå¦‚ <code>llama2</code>ï¼‰æ—¶ï¼ŒOllama å®ˆæŠ¤è¿›ç¨‹ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li><strong>æå–éšè—çŠ¶æ€ (Hidden State):</strong> Ollama ä¼šè¿è¡Œ Llama 2 æ¨¡å‹ï¼Œä½†ä¸æ‰§è¡Œæœ€ç»ˆçš„**è¯­è¨€æ¨¡å‹å¤´ï¼ˆLM Headï¼‰**å±‚ï¼ˆè¯¥å±‚è´Ÿè´£é¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒï¼‰ã€‚</li>
<li><strong>æ± åŒ– (Pooling):</strong> å®ƒä¼šä»æ¨¡å‹çš„å€’æ•°ç¬¬äºŒå±‚ï¼ˆæˆ–æ ¹æ®é…ç½®çš„ç‰¹å®šå±‚ï¼‰æå–<strong>è¯å…ƒéšè—çŠ¶æ€ï¼ˆToken Hidden Statesï¼‰</strong>ã€‚ç„¶åï¼Œå®ƒé€šå¸¸ä¼šåº”ç”¨ä¸€ä¸ª<strong>æ± åŒ–ç­–ç•¥</strong>ï¼ˆå¦‚å¹³å‡æ± åŒ–ï¼‰å°†è¿™äº›è¯å…ƒå‘é‡èšåˆä¸ºä¸€ä¸ªå•ä¸€çš„å¥å­å‘é‡ï¼Œä½œä¸ºæœ€ç»ˆçš„åµŒå…¥ï¼ˆEmbeddingï¼‰ã€‚
<strong>LangChain çš„ <code>OllamaEmbeddings</code> é€šè¿‡è°ƒç”¨è¿™ä¸ªé€šç”¨çš„ Ollama APIï¼Œå®ç°äº†å¯¹ Llama 2 çš„åµŒå…¥åŠŸèƒ½è°ƒç”¨ã€‚</strong></li>
</ul>
<p><strong>2. ä¸ºä»€ä¹ˆ Llama 2 ä¸æ¨èç”¨äºåµŒå…¥ï¼Ÿï¼ˆæ•ˆæœè€ƒé‡ï¼‰</strong>
å°½ç®¡æŠ€æœ¯ä¸Šå¯è¡Œï¼Œä½† Llama 2 æˆ–å…¶ä»–èŠå¤©æ¨¡å‹ï¼ˆå¦‚ Mistralï¼‰åœ¨æ²¡æœ‰ç»è¿‡ç‰¹å®šå¾®è°ƒçš„æƒ…å†µä¸‹ï¼Œä½œä¸ºåµŒå…¥æ¨¡å‹çš„æ•ˆæœé€šå¸¸è¿œä¸å¦‚ä¸“ç”¨åµŒå…¥æ¨¡å‹ã€‚</p>
<table>
<thead>
<tr>
<th><strong>åµŒå…¥æ¨¡å‹ç±»å‹</strong></th>
<th><strong>Llama 2 (ç”Ÿæˆæ¨¡å‹)</strong></th>
<th><strong>ä¸“ç”¨åµŒå…¥æ¨¡å‹ (å¦‚ Nomic Embed, mxbai-embed-large)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>è®­ç»ƒç›®æ ‡</strong></td>
<td><strong>ç”Ÿæˆæ–‡æœ¬</strong>ï¼ˆé¢„æµ‹ä¸‹ä¸€ä¸ªè¯å…ƒï¼‰ã€‚</td>
<td><strong>è¯­ä¹‰ç›¸ä¼¼æ€§</strong>ï¼ˆè®­ç»ƒç›®æ ‡æ˜¯è®©è¯­ä¹‰ç›¸è¿‘çš„å¥å­åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ï¼‰ã€‚</td>
</tr>
<tr>
<td><strong>æ•ˆæœ/ç²¾åº¦</strong></td>
<td><strong>è¾ƒå·®ã€‚</strong> å‘é‡ç©ºé—´æ²¡æœ‰é’ˆå¯¹ç›¸ä¼¼æ€§æœç´¢è¿›è¡Œä¼˜åŒ–ï¼Œæ£€ç´¢ç²¾åº¦ä½ã€‚</td>
<td><strong>ä¼˜ç§€ã€‚</strong> åœ¨ MTEB ç­‰åŸºå‡†æµ‹è¯•ä¸­è¡¨ç°ä¼˜å¼‚ï¼ŒRAG æ•ˆæœå¥½ã€‚</td>
</tr>
<tr>
<td><strong>èµ„æºæ¶ˆè€—</strong></td>
<td><strong>é«˜ã€‚</strong> Llama 2 å°ºå¯¸è¾ƒå¤§ï¼ˆå¦‚ 7Bï¼‰ï¼Œæ¨ç†æ…¢ï¼Œå†…å­˜å ç”¨é«˜ã€‚</td>
<td><strong>ä½ã€‚</strong> ä¸“ç”¨æ¨¡å‹é€šå¸¸æ›´å°ï¼ˆå¦‚ 300Mï¼‰ï¼Œé€Ÿåº¦å¿«ï¼Œèµ„æºæ¶ˆè€—ä½ã€‚</td>
</tr>
<tr>
<td><strong>ç®€è€Œè¨€ä¹‹ï¼š</strong> Llama 2 ç”Ÿæˆçš„å‘é‡å¯èƒ½æ— æ³•å‡†ç¡®æ•æ‰ä¸åŒå¥å­ä¹‹é—´çš„<strong>è¯­ä¹‰ç›¸ä¼¼æ€§</strong>ï¼Œè¿™ä¼šä¸¥é‡æŸå®³æ‚¨çš„ RAG æ£€ç´¢è´¨é‡ã€‚</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>3. æ¶æ„å¸ˆå»ºè®®</strong>
ä½œä¸ºä¸€åèµ„æ·±æ¶æ„å¸ˆï¼Œæˆ‘çš„å»ºè®®æ˜¯ï¼š</p>
<ol>
<li><strong>å¯¹äº RAG æˆ–è¯­ä¹‰æœç´¢ï¼š</strong> <strong>å§‹ç»ˆä¼˜å…ˆä½¿ç”¨ä¸“ç”¨çš„åµŒå…¥æ¨¡å‹ã€‚</strong> æ‚¨å·²ç»çœ‹åˆ°äº†ï¼ŒOllama æ”¯æŒè®¸å¤šé«˜æ€§èƒ½ã€å°å·§ä¸”ä¸“é—¨ä¸ºåµŒå…¥ä»»åŠ¡ä¼˜åŒ–çš„æ¨¡å‹ï¼ˆå¦‚ <code>mxbai-embed-large</code> æˆ– <code>embeddinggemma</code>ï¼‰ã€‚è¿™èƒ½æä¾›æ›´å¥½çš„ç²¾åº¦å’Œæ›´å¿«çš„é€Ÿåº¦ã€‚</li>
<li><strong>å®éªŒå’Œè‡ªå®šä¹‰ï¼š</strong> å¦‚æœæ‚¨åªæ˜¯è¿›è¡Œ<strong>å®éªŒ</strong>ï¼Œæˆ–è€…æ‚¨çš„ Llama 2 æ˜¯ç»è¿‡ä¸“é—¨çš„ <strong>å¯¹æ¯”å­¦ä¹ ï¼ˆContrastive Learningï¼‰å¾®è°ƒ</strong>ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œ<code>AnglE-LLaMA</code> ç­‰ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ Llama 2 æ˜¯æœ‰æ„ä¹‰çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ç¡®ä¿ä½ çš„ Llama 2 æ¨¡å‹æ–‡ä»¶åœ¨ Ollama ä¸­å·²ç»åŒ…å«äº†å¿…è¦çš„åµŒå…¥é…ç½®ã€‚
<strong>ç»“è®ºï¼šä½¿ç”¨ <code>OllamaEmbeddings(model=&quot;llama2&quot;)</code> æ˜¯å¯è¡Œçš„ï¼Œä½†ä¸ºäº†æ‚¨çš„åº”ç”¨æ€§èƒ½å’Œå‡†ç¡®æ€§ï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªä¸“ç”¨çš„ Ollama åµŒå…¥æ¨¡å‹ã€‚</strong></li>
</ol>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://chesterwang.github.io/chester-blog/posts/2025-11-14-llm%E8%AE%AD%E7%BB%83%E5%BE%AE%E8%B0%83%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>LLMè®­ç»ƒå¾®è°ƒå¼€å‘è®°å½•</span>
  </a>
  <a class="next" href="https://chesterwang.github.io/chester-blog/posts/2025-08-22-huggingface-%E7%B1%BB%E5%BA%93%E5%AD%A6%E4%B9%A0/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Huggingfaceåº“å­¦ä¹ ç¬”è®°</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://image.lvbibir.cn/js/1.6.40/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://twikoo.lvbibir.cn/", 
            el: "#tcomment",
            lang: 'zh-CN',
            
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<footer class="footer">

    <a href="https://gohugo.io/" target="_blank">
        
        <img style="display: unset;" src="https://image.lvbibir.cn/blog/frame-hugo-blue.svg">
    </a>
    <a href="https://github.com/adityatelange/hugo-PaperMod" target="_blank">
        
        <img style="display: unset;" src="https://image.lvbibir.cn/blog/theme-papermod-lightgrey.svg">
    </a>
    <a href="https://cn.aliyun.com/" target="_blank">
        
        <img style="display: unset;" src="https://image.lvbibir.cn/blog/å›¾åºŠ-é˜¿é‡Œäº‘-orange.svg">
    </a>

    <br>

    <span id="runtime_span"></span>
    <script
        type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("11/11/2025 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "ç½‘ç«™å·²è¿è¡Œ" + A + "å¤©" + B + "å°æ—¶" + C + "åˆ†" + D + "ç§’" } show_runtime();</script>
    |
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container">
        
        æ€»è®¿å®¢æ•°:  <span id="busuanzi_value_site_uv"></span>
        |
        æ€»è®¿é—®é‡:  <span id="busuanzi_value_site_pv"></span>
    </span>

    <br>

    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>


<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            
            
            
            
            
            
            
            
            
            
            
            
            
            

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild === container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName === "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

</body>

</html>
